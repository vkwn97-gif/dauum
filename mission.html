<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ë‹¤ì›€í•™êµ ì‹¤ì‹œê°„ í˜„í™©</title>
<style>
  :root {
    --bg: #f1f5f9; --card: #ffffff; --primary: #3b82f6;
    --success: #10b981; --text: #1e293b; --muted: #64748b;
    --easy: #3b82f6; --normal: #f59e0b; --hard: #ef4444;
  }
  body { margin: 0; background: var(--bg); color: var(--text); font-family: -apple-system, sans-serif; }

  /* ìƒë‹¨ í—¤ë” */
  .top {
    display: flex; justify-content: space-between; align-items: center;
    padding: 20px 30px; background: white; border-bottom: 2px solid #e2e8f0;
  }
  .title { font-size: 28px; font-weight: 900; color: var(--primary); }
  /* ëˆ„ì  í›„ì›ê¸ˆ ë¬¸êµ¬ ì‚­ì œì— ë”°ë¥¸ ìš°ì¸¡ ì •ë ¬ ìœ ì§€ìš© */
  .total-stats { text-align: right; font-weight: 700; font-size: 24px; color: var(--primary); }

  /* ì¹´ë“œ ë ˆì´ì•„ì›ƒ */
  .wrap { padding: 25px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
  @media (max-width: 1100px) { .wrap { grid-template-columns: 1fr; } }

  .card {
    background: var(--card); border-radius: 24px; padding: 25px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.05); position: relative;
    border: 1px solid #e2e8f0; transition: transform 0.3s;
  }
  .name { font-size: 36px; font-weight: 900; margin-bottom: 20px; color: #0f172a; }

  /* ë¯¸ì…˜ ì •ë³´ ë°•ìŠ¤ */
  .mission-box {
    background: #f8fafc; border-radius: 16px; padding: 18px; margin-bottom: 20px;
    border-left: 6px solid #e2e8f0;
  }
  .mission-box.active-box { border-left-color: var(--success); background: #f0fdf4; }
  
  .label { font-size: 13px; color: var(--muted); font-weight: 700; margin-bottom: 5px; }
  .m-name { font-size: 20px; font-weight: 800; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
  
  /* ì‹¤ì‹œê°„ íƒ€ì´ë¨¸ */
  .timer-val { font-size: 18px; color: var(--primary); font-weight: 900; margin-top: 5px; }

  /* ë‚œì´ë„ ë°°ì§€ */
  .diff-badge { font-size: 11px; padding: 2px 8px; border-radius: 6px; color: white; }
  .diff-EASY { background: var(--easy); }
  .diff-NORMAL { background: var(--normal); }
  .diff-HARD { background: var(--hard); }

  /* ê¸ˆì•¡ í†µê³„ ê·¸ë¦¬ë“œ */
  .money-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
  .money-item { border-left: 4px solid #e2e8f0; padding-left: 12px; }
  .money-val { font-size: 24px; font-weight: 900; color: #334155; }

  /* ê¸°ì—¬ë„ ë°” */
  .bar-wrap { height: 12px; background: #e2e8f0; border-radius: 10px; overflow: hidden; }
  .bar { height: 100%; background: var(--primary); width: 0%; transition: width 0.8s ease-in-out; }

  /* ìƒíƒœ ë°°ì§€ */
  .status {
    position: absolute; top: 25px; right: 25px;
    padding: 6px 14px; border-radius: 20px; font-size: 13px; font-weight: 800;
  }
  .active { background: #dcfce7; color: var(--success); border: 1px solid #bbf7d0; animation: pulse 2s infinite; }
  .waiting { background: #f1f5f9; color: var(--muted); border: 1px solid #e2e8f0; }

  /* í•˜ë‹¨ ê°¤ëŸ¬ë¦¬ ì˜ì—­ */
  .gallery-wrap { padding: 0 25px 25px; }
  .gallery-title { font-weight: 900; font-size: 18px; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
  .photo-stream { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 10px; }
  .photo-item { 
    flex: 0 0 140px; height: 140px; border-radius: 15px; overflow: hidden; 
    border: 2px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); position: relative;
  }
  .photo-item img { width: 100%; height: 100%; object-fit: cover; }
  .photo-name { 
    position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.6); 
    color: white; font-size: 10px; padding: 3px; text-align: center; 
  }

  @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
</style>
</head>
<body>

<div class="top">
  <div class="title">ë‹¤ì›€í•™êµ ì‹¤ì‹œê°„ í˜„í™©</div>
  <div class="total-stats" id="totalAll">0ì›</div>
</div>

<div class="wrap" id="cards"></div>

<div class="gallery-wrap">
  <div class="gallery-title">ğŸ“¸ ì˜¤ëŠ˜ì˜ ë¯¸ì…˜ ì¸ì¦ìƒ·</div>
  <div class="photo-stream" id="photoStream"></div>
</div>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxeLTBIEznrBrZHokDS-U5AyQiK1FHyobCpnbzjUNsCiVyl4FruNkP-ld1J2qNcUBDMdA/exec";
const ADMIN_TOKEN = "TEACHER_5678";
const REFRESH_MS = 10000; 

const REWARD_MAP = { EASY: 10000, NORMAL: 15000, HARD: 20000 };
let missionData = {};

window.onload = () => { 
  refresh(); 
  setInterval(refresh, REFRESH_MS); 
  setInterval(updateTimers, 1000); 
};

async function refresh() {
  try {
    const [mRes, lRes] = await Promise.all([
      fetch(`${WEB_APP_URL}?action=missions`).then(r => r.json()),
      fetch(`${WEB_APP_URL}?action=logs&token=${ADMIN_TOKEN}`).then(r => r.json())
    ]);

    mRes.missions.forEach(m => {
      missionData[m.mission_id] = { name: m.mission_name, diff: String(m.difficulty).toUpperCase() };
    });

    const students = {
      "S01": { name: "ê°•íƒœìœ¤", today: 0, total: 0, active: false, current: "ëŒ€ê¸° ì¤‘", curDiff: "", startTime: null },
      "S02": { name: "ê¹€ëŒ€ì¤‘", today: 0, total: 0, active: false, current: "ëŒ€ê¸° ì¤‘", curDiff: "", startTime: null },
      "S03": { name: "ìµœì›ì¤€", today: 0, total: 0, active: false, current: "ëŒ€ê¸° ì¤‘", curDiff: "", startTime: null }
    };

    const logs = lRes.logs || [];
    const today = new Date().toISOString().slice(0,10);
    const sessions = {};
    const todayPhotos = [];

    logs.forEach(l => {
      const sid = l.student_id;
      if (!students[sid]) return;

      const info = missionData[l.mission_id] || { name: l.mission_id, diff: "NORMAL" };
      
      // ìƒí™œë¯¸ì…˜ì€ ë¬´ì¡°ê±´ 30,000ì› ì ìš©
      let reward = info.name.includes("ìƒí™œ") ? 30000 : (REWARD_MAP[info.diff] || 0);

      const logDate = new Date(l.timestamp).toISOString().slice(0,10);

      if(!sessions[l.attempt_id]) {
        sessions[l.attempt_id] = { sid: sid, mid: l.mission_id, end: false, date: logDate, reward: reward, diff: info.diff, ts: l.timestamp };
      }
      if(l.value === 'end') sessions[l.attempt_id].end = true;

      if (logDate === today && l.note && l.note.includes("|photo:")) {
        const url = l.note.split("|photo:")[1].split("|")[0];
        todayPhotos.push({ url: url, name: students[sid].name });
      }
    });

    let totalGlobal = 0;
    Object.values(sessions).forEach(s => {
      if(s.end) {
        students[s.sid].total += s.reward;
        totalGlobal += s.reward;
        if(s.date === today) students[s.sid].today += s.reward;
      } else if (s.date === today) {
        students[s.sid].active = true;
        const info = missionData[s.mid] || { name: s.mid, diff: "NORMAL" };
        students[s.sid].current = info.name;
        students[s.sid].curDiff = info.diff;
        students[s.sid].startTime = s.ts;
      }
    });

    document.getElementById("totalAll").textContent = totalGlobal.toLocaleString() + "ì›";
    const maxVal = Math.max(1, ...Object.values(students).map(s => s.total));

    document.getElementById("cards").innerHTML = Object.keys(students).map(id => {
      const s = students[id];
      const barPct = Math.round((s.total / maxVal) * 100);
      return `
        <div class="card">
          <div class="status ${s.active ? 'active' : 'waiting'}">${s.active ? 'â— ìˆ˜í–‰ ì¤‘' : 'ëŒ€ê¸°'}</div>
          <div class="name">${s.name}</div>
          <div class="mission-box ${s.active ? 'active-box' : ''}">
            <div class="label">${s.active ? 'í˜„ì¬ ì§„í–‰ ë¯¸ì…˜' : 'ìµœê·¼ ì™„ë£Œ ë¯¸ì…˜'}</div>
            <div class="m-name">
              ${s.current}
              ${s.curDiff ? `<span class="diff-badge diff-${s.curDiff}">${s.curDiff}</span>` : ''}
            </div>
            ${s.active ? `<div class="timer-val" id="timer_${id}" data-start="${s.startTime}">0ë¶„ 0ì´ˆ ì§„í–‰ ì¤‘</div>` : ''}
          </div>
          <div class="money-grid">
            <div class="money-item"><div class="label">ì˜¤ëŠ˜ íšë“</div><div class="money-val">${s.today.toLocaleString()}ì›</div></div>
            <div class="money-item"><div class="label">ëˆ„ì  í•©ê³„</div><div class="money-val">${s.total.toLocaleString()}ì›</div></div>
          </div>
          <div class="bar-wrap"><div class="bar" style="width:${barPct}%"></div></div>
          <div style="font-size:12px; color:var(--muted); margin-top:10px; text-align:right; font-weight:700;">ê¸°ì—¬ë„: ${barPct}%</div>
        </div>
      `;
    }).join("");

    const stream = document.getElementById("photoStream");
    stream.innerHTML = todayPhotos.length ? "" : "<p style='font-size:12px; color:#888;'>ì˜¤ëŠ˜ ì˜¬ë¼ì˜¨ ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
    todayPhotos.reverse().forEach(p => {
      stream.innerHTML += `<div class="photo-item"><img src="${p.url}"><div class="photo-name">${p.name}</div></div>`;
    });

  } catch (err) { console.error("ê°±ì‹  ì˜¤ë¥˜:", err); }
}

function updateTimers() {
  document.querySelectorAll('[id^="timer_"]').forEach(el => {
    const start = new Date(el.dataset.start).getTime();
    const diff = Math.floor((Date.now() - start) / 1000);
    const min = Math.floor(diff / 60);
    const sec = diff % 60;
    el.textContent = `${min}ë¶„ ${sec}ì´ˆ ì§„í–‰ ì¤‘`;
  });
}
</script>
</body>
</html>