<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LDS ê´€ë¦¬ì</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root {
            --p: #4f46e5;
            --bg: #f1f5f9;
            --ok: #10b981;
            --fail: #ef4444;
            --cancel: #9ca3af;
        }

        body {
            font-family: 'Pretendard', sans-serif;
            background: var(--bg);
            padding: 20px;
            color: #333;
            margin: 0;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 24px;
            border-radius: 10px;
            background: #cbd5e1;
            cursor: pointer;
            font-weight: bold;
            color: #475569;
            transition: 0.2s;
        }

            .tab.active {
                background: var(--p);
                color: white;
                box-shadow: 0 4px 10px rgba(79, 70, 229, 0.3);
            }

        .view {
            display: none;
        }

            .view.active {
                display: block;
                animation: fadeIn 0.3s;
            }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        input, textarea, select {
            width: 100%;
            padding: 10px;
            margin: 5px 0 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
        }

        .btn {
            padding: 10px;
            width: 100%;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            color: white;
            cursor: pointer;
            margin-top: 5px;
        }

        .btn-download {
            margin-top: 15px;
            width: 100%;
            background: #1e293b;
            color: white;
            padding: 12px;
            border-radius: 8px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            font-size: 16px;
        }

        .mail-icon {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 24px;
            cursor: pointer;
            background: white;
            padding: 8px;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .daily-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }

        .student-col {
            background: white;
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }

        .col-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
        }

        .student-name {
            font-size: 18px;
            font-weight: bold;
            margin: 0;
        }

        .money-badge {
            background: #fff7ed;
            color: #d97706;
            padding: 5px 10px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
        }

        .qr-btn {
            font-size: 11px;
            background: #334155;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
        }

        .m-item {
            border: 1px solid #eee;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

            .m-item.done {
                border-left: 5px solid var(--ok);
                background: #f0fdf4;
            }

            .m-item.life-ok {
                border-left: 5px solid var(--ok);
                background: #dcfce7;
            }

            .m-item.ing {
                border-left: 5px solid orange;
                background: #fff7ed;
            }

            .m-item.fail {
                border-left: 5px solid var(--fail);
                background: #fef2f2;
                opacity: 0.8;
            }

            .m-item.cancel {
                border-left: 5px solid var(--cancel);
                background: #f3f4f6;
                color: #6b7280;
            }

            .m-item.gong {
                border-left: 5px solid #8b5cf6;
                background: #f3e8ff;
            }

        .cell-price {
            font-size: 11px;
            font-weight: 800;
            color: #059669;
        }

        .report-card, .report-page {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            position: relative;
        }

        .report-page {
            padding: 30px;
            margin-bottom: 30px;
            page-break-after: always;
        }

        .report-header {
            font-size: 20px;
            font-weight: 900;
            color: #1e293b;
            margin-bottom: 20px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 15px;
            display: flex;
            justify-content: space-between;
        }

        .page-title {
            font-size: 20px;
            font-weight: 800;
            color: var(--p);
            margin-bottom: 25px;
            display: block;
            border-left: 5px solid var(--p);
            padding-left: 15px;
        }

        .weekly-charts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .chart-box {
            background: #f8fafc;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .chart-title {
            font-size: 14px;
            font-weight: bold;
            color: #475569;
            margin-bottom: 10px;
        }

        .chart-wrapper {
            width: 120px;
            height: 120px;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .chart-value-text {
            font-size: 20px;
            font-weight: 900;
            color: #333;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
        }

        .chart-comment {
            font-size: 11px;
            color: #1e293b;
            margin-top: 10px;
            background: white;
            padding: 8px;
            border-radius: 8px;
            width: 100%;
            border: 1px solid #e2e8f0;
            font-weight: 600;
            line-height: 1.4;
            box-sizing: border-box;
            white-space: pre-wrap;
        }

        .weekly-table, .monthly-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 13px;
            background: white;
        }

            .weekly-table th, .monthly-table th {
                background: #1e293b;
                color: white;
                padding: 10px;
                border-bottom: 2px solid #e2e8f0;
            }

            .weekly-table td, .monthly-table td {
                border: 1px solid #e2e8f0;
                padding: 8px;
                text-align: center;
                vertical-align: top;
            }

        .w-card {
            background: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 6px;
            margin-bottom: 6px;
            text-align: left;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .w-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .w-name {
            font-weight: bold;
            font-size: 12px;
            color: #333;
        }

        .w-badge {
            font-size: 9px;
            font-weight: 800;
            padding: 2px 4px;
            border-radius: 4px;
            color: white;
            text-transform: uppercase;
        }

        .bg-easy {
            background: #10b981;
        }

        .bg-normal {
            background: #3b82f6;
        }

        .bg-hard {
            background: #ef4444;
        }

        .bg-gong {
            background: #8b5cf6;
        }

        .bg-none {
            background: #94a3b8;
        }

        .w-meta {
            font-size: 10px;
            color: #64748b;
            display: flex;
            justify-content: space-between;
        }

        .w-price {
            font-weight: bold;
            color: #059669;
        }

        .pay-statement {
            background: white;
            border: 2px solid #1e293b;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            position: relative;
            margin-top: 30px;
        }

        .pay-title {
            font-size: 24px;
            font-weight: bold;
            color: #1e293b;
            margin: 0;
        }

        .pay-big-total {
            font-size: 42px;
            font-weight: 900;
            color: var(--p);
            margin: 20px 0;
        }

        .pay-table-view, .salary-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

            .pay-table-view th, .salary-table th {
                background: #f8fafc;
                padding: 10px;
                text-align: left;
            }

            .salary-table th {
                text-align: center;
                background: #e2e8f0;
            }

            .pay-table-view td, .salary-table td {
                padding: 12px 10px;
                border-bottom: 1px solid #e2e8f0;
                font-weight: 600;
            }

                .pay-table-view td.money-col {
                    text-align: right;
                    font-family: monospace;
                    font-size: 16px;
                }

            .salary-table td {
                text-align: center;
            }

        .radar-container {
            width: 450px;
            height: 450px;
            margin: 0 auto;
            position: relative;
        }

        .score-box {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }

        .score-val {
            font-size: 18px;
            font-weight: 900;
            color: #333;
            margin-bottom: 5px;
        }

        #modal, #qrModal, #imgModal, #mailModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-box {
            background: white;
            padding: 25px;
            border-radius: 15px;
            width: 400px;
            max-height: 90vh;
            overflow-y: auto;
        }

        #imgModalContent {
            max-width: 90%;
            max-height: 80vh;
            object-fit: contain;
            background: black;
        }

        .mail-item {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 8px;
        }

        .chk-group label {
            display: block;
            margin-bottom: 8px;
            cursor: pointer;
            font-size: 14px;
        }
    </style>
</head>
<body>

    <div class="tabs">
        <div class="tab active" id="tab-daily" onclick="goTab('daily')">ğŸ“… ì¼ê°„ ê´€ë¦¬</div>
        <div class="tab" id="tab-weekly" onclick="goTab('weekly')">ğŸ“Š ì£¼ê°„ ë¦¬í¬íŠ¸</div>
        <div class="tab" id="tab-monthly" onclick="goTab('monthly')">ğŸ† ì›”ê°„ ë¦¬í¬íŠ¸</div>
        <div class="tab" id="tab-notice" onclick="goTab('notice')">ğŸ“¢ ê³µì§€ì‚¬í•­</div>
    </div>

    <div class="mail-icon" onclick="openMailModal()">ğŸ“©</div>

    <div id="daily" class="view active">
        <div style="margin-bottom: 15px;">
            <input type="date" id="dDate" style="width:auto; padding:8px;" onchange="loadDaily()">
            <button onclick="loadDaily()" style="background:var(--p); color:white; border:none; padding:8px 15px; border-radius:8px;">ìƒˆë¡œê³ ì¹¨</button>
        </div>
        <div class="daily-grid" id="dailyBoard"></div>
    </div>

    <div id="weekly" class="view">
        <div class="weekly-card" style="background:white; padding:20px; border-radius:20px;">
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <select id="wStudent" onchange="loadWeekly()" style="padding:10px; font-weight:bold;">
                    <option value="S01">ê°•íƒœìœ¤ ì£¼ì„</option>
                    <option value="S02">ê¹€ëŒ€ì¤‘ ì‚¬ì›</option>
                    <option value="S03">ìµœì›ì¤€ ëŒ€ë¦¬</option>
                    <option value="S04">ì´ë¡œìš´ ì¸í„´</option>
                    <option value="S05">ìµœíƒœë¯¼ ì¸í„´</option>
                </select>
                <select id="wWeekSelect" onchange="loadWeekly()" style="padding:10px; width:auto; border-radius:8px;"></select>
            </div>

            <div class="report-card" id="weeklyReportContainer" style="box-shadow:none; padding:0;">
                <div class="report-header">
                    <span id="wReportTitle">ì£¼ê°„ ì„±ê³¼ ë¦¬í¬íŠ¸</span>
                    <span style="font-size:14px; color:#666; font-weight:normal;" id="wDateRange">-</span>
                </div>
                <div class="weekly-charts">
                    <div class="chart-box"><div class="chart-title">â‘  ìê¸° ê´€ë¦¬</div><div class="chart-wrapper"><canvas id="wcSelf"></canvas><div class="chart-value-text" id="wsSelf">-</div></div><div class="chart-comment" id="wsSelfMsg">...</div></div>
                    <div class="chart-box"><div class="chart-title">â‘¡ ë„ì „ ì„±í–¥</div><div class="chart-wrapper"><canvas id="wcChal"></canvas><div class="chart-value-text" id="wsChal">-</div></div><div class="chart-comment" id="wsChalMsg">...</div></div>
                    <div class="chart-box"><div class="chart-title">â‘¢ ìƒì‚°ì„±</div><div class="chart-wrapper" style="width:100%;"><canvas id="wcProd" style="height:80px;"></canvas><div class="chart-value-text" id="wsProd" style="display:none;"></div></div><div class="chart-comment" id="wsProdMsg">...</div></div>
                    <div class="chart-box"><div class="chart-title">â‘£ ë§ˆê° ì¤€ìˆ˜</div><div class="chart-wrapper"><canvas id="wcComp"></canvas><div class="chart-value-text" id="wsComp">-</div></div><div class="chart-comment" id="wsCompMsg">...</div></div>
                </div>
                <div class="report-sub">ì£¼ê°„ ì—…ë¬´ ìˆ˜í–‰ ê¸°ë¡</div>
                <div style="overflow-x:auto;" id="weeklyBoard"></div>

                <div style="background:#f1f5f9; padding:15px; border-radius:10px; margin-top:10px; font-size:13px; color:#475569; text-align:right;"><span id="wSalaryDetail">...</span></div>

                <div class="pay-statement">
                    <div class="pay-logo">LIFE DESIGN STUDIO</div>
                    <h2 class="pay-title" id="payStatementTitle">OOO ê¸‰ì—¬ ëª…ì„¸ì„œ</h2>
                    <div class="pay-date-range" id="payDateRange">-</div>
                    <div class="pay-big-total" id="payStatementTotal">â‚©0</div>
                    <table class="pay-table-view"><thead><tr><th>í•­ëª© (ìš”ì¼)</th><th style="text-align:right;">ì§€ê¸‰ì•¡</th></tr></thead><tbody id="payTableBody"></tbody></table>
                </div>
            </div>
            <button class="btn-download" onclick="downloadWeeklyJPG()">ğŸ“¸ í†µí•© ë¦¬í¬íŠ¸ ì €ì¥ (JPG)</button>
        </div>
    </div>

    <div id="monthly" class="view">
        <div style="text-align: center; margin-bottom: 20px;">
            <select id="mStudent" onchange="loadMonthly()" style="padding:10px; font-weight:bold; width: auto; border-radius:8px;">
                <option value="S01">ê°•íƒœìœ¤ ì£¼ì„</option>
                <option value="S02">ê¹€ëŒ€ì¤‘ ì‚¬ì›</option>
                <option value="S03">ìµœì›ì¤€ ëŒ€ë¦¬</option>
                <option value="S04">ì´ë¡œìš´ ì¸í„´</option>
                <option value="S05">ìµœíƒœë¯¼ ì¸í„´</option>
            </select>
            <input type="month" id="mMonth" onchange="loadMonthly()" style="padding:10px; border-radius:8px; border:1px solid #ddd; width:auto;">
        </div>

        <div id="monthlyReportContainer" style="background:none;">
            <div id="report-page-1" class="report-page">
                <div class="report-header"><span id="mReportTitle1">ì›”ê°„ ë¦¬í¬íŠ¸ (ì—­ëŸ‰ ìƒì„¸)</span></div>
                <span class="page-title">PART 1. 5ëŒ€ í•µì‹¬ ì—­ëŸ‰ ìƒì„¸ ë¶„ì„</span>
                <div class="weekly-charts">
                    <div class="chart-box"><div class="chart-title">ìê¸° ê´€ë¦¬</div><div class="chart-wrapper"><canvas id="mcSelf"></canvas><div class="chart-value-text" id="msSelf">-</div></div><div class="chart-comment" id="msgSelf">...</div></div>
                    <div class="chart-box"><div class="chart-title">ë„ì „ ì„±í–¥</div><div class="chart-wrapper"><canvas id="mcChal"></canvas><div class="chart-value-text" id="msChal">-</div></div><div class="chart-comment" id="msgChal">...</div></div>
                    <div class="chart-box"><div class="chart-title">ì„±ì¥ ì§€í–¥</div><div class="chart-wrapper"><canvas id="mcGrow"></canvas><div class="chart-value-text" id="msGrow">-</div></div><div class="chart-comment" id="msgGrow">...</div></div>
                    <div class="chart-box"><div class="chart-title">ìƒì‚°ì„±</div><div class="chart-wrapper" style="width:100%;"><canvas id="mcProd" style="height:80px;"></canvas><div class="chart-value-text" id="msProd" style="display:none;"></div></div><div class="chart-comment" id="msgProd">...</div></div>
                    <div class="chart-box"><div class="chart-title">ë§ˆê° ì¤€ìˆ˜</div><div class="chart-wrapper"><canvas id="mcComp"></canvas><div class="chart-value-text" id="msComp">-</div></div><div class="chart-comment" id="msgComp">...</div></div>
                </div>
                <span class="page-title" style="margin-top:40px;">PART 2. ìƒì„¸ í™œë™ ë‚´ì—­ (ëˆ„ì )</span>
                <table class="monthly-table"><thead><tr><th>í™œë™ëª…</th><th>1ì£¼</th><th>2ì£¼</th><th>3ì£¼</th><th>4ì£¼</th><th>5ì£¼</th><th>í•©ê³„</th></tr></thead><tbody id="mDetailBody"></tbody></table>
            </div>

            <div id="report-page-2" class="report-page">
                <div class="report-header"><span>ì›”ê°„ ë¦¬í¬íŠ¸ (ì¢…í•© ë¶„ì„)</span></div>
                <span class="page-title">PART 3. ì—­ëŸ‰ ë°¸ëŸ°ìŠ¤</span>
                <div class="radar-container"><canvas id="monthlyRadarChart"></canvas></div>
                <span class="page-title" style="margin-top:40px;">PART 4. ì£¼ì°¨ë³„ ê¸‰ì—¬ ì¶”ì´ (ë‹¨ìœ„: ì›)</span>
                <table class="salary-table" id="salaryTable"><thead><tr><th>êµ¬ë¶„</th><th>1ì£¼ì°¨</th><th>2ì£¼ì°¨</th><th>3ì£¼ì°¨</th><th>4ì£¼ì°¨</th><th>5ì£¼ì°¨</th></tr></thead><tbody></tbody></table>
                <div style="margin-top:20px; border-top:2px solid #eee; padding-top:15px; text-align:right;">
                    <div style="font-size:16px; font-weight:bold; margin-bottom:5px;">ğŸ’° ì›”ê°„ ì´ ê¸‰ì—¬ í•©ê³„</div>
                    <div style="font-size:36px; font-weight:900; color:var(--p);" id="mTotalIncome">â‚©0</div>
                    <div style="font-size:12px; color:#666;">(ì „ì²´ í‰ê·  ëŒ€ë¹„ <span id="mProdText" style="font-weight:bold;">-</span>)</div>
                </div>
            </div>
        </div>
        <button class="btn-download" onclick="downloadMonthlyJPG()">ğŸ“¸ ì›”ê°„ ë¦¬í¬íŠ¸ ë‹¤ìš´ë¡œë“œ (JPG)</button>
    </div>

    <div id="notice" class="view">
        <div style="background:white; padding:20px; border-radius:20px; max-width:600px; margin:0 auto;">
            <h2 style="margin-top:0;">ğŸ“¢ ìƒˆë¡œìš´ ê³µì§€ì‚¬í•­ ë“±ë¡</h2>
            <textarea id="noticeInput" rows="4" placeholder="í•™ìƒë“¤ì—ê²Œ ì•Œë¦´ ë‚´ìš©ì„ ì ì–´ì£¼ì„¸ìš”." style="width:100%; border:1px solid #ddd; padding:10px; border-radius:8px; margin-bottom:10px;"></textarea>
            <button onclick="saveNotice()" class="btn" style="background:var(--p); color:white;">ê³µì§€ ë“±ë¡ ë° í•™ìƒ ì•±ì— ë„ìš°ê¸°</button>
            <h2 style="margin-top:40px; border-top:2px solid #f1f5f9; padding-top:20px;">ğŸ“‹ ê³µì§€ì‚¬í•­ ëª©ë¡ (ON/OFF)</h2>
            <div style="font-size:12px; color:#666; margin-bottom:15px;">ì¼œì ¸ ìˆëŠ”(ë…¹ìƒ‰) ê³µì§€ì‚¬í•­ë§Œ í•™ìƒ í™”ë©´ ìƒë‹¨ì— ì—¬ëŸ¬ ê°œ í‘œì‹œë©ë‹ˆë‹¤.</div>
            <div id="noticeListArea"></div>
        </div>
    </div>

    <div id="modal">
        <div class="modal-box">
            <h3 id="mTitle" style="color:var(--p);"></h3><input type="hidden" id="mSid"><input type="hidden" id="mMid">
            <div id="ui-life" style="display:none; text-align:left;">
                <div class="chk-group"><label><input type="checkbox" class="life-chk"> 1. ê°œì¸ ìœ„ìƒ</label><label><input type="checkbox" class="life-chk"> 2. ì¹¨êµ¬ ì •ë¦¬</label><label><input type="checkbox" class="life-chk"> 3. ë¹¨ë˜ ì •ë¦¬</label><label><input type="checkbox" class="life-chk"> 4. ì˜ë³µ ì •ë¦¬</label><label><input type="checkbox" class="life-chk"> 5. ì‹ ë°œ ì •ë¦¬</label><label><input type="checkbox" class="life-chk"> 6. ì“°ë ˆê¸° ì •ë¦¬</label><label><input type="checkbox" class="life-chk"> 7. ë¬¼ê±´ ì •ë¦¬</label><label><input type="checkbox" class="life-chk"> 8. ì•ˆì „ í™•ì¸</label><label><input type="checkbox" class="life-chk"> 9. ì¶œì„ì²´í¬</label><label><input type="checkbox" class="life-chk"> 10. ê°œì¸ êµ¬ì—­ ì²­ê²°</label></div>
                <textarea id="lifeMsg" placeholder="ì½”ë©˜íŠ¸"></textarea><input type="file" id="lifePhoto">
                <button class="btn" style="background:var(--ok);" onclick="handleLife('life_ok')">ìŠ¹ì¸</button><button class="btn" style="background:var(--fail);" onclick="handleLife('fail')">ì‹¤íŒ¨</button>
            </div>
            <div id="ui-appearance" style="display:none; text-align:center;">
                <div id="appPreviewArea" style="margin-bottom:15px; font-size:14px; color:#666;">ë“±ë¡ëœ ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                <input type="file" id="appPhotoFile" accept="image/*" style="margin-bottom:10px;">
                <button class="btn" style="background:var(--p);" onclick="uploadAppPhoto()">ğŸ“¸ ì‚¬ì§„ ë“±ë¡/ë³€ê²½</button>
            </div>
            <div id="ui-normal">
                <select id="ctrlMissionSelect">
                    <option value="">(ë¯¸ì…˜ëª… ë³€ê²½ ì‹œ ì„ íƒ)</option>
                    <optgroup label="ì•„ì´ë¸ŒëŸ¬ë¦¬ (ì˜¤ì „)"><option value="ê¸€ì“°ê¸°">ê¸€ì“°ê¸°</option><option value="ë…ì„œ">ë…ì„œ</option><option value="ìì„œì „">ìì„œì „</option></optgroup>
                    <optgroup label="ì„ íƒ ë¯¸ì…˜"><option value="ì»´í“¨í„°">ì»´í“¨í„°</option><option value="ìš´ë™">ìš´ë™</option><option value="ì˜ì–´íšŒí™”">ì˜ì–´íšŒí™”</option><option value="ê¸€ì”¨ì—°ìŠµ">ê¸€ì”¨ì—°ìŠµ</option></optgroup>
                    <optgroup label="ì˜¤í›„ í™œë™"><option value="ê²€ì •ê³ ì‹œ">ê²€ì •ê³ ì‹œ</option><option value="ìŒì•…">ìŒì•…</option><option value="SCLì±…ë ¥">SCLì±…ë ¥</option><option value="ì‹¬í™”ê³µë¶€">ì‹¬í™”ê³µë¶€</option><option value="êµë¥˜ìˆ˜ì—…">êµë¥˜ìˆ˜ì—…</option></optgroup>
                    <optgroup label="ê¸°íƒ€"><option value="í–‰ì‚¬">ğŸ‰ í–‰ì‚¬</option></optgroup>
                </select>
                <div id="diffSection"><select id="tComment"><option value="NORMAL">NORMAL</option><option value="EASY">EASY</option><option value="HARD">HARD</option></select></div>
                <div style="display:flex;gap:5px;margin-bottom:10px;"><input type="time" id="tStart">~<input type="time" id="tEnd"></div>
                <button class="btn" style="background:var(--ok);" onclick="sendCtrl('end')">ì™„ë£Œ/ìˆ˜ì •</button>
                <button class="btn" style="background:#94a3b8;margin-top:5px;" onclick="sendCtrl('delete')">ì‚­ì œ</button>
                <button class="btn" style="background:#8b5cf6;margin-top:5px;" onclick="sendCtrl('gong')">âœ… ê³µê²° ì²˜ë¦¬</button>
            </div>
            <div style="margin-top:15px; border-top:1px solid #eee; padding-top:10px;">
                <h4 style="margin:0 0 5px;">ğŸ’° ê¸ˆì•¡ ì¡°ì • (ìƒë²Œì )</h4>
                <input type="number" id="adjAmount" placeholder="ê¸ˆì•¡ (ì˜ˆ: 5000, -3000)">
                <input type="text" id="adjReason" placeholder="ì‚¬ìœ  (ì˜ˆ: ì²­ì†Œ ìš°ìˆ˜)">
                <button class="btn" style="background:#f59e0b; color:white;" onclick="sendAdjustment()">ì ìš©</button>
            </div>
            <button class="btn" style="background:#eee;color:#333;margin-top:10px;" onclick="document.getElementById('modal').style.display='none'">ë‹«ê¸°</button>
        </div>
    </div>

    <div id="mailModal"><div class="modal-box" style="width:500px;"><h3 style="margin-top:0;">ğŸ“© LDS ì‹ ë¬¸ê³ </h3><div id="mailList" style="max-height:60vh; overflow-y:auto; text-align:left;"></div><button onclick="document.getElementById('mailModal').style.display='none'" class="btn" style="background:#eee; color:#333;">ë‹«ê¸°</button></div></div>
    <div id="qrModal"><div id="qrCard"><h2>LDS EMPLOYEE</h2><div id="qrImage"></div><h3 id="qrName"></h3><button onclick="document.getElementById('qrModal').style.display='none'" class="btn" style="background:#eee;">ë‹«ê¸°</button></div></div>

    <script>
        // â–¼â–¼â–¼â–¼â–¼ ì„ ìƒë‹˜ì˜ ë°°í¬ URL ì…ë ¥ â–¼â–¼â–¼â–¼â–¼
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzUggqi6Wugy1SfMwak8eJYut0t2M2XGwvn15GcKNQlTNHIwE6B4EAOD5mos5pMAIp33Q/exec";
        // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

        // [â˜…ìˆ˜ì •] 5ì¸ ì²´ì œ ë°˜ì˜
        const students = {
            "S01": "ê°•íƒœìœ¤ ì£¼ì„",
            "S02": "ê¹€ëŒ€ì¤‘ ì‚¬ì›",
            "S03": "ìµœì›ì¤€ ëŒ€ë¦¬",
            "S04": "ì´ë¡œìš´ ì¸í„´",
            "S05": "ìµœíƒœë¯¼ ì¸í„´"
        };
        const NO_LEVEL_LIST = ["ìŒì•…", "ê²€ì •ê³ ì‹œ", "SCLì±…ë ¥", "ì‹¬í™”ê³µë¶€", "êµë¥˜ìˆ˜ì—…", "ì˜¤í›„í™œë™", "ë§ì¶¤í•™ìŠµ", "ì˜ˆë°°", "ì¶•êµ¬"];
        let weeklyCharts = {}; let monthlyCharts = {}; let radarChart = null;
        Chart.register(ChartDataLabels);

        document.addEventListener("DOMContentLoaded", () => {
            const offset = 1000 * 60 * 60 * 9;
            const today = new Date(new Date().getTime() + offset);
            const ymd = today.toISOString().slice(0, 10);
            const ym = today.toISOString().slice(0, 7);
            document.getElementById('dDate').value = ymd;
            document.getElementById('mMonth').value = ym;
            initWeekSelector();
            loadDaily();
            loadWeekly();
            loadMonthly();
        });

        function goTab(id) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            if (id === 'daily') document.getElementById('tab-daily').classList.add('active');
            if (id === 'weekly') { document.getElementById('tab-weekly').classList.add('active'); loadWeekly(); }
            if (id === 'monthly') { document.getElementById('tab-monthly').classList.add('active'); loadMonthly(); }
            if (id === 'notice') { document.getElementById('tab-notice').classList.add('active'); loadNotices(); }
        }

        function loadNotices() {
            document.getElementById('noticeListArea').innerHTML = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
            fetch(WEB_APP_URL, { method: "POST", body: JSON.stringify({ action: "getAllNotices" }) }).then(r => r.json()).then(res => {
                let html = "";
                res.data.forEach(n => {
                    let isON = (n.status === 'ACTIVE');
                    let bg = isON ? '#ecfdf5' : '#f8fafc';
                    let border = isON ? '#10b981' : '#e2e8f0';
                    html += `
                <div style="background:${bg}; border:2px solid ${border}; padding:15px; border-radius:12px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
                    <div style="flex:1; text-align:left;">
                        <div style="font-size:11px; color:#64748b;">${new Date(n.date).toLocaleDateString()} ${isON ? '<b style="color:#10b981;">[ê²Œì‹œ ì¤‘]</b>' : ''}</div>
                        <div style="font-size:15px; font-weight:bold; margin-top:5px; color:#1e293b; white-space:pre-wrap;">${n.content}</div>
                    </div>
                    <div style="display:flex; gap:5px; flex-direction:column;">
                        ${isON ?
                            `<button onclick="toggleNotice('${n.id}', 'INACTIVE')" style="background:#ef4444; color:white; border:none; padding:8px; border-radius:8px; cursor:pointer; font-weight:bold;">ìˆ¨ê¸°ê¸°</button>` :
                            `<button onclick="toggleNotice('${n.id}', 'ACTIVE')" style="background:#10b981; color:white; border:none; padding:8px; border-radius:8px; cursor:pointer; font-weight:bold;">ë‹¤ì‹œ ë„ìš°ê¸°</button>`
                        }
                        <button onclick="deleteNotice('${n.id}')" style="background:#cbd5e1; color:#475569; border:none; padding:5px; border-radius:8px; cursor:pointer; font-size:12px;">ì˜êµ¬ ì‚­ì œ</button>
                    </div>
                </div>`;
                });
                document.getElementById('noticeListArea').innerHTML = html || "<div style='text-align:center; color:#888; padding:20px;'>ë“±ë¡ëœ ê³µì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>";
            });
        }

        function saveNotice() {
            const txt = document.getElementById('noticeInput').value;
            if (!txt) return alert("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");
            fetch(WEB_APP_URL, { method: "POST", body: JSON.stringify({ action: "saveNotice", content: txt }) }).then(() => {
                alert("ê³µì§€ê°€ ë“±ë¡ë˜ê³  í•™ìƒ ì•±ì— ë„ì›Œì¡ŒìŠµë‹ˆë‹¤.");
                document.getElementById('noticeInput').value = "";
                loadNotices();
            });
        }

        function toggleNotice(id, status) { fetch(WEB_APP_URL, { method: "POST", body: JSON.stringify({ action: "toggleNotice", id: id, status: status }) }).then(() => loadNotices()); }
        function deleteNotice(id) { if (confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { fetch(WEB_APP_URL, { method: "POST", body: JSON.stringify({ action: "deleteNotice", id: id }) }).then(() => loadNotices()); } }

        function openMailModal() { document.getElementById('mailModal').style.display = 'flex'; document.getElementById('mailList').innerHTML = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘..."; fetch(WEB_APP_URL, { method: "POST", body: JSON.stringify({ action: "getSinmungoList" }) }).then(r => r.json()).then(res => { let h = ""; if (!res.data || res.data.length === 0) h = "<div style='text-align:center;padding:20px;'>ì‹ ë¬¸ê³ ê°€ ì—†ìŠµë‹ˆë‹¤.</div>"; else res.data.forEach(m => { const d = new Date(m.date); h += `<div class="mail-item"><div class="mail-date">${d.toLocaleDateString()}</div><div class="mail-title">${m.nick}</div><div class="mail-content">${m.content}</div></div>`; }); document.getElementById('mailList').innerHTML = h; }); }

        function loadDaily() {
            const date = document.getElementById('dDate').value;
            fetch(WEB_APP_URL, { method: "POST", body: JSON.stringify({ action: "getDailyData", date: date }) }).then(res => res.json()).then(data => {
                const board = document.getElementById('dailyBoard'); board.innerHTML = "";
                if (!data.logs) data.logs = {};

                Object.keys(students).forEach(sid => {
                    const col = document.createElement('div'); col.className = 'student-col';
                    const l = data.logs[sid] || {}; const s = (data.schedules && data.schedules[sid]) ? data.schedules[sid] : null;
                    let currentTotal = 0; Object.keys(l).forEach(k => { if (k === 'adjustments') { l[k].forEach(a => currentTotal += a.amount); } else if (l[k].money) currentTotal += l[k].money; });
                    col.innerHTML = `<div class="col-header"><h3 class="student-name">${students[sid]}</h3><span class="money-badge">â‚©${currentTotal.toLocaleString()}</span><button class="qr-btn" onclick="openQrModal('${sid}','${students[sid]}')">ğŸªª QR</button></div>`;

                    let lifeCls = "", lifeTxt = "ë¯¸ì™„ë£Œ"; if (l["ìƒí™œë¯¸ì…˜"]) { if (l["ìƒí™œë¯¸ì…˜"].status === 'life_ok') { lifeCls = 'life-ok'; lifeTxt = 'ì„±ê³µ'; } else if (l["ìƒí™œë¯¸ì…˜"].status === 'fail') { lifeCls = 'fail'; lifeTxt = 'ì‹¤íŒ¨'; } }
                    col.innerHTML += `<div class="m-item ${lifeCls}" onclick="openModal('${sid}','ìƒí™œë¯¸ì…˜')"><b>ğŸŒ ìƒí™œë¯¸ì…˜</b> <span>${lifeTxt}</span></div>`;

                    let appLog = l["ìš©ëª¨ì²´í¬"]; let appSt = appLog ? "âœ… í™•ì¸ë¨" : "ë¯¸í™•ì¸"; let appCls = appLog ? "done" : "";
                    col.innerHTML += `<div class="m-item ${appCls}" onclick="openModal('${sid}','ìš©ëª¨ì²´í¬', '${appLog ? appLog.note : ''}')"><b>ğŸ‘” ìš©ëª¨ë‹¨ì •</b> <span>${appSt}</span></div>`;

                    if (s) {
                        // [â˜…ìˆ˜ì •] c3ê¹Œì§€ í¬í•¨í•´ì„œ ë Œë”ë§
                        ['m1', 'm2', 'm3', 'c1a', 'c1b', 'c2', 'c3'].forEach(k => {
                            if (!s[k] || !s[k].n) return; let mName = s[k].n;

                            let displayName = mName; let logKey = mName;
                            if (mName === 'í–‰ì‚¬') { if (k.startsWith('c1')) logKey = 'í–‰ì‚¬_ì„ íƒ'; else if (k === 'c2') logKey = (s.day === 'ëª©') ? 'í–‰ì‚¬_ëª©ì˜¤í›„' : 'í–‰ì‚¬_ì˜¤í›„'; else logKey = 'í–‰ì‚¬_ì˜¤ì „'; displayName = `ğŸ‰ ${mName}`; }
                            let log = l[logKey] || l[mName]; let c = ""; let priceHtml = ""; let timeStr = ""; let badge = "";
                            if (log) {
                                if (log.status == 'end' || log.status == 'ok') c = 'done'; else if (log.status == 'start') c = 'ing'; else if (log.status == 'gong') c = 'gong';
                                if (log.money) priceHtml = ` <span class="cell-price">â‚©${log.money.toLocaleString()}</span>`;
                                if (log.note && log.note.includes("ë¶„")) timeStr = ` <div style="font-size:10px;color:#888;margin-top:2px;">â± ${log.note}</div>`;
                                if (log.message) {
                                    let msgStr = String(log.message); let d = msgStr.charAt(0).toUpperCase();
                                    if (['E', 'N', 'H'].includes(d) && !NO_LEVEL_LIST.includes(mName)) badge = ` <span style="font-size:10px;font-weight:bold;color:#666;">(${d})</span>`;
                                }
                            }
                            col.innerHTML += `<div class="m-item ${c}" onclick="openModal('${sid}','${mName}')"><div>${displayName}${badge} ${priceHtml}</div>${timeStr}</div>`;
                        });
                    }
                    board.appendChild(col);
                });
            });
        }

        function loadWeekly() {
            const sid = document.getElementById('wStudent').value; const date = document.getElementById('wWeekSelect').value; if (!date) return;
            fetch(WEB_APP_URL, { method: "POST", body: JSON.stringify({ action: "getWeeklyData", sid: sid, date: date }) }).then(r => r.json()).then(res => {
                if (!res.ok) { alert("ë°ì´í„° ë¡œë”© ì‹¤íŒ¨: " + res.error); return; }
                const s = res.scores || { self: 0, challenge: 0, productivity: 0, completion: 0, detail: {} }; const d = s.detail || { life: "-", chal: "-", prod: "-", comp: "-" };
                const optText = document.getElementById('wWeekSelect').selectedOptions[0].text; const titlePart = optText.split('(')[0].trim();
                document.getElementById('wReportTitle').innerText = `${students[sid]}ì˜ ${titlePart} ë¦¬í¬íŠ¸`;
                drawCharts('w', s);
                document.getElementById('wsSelfMsg').innerText = d.life; document.getElementById('wsChalMsg').innerText = d.chal; document.getElementById('wsProdMsg').innerText = d.prod; document.getElementById('wsCompMsg').innerText = d.comp;
                const totalIncome = res.total || 0; const bd = res.breakdown || { missionCount: 0, missionMoney: 0, lifeCount: 0, lifeMoney: 0, adjMoney: 0 };
                let detailText = `ì„±ê³µ ${bd.missionCount}ê±´(${bd.missionMoney.toLocaleString()}) + ìƒí™œ ${bd.lifeCount}ê±´(${bd.lifeMoney.toLocaleString()})`;
                if (bd.adjMoney !== 0) detailText += ` + ì¡°ì •(${bd.adjMoney.toLocaleString()})`; detailText += ` = ì´ â‚©${totalIncome.toLocaleString()}`;
                document.getElementById('wSalaryDetail').innerText = detailText;
                document.getElementById('payStatementTitle').innerText = `${students[sid]}ë‹˜ ${titlePart} ê¸‰ì—¬ ëª…ì„¸ì„œ`; document.getElementById('payStatementTotal').innerText = "â‚©" + totalIncome.toLocaleString();
                let h = `<table class="weekly-table"><thead><tr><th>ì‹œê°„</th>`;["ì›”", "í™”", "ìˆ˜", "ëª©", "ê¸ˆ"].forEach(d => h += `<th>${d}</th>`); h += `</tr></thead><tbody>`;
                const slots = [{ t: "09:00", k: "life" }, { t: "09:30", k: "am" }, { t: "11:00", k: "sel1" }, { t: "13:00", k: "pm" }];
                slots.forEach(slot => {
                    h += `<tr><td>${slot.t}</td>`;
                    for (let i = 0; i < 5; i++) {
                        const d = res.days[i].data; const sched = d.schedules[sid]; const l = d.logs[sid] || {}; let content = "";
                        if (slot.k === 'life') { content = "ìƒí™œë¯¸ì…˜"; if (l["ìƒí™œë¯¸ì…˜"]) { if (l["ìƒí™œë¯¸ì…˜"].status === 'life_ok') content += "<br>âœ…"; if (l["ìƒí™œë¯¸ì…˜"].money) content += `<br>â‚©${l["ìƒí™œë¯¸ì…˜"].money.toLocaleString()}`; } }
                        else if (sched) {
                            let keys = slot.k === 'am' ? ['m1', 'm2', 'm3'] : (slot.k === 'sel1' ? ['c1a', 'c1b'] : ['c2', 'c3']); let items = [];
                            keys.forEach(k => {
                                if (sched[k] && sched[k].n) {
                                    let mName = sched[k].n; let logKey = mName; if (mName === 'í–‰ì‚¬') { if (keys.includes('m1')) logKey = 'í–‰ì‚¬_ì˜¤ì „'; else if (keys.includes('c1a')) logKey = 'í–‰ì‚¬_ì„ íƒ'; else logKey = 'í–‰ì‚¬_ì˜¤í›„'; }
                                    let log = l[logKey] || l[mName]; let badge = "";
                                    if (log) {
                                        if (log.status === 'gong') badge = `<span class="w-badge bg-gong">ê³µê²°</span>`;
                                        else if (log.message) {
                                            let diff = String(log.message).toUpperCase(); let bgClass = diff === 'HARD' ? 'bg-hard' : (diff === 'EASY' ? 'bg-easy' : 'bg-normal');
                                            if (!NO_LEVEL_LIST.includes(mName)) badge = `<span class="w-badge ${bgClass}">${diff.charAt(0)}</span>`;
                                        }
                                    } else { badge = `<span class="w-badge bg-none">-</span>`; }
                                    let timeStr = ""; if (log && log.note && log.note.includes("ë¶„")) { if (log.note.includes("ì†Œìš”")) timeStr = `<span style="font-size:9px;color:#666;">${log.note}</span>`; }
                                    items.push(`<div class="w-card"><div class="w-card-header"><span class="w-name">${mName}</span>${badge}</div><div class="w-meta">${timeStr}${log && log.money ? `<span class="w-price">â‚©${log.money.toLocaleString()}</span>` : ''}</div></div>`);
                                }
                            });
                            content = items.join("");
                        }
                        h += `<td>${content}</td>`;
                    } h += `</tr>`;
                });
                h += `<tr><td style="font-weight:bold;">í•©ê³„</td>`; for (let i = 0; i < 5; i++)h += `<td style="font-weight:bold; color:var(--p);">â‚©${res.days[i].money.toLocaleString()}</td>`; h += `</tr></tbody></table>`;
                document.getElementById('weeklyBoard').innerHTML = h;
                const tbody = document.getElementById('payTableBody'); tbody.innerHTML = ""; const dayNames = ["ì›”ìš”ì¼", "í™”ìš”ì¼", "ìˆ˜ìš”ì¼", "ëª©ìš”ì¼", "ê¸ˆìš”ì¼"]; for (let i = 0; i < 5; i++) { const tr = document.createElement('tr'); tr.innerHTML = `<td>${dayNames[i]}</td><td class="money-col">â‚©${res.days[i].money.toLocaleString()}</td>`; tbody.appendChild(tr); }
            });
        }

        function loadMonthly() { const sid = document.getElementById('mStudent').value; const month = document.getElementById('mMonth').value; if (!month) return; const mParts = month.split('-'); document.getElementById('mReportTitle1').innerText = `${students[sid]}ì˜ ${parseInt(mParts[1])}ì›” ë¦¬í¬íŠ¸ (ì—­ëŸ‰ ìƒì„¸)`; fetch(WEB_APP_URL, { method: "POST", body: JSON.stringify({ action: "getMonthlyData", sid, month }) }).then(r => r.json()).then(res => { const s = res.myScores || { self: 0, challenge: 0, growth: 0, productivity: 0, completion: 0 }; const c = res.counts || {}; drawCharts('m', s); document.getElementById('msgSelf').innerText = `ì´ ${c.life.total}íšŒ ì¤‘ ${c.life.success}íšŒ ì„±ê³µ (${s.self}%)`; document.getElementById('msgChal').innerText = `í‰ê·  ë‚œì´ë„ ${s.challenge}ì  (E:${c.chal.easy} / N:${c.chal.normal} / H:${c.chal.hard})`; document.getElementById('msgGrow').innerText = `í‰ê·  ì´ìƒ ë‚œì´ë„ ì„ íƒ: ${c.grow.high}íšŒ (${s.growth}%)`; document.getElementById('msgProd').innerText = s.productivity >= 0 ? `í‰ê·  ëŒ€ë¹„ +${s.productivity}% ë‹¬ì„±` : `í‰ê·  ëŒ€ë¹„ ${s.productivity}% (ì €ì¡°)`; document.getElementById('msgComp').innerText = `ì‹œê°„ ë‚´ ì™„ë£Œ ${c.comp.success}ê±´ / ì „ì²´ ${c.comp.total}ê±´ (${s.completion}%)`; const tSalary = document.getElementById('salaryTable').querySelector('tbody'); tSalary.innerHTML = ""; let salRow = `<td>ê¸‰ì—¬</td>`; for (let w = 1; w <= 5; w++) { let inc = (res.weeklyStats && res.weeklyStats[w]) ? res.weeklyStats[w].income : 0; salRow += `<td>â‚©${inc.toLocaleString()}</td>`; } tSalary.innerHTML = `<tr>${salRow}</tr>`; document.getElementById('mTotalIncome').innerText = "â‚©" + (res.financials.myTotal || 0).toLocaleString(); let diff = (res.financials.myTotal || 0) - (res.financials.allTotalAvg || 0); document.getElementById('mProdText').innerText = (diff >= 0 ? "+" : "") + "â‚©" + diff.toLocaleString(); drawRadar(s); const tbody = document.getElementById('mDetailBody'); tbody.innerHTML = "";["ìƒí™œë¯¸ì…˜", "ë…ì„œ", "ê¸€ì“°ê¸°", "ìì„œì „", "ìš´ë™", "ì˜ì–´íšŒí™”", "ê²€ì •ê³ ì‹œ", "í–‰ì‚¬", "íŠ¹ë³„í™œë™"].forEach(m => { let row = `<td>${m}</td>`; let sum = 0; for (let w = 1; w <= 5; w++) { const d = res.weeklyDetails[w][m] || { count: 0, money: 0 }; row += `<td>${d.count}íšŒ</td>`; sum += d.money; } row += `<td style="font-weight:bold;">â‚©${sum.toLocaleString()}</td>`; tbody.innerHTML += `<tr>${row}</tr>`; }); }); }
        function drawCharts(pf, s) { const drawDoughnut = (id, val, color) => { const ctx = document.getElementById(id).getContext('2d'); if (weeklyCharts[id]) weeklyCharts[id].destroy(); weeklyCharts[id] = new Chart(ctx, { type: 'doughnut', data: { datasets: [{ data: [Math.max(1, val), 100 - val], backgroundColor: [val > 0 ? color : '#e2e8f0', '#e2e8f0'] }] }, options: { cutout: '70%', plugins: { legend: false, datalabels: false } } }); }; drawDoughnut(pf + 'cSelf', Math.max(1, s.self), '#10b981'); document.getElementById(pf + 'sSelf').innerText = s.self + "%"; const chalPercent = Math.min(100, Math.max(1, (s.challenge - 1) * 50)); drawDoughnut(pf + 'cChal', chalPercent, '#f59e0b'); document.getElementById(pf + 'sChal').innerText = s.challenge; const ctxProd = document.getElementById(pf + 'cProd').getContext('2d'); if (weeklyCharts[pf + 'prod']) weeklyCharts[pf + 'prod'].destroy(); weeklyCharts[pf + 'prod'] = new Chart(ctxProd, { type: 'bar', data: { labels: [''], datasets: [{ label: 'í‰ê·  ëŒ€ë¹„', data: [s.productivity], backgroundColor: s.productivity >= 0 ? '#4f46e5' : '#ef4444', barThickness: 20 }] }, options: { indexAxis: 'y', scales: { x: { min: -50, max: 50, grid: { display: true } }, y: { display: false } }, plugins: { legend: false, datalabels: false } } }); if (document.getElementById(pf + 'sProd')) document.getElementById(pf + 'sProd').innerText = (s.productivity > 0 ? "+" : "") + s.productivity + "%"; drawDoughnut(pf + 'cComp', Math.max(1, s.completion), '#ef4444'); document.getElementById(pf + 'sComp').innerText = s.completion + "%"; if (pf === 'm') { drawDoughnut('mcGrow', Math.max(1, s.growth), '#8b5cf6'); document.getElementById('msGrow').innerText = s.growth + "%"; } }
        function drawRadar(s, g) { const ctxRadar = document.getElementById('monthlyRadarChart').getContext('2d'); if (radarChart) radarChart.destroy(); const normChal = Math.max(0, Math.min(100, (s.challenge - 1) * 50)); const normProd = Math.max(0, Math.min(100, (s.productivity / 2) + 50)); radarChart = new Chart(ctxRadar, { type: 'radar', data: { labels: ['ìê¸°ê´€ë¦¬', 'ë„ì „ì„±í–¥', 'ì„±ì¥ì§€í–¥', 'ìƒì‚°ì„±', 'ë§ˆê°ì¤€ìˆ˜'], datasets: [{ label: 'ë‚˜ì˜ ì—­ëŸ‰', data: [s.self, normChal, s.growth, normProd, s.completion], backgroundColor: 'rgba(79, 70, 229, 0.2)', borderColor: '#4f46e5', borderWidth: 2, pointBackgroundColor: '#4f46e5' }] }, options: { scales: { r: { min: 0, max: 100, ticks: { display: false } } } } }); }

        function uploadAppPhoto() {
            const file = document.getElementById('appPhotoFile').files[0];
            const date = document.getElementById('dDate').value;
            const sid = document.getElementById('mSid').value;
            if (!file || !date) return alert("ì‚¬ì§„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
            const reader = new FileReader(); reader.readAsDataURL(file);
            reader.onload = function (e) {
                const base64 = e.target.result.split(',')[1];
                const sText = students[sid];
                fetch(WEB_APP_URL, { method: "POST", body: JSON.stringify({ action: "uploadPhoto", base64: base64, mimeType: file.type, sid: sid, mid: "ìš©ëª¨ì²´í¬", name: sText, date: date }) }).then(r => r.json()).then(res => {
                    alert("ì—…ë¡œë“œ ì™„ë£Œ!"); document.getElementById('modal').style.display = 'none'; loadDaily();
                });
            }
        }

        function initWeekSelector() { const wSel = document.getElementById('wWeekSelect'); const today = new Date(); for (let i = 0; i < 5; i++) { const d = new Date(today); d.setDate(today.getDate() - (i * 7)); const diff = d.getDate() - d.getDay() + (d.getDay() == 0 ? -6 : 1); const monday = new Date(d.setDate(diff)); const val = monday.toISOString().slice(0, 10); const opt = document.createElement('option'); opt.value = val; opt.innerText = `${monday.getMonth() + 1}ì›” ${Math.ceil(monday.getDate() / 7)}ì£¼ì°¨ (${val}~)`; wSel.appendChild(opt); } }
        function openQrModal(sid, name) { document.getElementById('qrModal').style.display = 'flex'; document.getElementById('qrName').innerText = name; document.getElementById('qrImage').innerHTML = `<img src="https://quickchart.io/qr?text=${encodeURIComponent(sid + "," + name)}&size=200">`; }
        function downloadMonthlyJPG() { html2canvas(document.getElementById('monthlyReportContainer')).then(c => { const a = document.createElement('a'); a.download = 'MonthReport.jpg'; a.href = c.toDataURL(); a.click(); }); }
        function downloadWeeklyJPG() { html2canvas(document.getElementById('weeklyReportContainer')).then(c => { const a = document.createElement('a'); a.download = 'WeekReport.jpg'; a.href = c.toDataURL(); a.click(); }); }

        function openModal(sid, mid, note = "") {
            document.getElementById('modal').style.display = 'flex'; document.getElementById('mTitle').innerText = mid; document.getElementById('mSid').value = sid; document.getElementById('mMid').value = mid;
            document.getElementById('ui-life').style.display = 'none'; document.getElementById('ui-normal').style.display = 'none'; document.getElementById('ui-appearance').style.display = 'none';
            if (mid === 'ìƒí™œë¯¸ì…˜') { document.getElementById('ui-life').style.display = 'block'; } else if (mid === 'ìš©ëª¨ì²´í¬') { document.getElementById('ui-appearance').style.display = 'block'; const preview = document.getElementById('appPreviewArea'); if (note && note.includes("ID:")) { preview.innerHTML = "âœ… ì´ë¯¸ì§€ê°€ ë“±ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤."; } else { preview.innerHTML = "ë“±ë¡ëœ ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤."; } } else { document.getElementById('ui-normal').style.display = 'block'; }
        }

        function handleLife(s) { const f = document.getElementById('lifePhoto').files[0]; const msg = document.getElementById('lifeMsg').value; if (f) { const r = new FileReader(); r.readAsDataURL(f); r.onload = function (e) { sendData(s, msg, e.target.result.split(',')[1], f.type); } } else { sendData(s, msg, null, null); } }
        function sendData(s, msg, b64, mime) { const sid = document.getElementById('mSid').value; const d = document.getElementById('dDate').value; const body = { action: b64 ? "uploadPhoto" : "teacherControl", sid: sid, mid: "ìƒí™œë¯¸ì…˜", act: s, message: msg, date: d }; if (b64) { body.base64 = b64; body.mimeType = mime; body.name = students[sid]; } fetch(WEB_APP_URL, { method: "POST", body: JSON.stringify(body) }).then(() => { alert("ì™„ë£Œ"); document.getElementById('modal').style.display = 'none'; loadDaily(); }); }
        function sendCtrl(act) { const sid = document.getElementById('mSid').value; const mid = document.getElementById('mMid').value; const d = document.getElementById('dDate').value; const newName = document.getElementById('ctrlMissionSelect').value; const finalName = newName ? newName : mid; fetch(WEB_APP_URL, { method: "POST", body: JSON.stringify({ action: "teacherControl", sid: sid, mid: mid, newMissionName: finalName, act: act, date: d, comment: document.getElementById('tComment').value, startTime: document.getElementById('tStart').value, endTime: document.getElementById('tEnd').value }) }).then(() => { alert("ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤."); document.getElementById('modal').style.display = 'none'; loadDaily(); }); }
        function sendAdjustment() { const sid = document.getElementById('mSid').value; const d = document.getElementById('dDate').value; const amount = document.getElementById('adjAmount').value; const reason = document.getElementById('adjReason').value; if (!amount) return alert("ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”"); fetch(WEB_APP_URL, { method: "POST", body: JSON.stringify({ action: "teacherControl", sid: sid, mid: "ìƒë²Œì ", date: d, message: reason, comment: amount }) }).then(() => { alert("ìƒë²Œì ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤."); document.getElementById('modal').style.display = 'none'; document.getElementById('adjAmount').value = ""; document.getElementById('adjReason').value = ""; loadDaily(); }); }
    </script>
</body>
</html>