<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë‹¤ì›€í•™êµ ì„ ìƒë‹˜</title>
  <style>
    :root { --p: #4f46e5; --bg: #f1f5f9; --ok: #10b981; --fail: #ef4444; --cancel: #9ca3af; }
    body { font-family: 'Pretendard', sans-serif; background: var(--bg); padding: 20px; color:#333; }
    
    .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
    .tab { padding: 12px 24px; border-radius: 10px; background: #cbd5e1; cursor: pointer; font-weight: bold; color: #475569; transition:0.2s; }
    .tab.active { background: var(--p); color: white; box-shadow: 0 4px 10px rgba(79, 70, 229, 0.3); }
    
    .view { display: none; } 
    .view.active { display: block; animation: fadeIn 0.3s; }
    @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
    
    /* ì¼ê°„ ê´€ë¦¬ ìŠ¤íƒ€ì¼ */
    .daily-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
    .student-col { background: white; padding: 15px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
    .col-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 2px solid #f1f5f9; padding-bottom: 10px; }
    .money-badge { background: #fff7ed; color: #d97706; padding: 5px 10px; border-radius: 20px; font-weight: bold; font-size: 14px; }
    .m-item { border: 1px solid #eee; padding: 10px; margin-bottom: 8px; border-radius: 8px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
    .m-item.done { border-left: 5px solid var(--ok); background: #f0fdf4; }
    .m-item.life-ok { border-left: 5px solid var(--ok); background: #dcfce7; }
    .m-item.ing { border-left: 5px solid orange; background: #fff7ed; }
    .m-item.fail { border-left: 5px solid var(--fail); background: #fef2f2; opacity: 0.8; }
    .m-item.cancel { border-left: 5px solid var(--cancel); background: #f3f4f6; color: #6b7280; }
    
    /* ì£¼ê°„ ë¦¬í¬íŠ¸ ìŠ¤íƒ€ì¼ */
    .weekly-card { background: white; border-radius: 20px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
    .weekly-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .weekly-table { width: 100%; border-collapse: collapse; overflow: hidden; }
    .weekly-table th { background: #f8fafc; color: #64748b; padding: 12px; font-size: 14px; border-bottom: 2px solid #e2e8f0; }
    .weekly-table td { border: 1px solid #e2e8f0; padding: 8px; vertical-align: top; text-align: center; min-height: 60px; }
    
    .cell-mission { font-size: 13px; font-weight: 600; color: #333; margin-bottom: 4px; display: flex; flex-direction: column; align-items: center; gap: 2px; }
    .cell-status { font-size: 11px; padding: 2px 6px; border-radius: 4px; display: inline-block; margin-top: 2px; }
    .st-done { background: #dcfce7; color: #166534; }
    .st-fail { background: #fee2e2; color: #991b1b; }
    .st-ing { background: #fff7ed; color: #9a3412; }
    .st-cancel { background: #e5e7eb; color: #6b7280; text-decoration: line-through; }
    .cell-detail { font-size: 10px; color: #64748b; line-height: 1.3; margin-top: 2px; font-family: monospace; }
    .cell-price { font-size: 11px; font-weight: 800; margin-top: 4px; }
    .price-plus { color: #059669; }
    .price-zero { color: #9ca3af; }
    .price-minus { color: #ef4444; }

    .diff-badge { font-size: 10px; font-weight: 800; padding: 1px 4px; border-radius: 3px; margin-left: 3px; }
    .diff-EASY { color: #10b981; background: #ecfdf5; border: 1px solid #10b981; }
    .diff-NORMAL { color: #3b82f6; background: #eff6ff; border: 1px solid #3b82f6; }
    .diff-HARD { color: #ef4444; background: #fef2f2; border: 1px solid #ef4444; }
    
    .total-box { text-align: right; }
    .total-label { font-size: 13px; color: #666; }
    .total-amount { font-size: 24px; font-weight: 800; color: var(--p); }
    .penalty-info { font-size: 12px; color: var(--fail); font-weight: bold; margin-top: 5px; }

    /* [NEW] ê¸‰ì—¬ ëª…ì„¸ì„œ ìŠ¤íƒ€ì¼ (í‘œ í˜•íƒœ) */
    .pay-container { max-width: 600px; margin: 0 auto; }
    .pay-statement { background: white; border: 1px solid #cbd5e1; border-radius: 15px; padding: 40px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); text-align: center; }
    
    .pay-header-line { border-bottom: 2px solid #333; padding-bottom: 20px; margin-bottom: 20px; }
    .pay-title { font-size: 22px; font-weight: bold; color: #1e293b; margin: 0; }
    .pay-date-range { font-size: 14px; color: #64748b; margin-top: 5px; }
    
    .pay-big-total { font-size: 48px; font-weight: 900; color: var(--p); margin: 20px 0; letter-spacing: -1px; }
    
    .pay-table-view { width: 100%; border-collapse: collapse; margin-top: 10px; }
    .pay-table-view th { background: #f1f5f9; padding: 12px; text-align: left; color: #64748b; font-size: 14px; border-bottom: 1px solid #e2e8f0; }
    .pay-table-view td { padding: 15px 12px; border-bottom: 1px solid #e2e8f0; font-size: 16px; font-weight: 600; color: #333; }
    .pay-table-view td.money-col { text-align: right; font-family: monospace; font-size: 18px; }
    
    .pay-row-day { display: flex; align-items: center; gap: 10px; }
    .day-circle { width: 30px; height: 30px; background: #e0e7ff; color: var(--p); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold; }
    
    .pay-footer { margin-top: 30px; font-size: 12px; color: #94a3b8; }

    /* ëª¨ë‹¬ */
    #modal { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:none; justify-content:center; align-items:center; z-index: 1000; }
    .modal-box { background: white; padding: 25px; border-radius: 15px; width: 400px; max-height: 90vh; overflow-y: auto; }
    input, textarea, select { width: 100%; padding: 10px; margin: 5px 0 15px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
    .btn { padding: 10px; width: 100%; border: none; border-radius: 8px; font-weight: bold; color: white; cursor: pointer; margin-top: 5px; }
    .chk-group label { display: block; margin-bottom: 8px; cursor: pointer; font-size: 14px; }
    .section-label { font-size:12px; font-weight:bold; color:#666; margin-top:10px; display:block; }
  </style>
</head>
<body>

<div class="tabs">
  <div class="tab active" onclick="goTab('daily')">ğŸ“… ì¼ê°„ ê´€ë¦¬</div>
  <div class="tab" onclick="goTab('weekly')">ğŸ“Š ì£¼ê°„ ë¦¬í¬íŠ¸</div>
  <div class="tab" onclick="goTab('pay')">ğŸ’° ê¸‰ì—¬ ëª…ì„¸ì„œ</div>
</div>

<div id="daily" class="view active">
  <div style="margin-bottom: 15px;">
    <input type="date" id="dDate" style="width:auto; padding:8px;" onchange="loadDaily()">
    <button onclick="loadDaily()" style="background:var(--p); color:white; border:none; padding:8px 15px; border-radius:8px;">ìƒˆë¡œê³ ì¹¨</button>
  </div>
  <div class="daily-grid" id="dailyBoard"></div>
</div>

<div id="weekly" class="view">
  <div class="weekly-card">
    <div class="weekly-header">
      <div style="display:flex; gap:10px;">
        <select id="wStudent" onchange="loadWeekly()" style="padding:10px; font-weight:bold;">
          <option value="S01">ê°•íƒœìœ¤</option><option value="S02">ê¹€ëŒ€ì¤‘</option><option value="S03">ìµœì›ì¤€</option>
        </select>
        <select id="wWeekSelect" onchange="loadWeekly()" style="padding:10px;"></select>
      </div>
      <div class="total-box">
        <div class="total-label">ì´ë²ˆ ì£¼ ì´ ìˆ˜ì…</div>
        <div class="total-amount" id="totalWeekMoney">0ì›</div>
        <div class="penalty-info" id="penaltyMsg"></div>
      </div>
    </div>
    <div id="weeklyBoard"></div>
  </div>
</div>

<div id="pay" class="view">
  <div style="margin-bottom: 20px; display: flex; gap: 10px; justify-content: center;">
    <select id="pStudent" onchange="loadPay()" style="padding:10px; font-weight:bold; width: auto; border-radius:8px;">
      <option value="S01">ê°•íƒœìœ¤</option><option value="S02">ê¹€ëŒ€ì¤‘</option><option value="S03">ìµœì›ì¤€</option>
    </select>
    <select id="pWeekSelect" onchange="loadPay()" style="padding:10px; width: auto; border-radius:8px;"></select>
  </div>

  <div class="pay-container">
    <div class="pay-statement">
      <div class="pay-header-line">
        <h2 class="pay-title" id="payStatementTitle">OOOì˜ ì´ë²ˆ ì£¼ ê¸‰ì—¬ ëª…ì„¸ì„œ</h2>
        <div class="pay-date-range" id="payDateRange">2026.01.12 ~ 2026.01.16</div>
      </div>

      <div class="pay-big-total" id="payStatementTotal">â‚©0</div>

      <table class="pay-table-view">
        <thead>
          <tr>
            <th>ìš”ì¼</th>
            <th style="text-align:right;">ì§€ê¸‰ì•¡</th>
          </tr>
        </thead>
        <tbody id="payTableBody">
          </tbody>
      </table>

      <div class="pay-footer">
        * ë³¸ ëª…ì„¸ì„œëŠ” ë‹¤ì›€í•™êµ ìƒí™œ ë° í•™ìŠµ ë¯¸ì…˜ ìˆ˜í–‰ ê²°ê³¼ì— ë”°ë¼ ì‚°ì¶œë˜ì—ˆìŠµë‹ˆë‹¤.
      </div>
    </div>
  </div>
</div>

<div id="modal">
  <div class="modal-box">
    <h3 id="mTitle" style="margin-top:0; color:var(--p);"></h3>
    <input type="hidden" id="mSid"><input type="hidden" id="mMid">
    
    <div id="ui-life" style="display:none;">
      <div class="chk-group">
        <label><input type="checkbox" class="life-chk"> 1. ê°œì¸ ìœ„ìƒ</label>
        <label><input type="checkbox" class="life-chk"> 2. ì¹¨êµ¬ ì •ë¦¬</label>
        <label><input type="checkbox" class="life-chk"> 3. ë¹¨ë˜ ì •ë¦¬</label>
        <label><input type="checkbox" class="life-chk"> 4. ì˜ë³µ ì •ë¦¬</label>
        <label><input type="checkbox" class="life-chk"> 5. ì‹ ë°œ ì •ë¦¬</label>
        <label><input type="checkbox" class="life-chk"> 6. ì“°ë ˆê¸° ì •ë¦¬</label>
        <label><input type="checkbox" class="life-chk"> 7. ë¬¼ê±´ ì •ë¦¬</label>
        <label><input type="checkbox" class="life-chk"> 8. ì•ˆì „ í™•ì¸</label>
        <label><input type="checkbox" class="life-chk"> 9. ì¶œì„ì²´í¬</label>
        <label><input type="checkbox" class="life-chk"> 10. ì •ì‹œ ë“±êµ</label>
      </div>
      <hr style="margin:15px 0; border:0; border-top:1px solid #eee;">
      <p style="font-size:14px; font-weight:bold;">ğŸ“¸ ì¦ê±° ì‚¬ì§„ (ì„ íƒ)</p>
      <input type="file" id="lifePhoto" accept="image/*">
      <button class="btn" style="background:var(--ok);" onclick="handleLife('life_ok')">âœ… ì™„ë£Œ ìŠ¹ì¸</button>
      <hr style="margin:15px 0; border:0; border-top:1px solid #eee;">
      <div style="display:flex; gap:5px;">
        <button class="btn" style="background:var(--fail);" onclick="handleLife('fail')">âŒ ì‹¤íŒ¨</button>
        <button class="btn" style="background:var(--cancel); color:white;" onclick="sendCtrl('cancel')">ğŸš« íœ´ê°•</button>
      </div>
    </div>

    <div id="ui-normal">
      <label class="section-label">ë¯¸ì…˜ ë³€ê²½</label>
      <select id="ctrlMissionSelect">
        <option value="">(ìœ ì§€)</option>
        <optgroup label="ì˜¤ì „"><option>ê¸€ì“°ê¸°</option><option>ë…ì„œ</option><option>ìì„œì „</option></optgroup>
        <optgroup label="ì„ íƒ"><option>ì»´í“¨í„°</option><option>ìš´ë™</option><option>ì˜ì–´íšŒí™”</option><option>ê¸€ì”¨ ì—°ìŠµ</option></optgroup>
        <optgroup label="ì˜¤í›„"><option>ê²€ì •ê³ ì‹œ</option><option>ìŒì•…</option><option>SCLì±…ë ¥</option><option>ì‹¬í™”ê³µë¶€</option><option>êµë¥˜ìˆ˜ì—…</option><option>ì¶•êµ¬</option><option>ì˜ˆë°°</option></optgroup>
      </select>
      
      <div id="diffSection">
        <label class="section-label">ë‚œì´ë„</label>
        <select id="tComment">
          <option value="NORMAL">NORMAL</option><option value="EASY">EASY</option><option value="HARD">HARD</option>
        </select>
      </div>

      <label class="section-label">ì‹œê°„</label>
      <div style="display:flex; gap:10px;"><input type="time" id="tStart">~<input type="time" id="tEnd"></div>
      
      <div style="display:flex; gap:5px; margin-top:15px;">
        <button class="btn" style="background:var(--ok);" onclick="sendCtrl('end')">ì™„ë£Œ</button>
        <button class="btn" style="background:var(--fail);" onclick="sendCtrl('fail')">ì‹¤íŒ¨</button>
        <button class="btn" style="background:var(--cancel); color:white;" onclick="sendCtrl('cancel')">íœ´ê°•</button>
      </div>
      <button class="btn" style="background:#94a3b8; margin-top:10px;" onclick="sendCtrl('delete')">ì‚­ì œ</button>
    </div>

    <div id="ui-day" style="display:none;">
      <p style="text-align:center;">í•˜ë£¨ë¥¼ ë§ˆê°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
      <button class="btn" style="background:var(--p);" onclick="sendCtrl('end')">í•˜ë£¨ ê¸°ë¡ ì™„ë£Œ</button>
    </div>
    <button class="btn" style="background:white; color:#333; border:1px solid #ddd; margin-top:15px;" onclick="document.getElementById('modal').style.display='none'">ë‹«ê¸°</button>
  </div>
</div>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxmsvx5xVkJvVhLsVvLsLtHdhdX5OwEma7Ipzr6HU0cR-7JMa5uQyipwGIWZB1nxVJudw/exec"; 
const students = { "S01": "ê°•íƒœìœ¤", "S02": "ê¹€ëŒ€ì¤‘", "S03": "ìµœì›ì¤€" };
const noDiffMissions = ["êµë¥˜ìˆ˜ì—…", "SCLì±…ë ¥", "ê²€ì •ê³ ì‹œ", "ìŒì•…", "ì‹¬í™”ê³µë¶€", "ì˜¤í›„í™œë™", "ë§ì¶¤í•™ìŠµ", "ì˜ˆë°°", "ì¶•êµ¬"];

document.addEventListener("DOMContentLoaded", () => {
  document.getElementById('dDate').value = new Date().toISOString().slice(0,10);
  initWeekSelector(); 
  loadDaily();
});

function goTab(id) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  event.target.classList.add('active');
  if(id === 'daily') loadDaily();
  else if(id === 'weekly') loadWeekly();
  else loadPay();
}

function initWeekSelector() {
  const today = new Date();
  const wSel = document.getElementById('wWeekSelect');
  const pSel = document.getElementById('pWeekSelect');
  
  for (let i = 0; i < 5; i++) {
    const d = new Date(today);
    d.setDate(today.getDate() - (i * 7));
    const day = d.getDay();
    const diff = d.getDate() - day + (day == 0 ? -6 : 1);
    const monday = new Date(d.setDate(diff));
    const val = monday.toISOString().slice(0,10);
    const txt = `${monday.getMonth()+1}ì›” ${Math.ceil(monday.getDate()/7)}ì£¼ì°¨ (${val}~)`;
    
    const opt1 = document.createElement('option'); opt1.value=val; opt1.innerText=txt; wSel.appendChild(opt1);
    const opt2 = document.createElement('option'); opt2.value=val; opt2.innerText=txt; pSel.appendChild(opt2);
  }
}

// ğŸ’° ê¸‰ì—¬ ëª…ì„¸ì„œ ë¡œë“œ (ë””ìì¸ ê°œì„ ë¨)
function loadPay() {
  const sid = document.getElementById('pStudent').value;
  const date = document.getElementById('pWeekSelect').value || new Date().toISOString().slice(0,10);
  const sName = students[sid]; // í•™ìƒ ì´ë¦„

  fetch(WEB_APP_URL, { method:"POST", body:JSON.stringify({action:"getWeeklyData", sid:sid, date:date}) })
  .then(r=>r.json()).then(res => {
    // 1. ì œëª© ë° ë‚ ì§œ ì—…ë°ì´íŠ¸
    document.getElementById('payStatementTitle').innerText = `${sName}ì˜ ì´ë²ˆ ì£¼ ê¸‰ì—¬ ëª…ì„¸ì„œ`;
    
    // ë‚ ì§œ ë²”ìœ„ ê³„ì‚° (ì›”~ê¸ˆ)
    const startDate = new Date(res.days[0].date);
    const endDate = new Date(res.days[4].date);
    const startStr = startDate.toLocaleDateString();
    const endStr = endDate.toLocaleDateString();
    document.getElementById('payDateRange').innerText = `${startStr} ~ ${endStr}`;

    // 2. ì´ì•¡ ì—…ë°ì´íŠ¸
    document.getElementById('payStatementTotal').innerText = "â‚©" + res.total.toLocaleString();

    // 3. í‘œ ë‚´ìš© ìƒì„±
    const tbody = document.getElementById('payTableBody');
    tbody.innerHTML = "";
    
    const dayNames = ["ì›”ìš”ì¼", "í™”ìš”ì¼", "ìˆ˜ìš”ì¼", "ëª©ìš”ì¼", "ê¸ˆìš”ì¼"];
    
    for(let i=0; i<5; i++) {
      const money = res.days[i].money;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>
          <div class="pay-row-day">
            <div class="day-circle">${dayNames[i][0]}</div>
            <span>${dayNames[i]}</span>
          </div>
        </td>
        <td class="money-col">â‚©${money.toLocaleString()}</td>
      `;
      tbody.appendChild(tr);
    }
    
    // í•©ê³„ í–‰ ì¶”ê°€
    const totalTr = document.createElement('tr');
    totalTr.style.background = "#f8fafc";
    totalTr.style.borderTop = "2px solid #333";
    totalTr.innerHTML = `
      <td style="font-weight:bold; padding:15px 12px;">í•©ê³„</td>
      <td class="money-col" style="font-weight:900; color:var(--p);">â‚©${res.total.toLocaleString()}</td>
    `;
    tbody.appendChild(totalTr);
  });
}

function loadDaily() {
  const date = document.getElementById('dDate').value;
  fetch(WEB_APP_URL, { method:"POST", body:JSON.stringify({action:"getDailyData", date:date}) })
  .then(res=>res.json()).then(data => {
    const board = document.getElementById('dailyBoard');
    board.innerHTML = "";
    Object.keys(students).forEach(sid => {
      const col = document.createElement('div'); col.className = 'student-col';
      const s = data.schedules[sid]; const l = data.logs[sid] || {};
      let isPaid = l["í•˜ë£¨ ê¸°ë¡"] && l["í•˜ë£¨ ê¸°ë¡"].status === 'end';
      let rawMoney = 0;
      Object.values(l).forEach(item => { if(item.money) rawMoney += item.money; });

      col.innerHTML = `<div class="col-header"><h3>${students[sid]}</h3><span class="money-badge" style="display:${isPaid?'block':'none'}">ì›ê¸ˆ: â‚©${rawMoney.toLocaleString()}</span></div>`;
      
      const life = l["ìƒí™œë¯¸ì…˜"];
      let lifeCls = "", lifeTxt = "ë¯¸ì™„ë£Œ";
      if(life) {
        if(life.status === 'life_ok') { lifeCls = 'life-ok'; lifeTxt = 'ì„±ê³µ'; }
        if(life.status === 'fail') { lifeCls = 'fail'; lifeTxt = 'ì‹¤íŒ¨'; }
        if(life.status === 'cancel') { lifeCls = 'cancel'; lifeTxt = 'íœ´ê°•'; }
      }
      col.innerHTML += `<div class="m-item ${lifeCls}" onclick="openModal('${sid}','ìƒí™œë¯¸ì…˜')"><b>ğŸŒ ìƒí™œë¯¸ì…˜</b> <span>${lifeTxt}</span></div>`;

      if(s) {
        const schedKeys = [s.m1.n, s.m2.n, s.m3.n, s.c1a.n, s.c1b.n, s.c2.n];
        const allLogKeys = Object.keys(l).filter(k => k !== "ìƒí™œë¯¸ì…˜" && k !== "í•˜ë£¨ ê¸°ë¡");
        const extraMissions = allLogKeys.filter(k => !schedKeys.includes(k));

        [s.m1, s.m2, s.m3, s.c1a, s.c1b, s.c2].forEach(m => {
          if(!m.n) return;
          let effectiveName = m.n;
          let ml = l[m.n];
          if (!ml && (m.n.includes("ì„ íƒ") || m.n === "ë¯¸ì •" || m.n === "ì˜¤í›„í™œë™") && extraMissions.length > 0) {
            effectiveName = extraMissions.shift(); ml = l[effectiveName];
          }
          let c = ""; 
          if(ml){ 
            if(ml.status=='start')c='ing'; if(ml.status=='end')c='done'; 
            if(ml.status=='fail')c='fail'; if(ml.status=='cancel')c='cancel';
          }
          
          let tStr = parseTimeStr(ml);
          if(ml && ml.status=='cancel') tStr = "íœ´ê°•ë¨";
          
          let diffHtml = "";
          if(!noDiffMissions.includes(effectiveName)) {
             let currentDiff = (ml && ml.comment) ? ml.comment : (m.l || "NORMAL");
             if(["EASY","NORMAL","HARD"].includes(currentDiff)) {
                const dCls = currentDiff==='EASY'?'diff-EASY':(currentDiff==='HARD'?'diff-HARD':'diff-NORMAL');
                diffHtml = `<span class="diff-badge ${dCls}">${currentDiff}</span>`;
             }
          }

          col.innerHTML += `<div class="m-item ${c}" onclick="openModal('${sid}','${effectiveName}', '${(ml && ml.comment) ? ml.comment : (m.l || "NORMAL")}')">
            <div>${effectiveName} ${diffHtml}</div>
            <small>${tStr}</small>
          </div>`;
        });
      }
      const btnTxt = isPaid ? "âœ… ì •ì‚° ì™„ë£Œ" : "í•˜ë£¨ ê¸°ë¡ (ì •ì‚°)";
      const btnCls = isPaid ? "background:#94a3b8" : "background:#3b82f6; animation:pulse 2s infinite;";
      col.innerHTML += `<button class="btn" style="${btnCls}; margin-top:10px;" onclick="openModal('${sid}','í•˜ë£¨ ê¸°ë¡')">${btnTxt}</button>`;
      board.appendChild(col);
    });
  });
}

function openModal(sid, mid, diff) {
  document.getElementById('modal').style.display='flex';
  document.getElementById('mTitle').innerText = students[sid] + " - " + mid;
  document.getElementById('mSid').value = sid; document.getElementById('mMid').value = mid;
  
  document.getElementById('lifePhoto').value = ""; 
  document.querySelectorAll('.life-chk').forEach(c => c.checked = false);
  
  document.getElementById('ui-life').style.display='none';
  document.getElementById('ui-normal').style.display='none';
  document.getElementById('ui-day').style.display='none';
  document.getElementById('ctrlMissionSelect').value = "";
  document.getElementById('tComment').value = diff || "NORMAL";
  document.getElementById('tStart').value = "";
  document.getElementById('tEnd').value = "";

  if(mid==='ìƒí™œë¯¸ì…˜') document.getElementById('ui-life').style.display='block';
  else if(mid==='í•˜ë£¨ ê¸°ë¡') document.getElementById('ui-day').style.display='block';
  else {
    document.getElementById('ui-normal').style.display='block';
    if(noDiffMissions.includes(mid)) document.getElementById('diffSection').style.display = 'none';
    else document.getElementById('diffSection').style.display = 'block';
  }
}

function handleLife(status) {
  const file = document.getElementById('lifePhoto').files[0];
  if(file) uploadPhoto(status);
  else {
    if(status === 'life_ok') { if(!confirm("ì‚¬ì§„ ì—†ì´ ì™„ë£Œ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return; sendCtrl('life_ok'); }
    else sendCtrl('fail');
  }
}

function uploadPhoto(status) {
  const file = document.getElementById('lifePhoto').files[0];
  const reader = new FileReader();
  reader.onload = function(e) {
    const b64 = e.target.result.split(',')[1];
    const sid = document.getElementById('mSid').value;
    const date = document.getElementById('dDate').value;
    fetch(WEB_APP_URL, { method:"POST", body:JSON.stringify({
      action:"uploadLifePhoto", base64:b64, mimeType:file.type, sid:sid, 
      name:students[sid], date:date, status:status
    })}).then(r=>r.json()).then(()=>{ alert("ì²˜ë¦¬ ì™„ë£Œ"); document.getElementById('modal').style.display='none'; loadDaily(); });
  };
  reader.readAsDataURL(file);
}

function sendCtrl(act) {
  const date = document.getElementById('dDate').value;
  if(act === 'life_ok' || act === 'fail' || act === 'cancel') {
     if(document.getElementById('mMid').value === 'ìƒí™œë¯¸ì…˜') {
        fetch(WEB_APP_URL, { method:"POST", body:JSON.stringify({
          action:"teacherControl", sid:document.getElementById('mSid').value, mid:"ìƒí™œë¯¸ì…˜", act:act, note:"ìˆ˜ë™ì²˜ë¦¬", date: date
        })}).then(()=>{ alert("ì™„ë£Œë¨"); document.getElementById('modal').style.display='none'; loadDaily(); });
        return;
     }
  }
  const newName = document.getElementById('ctrlMissionSelect').value;
  fetch(WEB_APP_URL, { method:"POST", body:JSON.stringify({
    action:"teacherControl", 
    sid:document.getElementById('mSid').value, mid:document.getElementById('mMid').value, 
    newMissionName: newName, act:act, comment:document.getElementById('tComment').value, 
    startTime:document.getElementById('tStart').value, endTime:document.getElementById('tEnd').value, date: date
  })}).then(()=>{ alert("ì²˜ë¦¬ë¨"); document.getElementById('modal').style.display='none'; loadDaily(); });
}

function loadWeekly() {
  const sid = document.getElementById('wStudent').value;
  const date = document.getElementById('wWeekSelect').value || new Date().toISOString().slice(0,10);
  fetch(WEB_APP_URL, { method:"POST", body:JSON.stringify({action:"getWeeklyData", sid:sid, date:date}) })
  .then(r=>r.json()).then(res => {
    let h = `<table class="weekly-table"><thead><tr><th>ì‹œê°„</th>`;
    ["ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ"].forEach(d=>h+=`<th>${d}</th>`);
    h+=`</tr></thead><tbody>`;
    const slots = [
      {t:"09:00",k:"life"}, {t:"09:30",k:"am"}, {t:"11:00",k:"sel1"}, {t:"12:00",k:"lunch"}, {t:"13:00",k:"pm"}, {t:"15:00",k:"late"}, {t:"17:00",k:"end"}
    ];
    slots.forEach(slot => {
      h+=`<tr><td>${slot.t}</td>`;
      for(let i=0; i<5; i++){
        const d = res.days[i].data;
        const s = d.schedules[sid]; const l = d.logs[sid]||{};
        let content = "";
        
        if(slot.k==='life') {
           content = "ìƒí™œë¯¸ì…˜";
           if(l["ìƒí™œë¯¸ì…˜"]) {
             if(l["ìƒí™œë¯¸ì…˜"].status === 'life_ok') content += "<br>âœ… ì„±ê³µ";
             if(l["ìƒí™œë¯¸ì…˜"].status === 'fail') content += "<br>âŒ ì‹¤íŒ¨";
             if(l["ìƒí™œë¯¸ì…˜"].status === 'cancel') content += "<br>â›” íœ´ê°•";
             
             const money = l["ìƒí™œë¯¸ì…˜"].money || 0;
             let mClass = money > 0 ? "price-plus" : (money < 0 ? "price-minus" : "price-zero");
             content += `<div class="cell-price ${mClass}">â‚©${money.toLocaleString()}</div>`;
           }
        }
        else if(slot.k==='lunch') content = "<span style='color:#ccc'>ğŸ½ï¸ ì ì‹¬</span>";
        else if(i <= 2) { 
          if(slot.k==='am') content = getMList(s,['m1','m2','m3'],l);
          if(slot.k==='sel1') content = getMList(s,['c1a','c1b'],l);
          if(slot.k==='pm') content = getMList(s,['c2'],l);
          if(slot.k==='late') content = "í•˜ë£¨ ì •ë¦¬";
          if(slot.k==='end') content = "-";
        }
        else if(i === 3) {
          if(slot.k==='am' || slot.k==='sel1') content = "âš½ ì¶•êµ¬";
          if(slot.k==='pm') content = getMList(s,['c2'],l);
          if(slot.k==='late') content = getMList(s,['m1','m2','m3','c1a','c1b'],l);
          if(slot.k==='end') content = "í•˜ë£¨ ì •ë¦¬";
        }
        else if(i === 4) {
          if(slot.k==='am') content = getMList(s,['m1','m2','m3'],l);
          if(slot.k==='sel1') content = getMList(s,['c1a','c1b'],l);
          if(slot.k==='pm') content = "ğŸ™ ì˜ˆë°°";
          if(slot.k==='late') content = "";
          if(slot.k==='end') content = "í•˜ë£¨ ì •ë¦¬";
        }
        h+=`<td>${content}</td>`;
      }
      h+=`</tr>`;
    });
    h+=`<tr><td style="font-weight:bold;">ì¼ì¼ ìˆ˜ì…</td>`;
    for(let i=0; i<5; i++) h+=`<td style="font-weight:bold; color:var(--p);">â‚©${res.days[i].money.toLocaleString()}</td>`;
    h+=`</tr></tbody></table>`;
    document.getElementById('weeklyBoard').innerHTML = h;
    document.getElementById('totalWeekMoney').innerText = res.total.toLocaleString();
    document.getElementById('penaltyMsg').innerText = ""; 
  });
}

function getMList(s, keys, l) {
  if(!s) return "-";
  const allLogKeys = Object.keys(l).filter(k => k !== "ìƒí™œë¯¸ì…˜" && k !== "í•˜ë£¨ ê¸°ë¡");
  const schedKeys = keys.map(k => s[k] ? s[k].n : "");

  return keys.map(k => {
    if(!s[k] || !s[k].n) return "";
    let mName = s[k].n;
    let ml = l[mName];
    if (!ml && (mName.includes("ì„ íƒ") || mName === "ë¯¸ì •" || mName === "ì˜¤í›„í™œë™")) {
      const overrideName = allLogKeys.find(key => !schedKeys.includes(key));
      if (overrideName) { mName = overrideName; ml = l[overrideName]; }
    }

    let stClass = "", stTxt = "", detailTxt = "", diffHtml = "", moneyHtml = "";
    if(ml){ 
      const d = ml.comment;
      if(!noDiffMissions.includes(mName) && ["EASY","NORMAL","HARD"].includes(d)) {
        const dCls = d==='EASY'?'diff-EASY':(d==='HARD'?'diff-HARD':'diff-NORMAL');
        diffHtml = `<span class="diff-badge ${dCls}">${d}</span>`;
      } 
      else if (!noDiffMissions.includes(mName) && s[k].l && ["EASY","NORMAL","HARD"].includes(s[k].l)) {
        const d2 = s[k].l;
        const dCls2 = d2==='EASY'?'diff-EASY':(d2==='HARD'?'diff-HARD':'diff-NORMAL');
        diffHtml = `<span class="diff-badge ${dCls2}">${d2}</span>`;
      }

      if(ml.status=='end') { stClass='st-done'; stTxt='ì™„ë£Œ'; detailTxt = parseTimeStr(ml); }
      else if(ml.status=='start') { stClass='st-ing'; stTxt='ì§„í–‰ì¤‘'; detailTxt = parseTimeStr(ml); }
      else if(ml.status=='fail') { stClass='st-fail'; stTxt='ì‹¤íŒ¨'; }
      else if(ml.status=='cancel') { stClass='st-cancel'; stTxt='íœ´ê°•'; }
      
      if (ml.money !== undefined) {
         let mClass = ml.money > 0 ? "price-plus" : (ml.money < 0 ? "price-minus" : "price-zero");
         moneyHtml = `<div class="cell-price ${mClass}">â‚©${ml.money.toLocaleString()}</div>`;
      }
      
      return `<div class="cell-mission">${mName}${diffHtml}<span class="cell-status ${stClass}">${stTxt}</span><div class="cell-detail">${detailTxt}</div>${moneyHtml}</div>`;
    }
    
    if (!noDiffMissions.includes(mName) && s[k].l && ["EASY","NORMAL","HARD"].includes(s[k].l)) {
       const d2 = s[k].l;
       const dCls2 = d2==='EASY'?'diff-EASY':(d2==='HARD'?'diff-HARD':'diff-NORMAL');
       diffHtml = `<span class="diff-badge ${dCls2}">${d2}</span>`;
    }
    return `<div class="cell-mission">${mName}${diffHtml}</div>`;
  }).join("");
}

function parseTimeStr(ml) {
  if(!ml || !ml.note) return "-";
  let txt = ml.note;
  if(txt.includes("duration:")) {
    try {
      const parts = txt.split('|');
      const durPart = parts.find(p => p.startsWith("duration:"));
      if(durPart) {
        const seconds = parseInt(durPart.split(':')[1]);
        if(!isNaN(seconds)) {
          const m = Math.floor(seconds / 60);
          const s = seconds % 60;
          return `${m}ë¶„ ${s}ì´ˆ ì†Œìš”`;
        }
      }
    } catch(e) { return "ì‹œê°„ ì •ë³´ ì˜¤ë¥˜"; }
  }
  if(txt.includes("Start")) return txt.replace("Start:", "ì‹œì‘:");
  if(txt.includes("NaN")) return "-";
  return txt;
}
</script>
</body>
</html>