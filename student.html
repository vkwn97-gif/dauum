<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LDS ì‚¬ì› ì•±</title>
    <style>
        :root {
            --p: #4f46e5;
            --bg: #f8fafc;
            --card: #ffffff;
            --ok: #10b981;
            --fail: #ef4444;
        }

        body {
            font-family: 'Pretendard', sans-serif;
            background: var(--bg);
            padding: 15px;
            margin: 0;
            color: #333;
        }

        .view {
            display: none;
        }

            .view.active {
                display: block;
                animation: fadeIn 0.3s;
            }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            position: relative;
        }

        .card {
            background: var(--card);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            margin-bottom: 15px;
            text-align: center;
        }

        .user-card {
            cursor: pointer;
            transition: 0.2s;
            border: 1px solid transparent;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 15px;
            padding: 20px;
        }

            .user-card:active {
                transform: scale(0.98);
                border-color: var(--p);
            }

        .avatar {
            font-size: 24px;
            background: #e0e7ff;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .user-info {
            text-align: left;
        }

        .user-name {
            font-size: 18px;
            font-weight: bold;
            margin: 0;
            color: #1e293b;
        }

        .lds-header {
            text-align: center;
            margin: 20px 0 30px;
        }

        .lds-logo-text {
            font-size: 12px;
            font-weight: 900;
            color: #94a3b8;
            letter-spacing: 2px;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .lds-main-title {
            font-size: 26px;
            font-weight: 800;
            color: #1e293b;
            margin: 0;
        }

        .lds-date {
            color: #64748b;
            margin-top: 8px;
            font-size: 14px;
            font-weight: 500;
        }

        #topNoticeBar {
            display: none;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        .notice-banner {
            background: #fef3c7;
            color: #92400e;
            padding: 15px;
            border-radius: 12px;
            font-weight: bold;
            text-align: left;
            border: 1px solid #fcd34d;
            font-size: 14px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

            .notice-banner .n-date {
                font-size: 11px;
                color: #b45309;
            }

        /* ë ˆì´ìŠ¤ ìœ„ì ¯ */
        .race-card {
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            border: 2px solid #e0e7ff;
        }

        .race-title {
            font-size: 16px;
            font-weight: 900;
            color: var(--p);
            margin: 0 0 15px 0;
            text-align: left;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }

        .race-goal {
            font-size: 11px;
            color: #64748b;
            font-weight: 600;
        }

        .race-track {
            position: relative;
            padding-right: 15px;
            margin-top: 10px;
        }

        .finish-line {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 6px;
            background: repeating-linear-gradient(45deg, #cbd5e1 0, #cbd5e1 5px, #f8fafc 5px, #f8fafc 10px);
            border-radius: 3px;
            z-index: 0;
        }

        .lane {
            margin-bottom: 18px;
            position: relative;
            z-index: 1;
            text-align: left;
        }

            .lane:last-child {
                margin-bottom: 0;
            }

        .lane-info {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            font-weight: bold;
            color: #475569;
            margin-bottom: 6px;
            padding: 0 5px;
        }

        .runner-money {
            color: var(--p);
            font-weight: 900;
            font-size: 14px;
        }

        .track-bg {
            background: #f1f5f9;
            height: 16px;
            border-radius: 8px;
            position: relative;
            width: 100%;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }

        .runner-bar {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            border-radius: 8px;
            transition: width 1.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .lane-S01 .runner-bar {
            background: linear-gradient(90deg, #64748b, #334155);
        }

        .lane-S02 .runner-bar {
            background: linear-gradient(90deg, #93c5fd, #3b82f6);
        }

        .lane-S03 .runner-bar {
            background: linear-gradient(90deg, #6ee7b7, #10b981);
        }

        .lane-S04 .runner-bar {
            background: linear-gradient(90deg, #fdba74, #ea580c);
        }

        .lane-S05 .runner-bar {
            background: linear-gradient(90deg, #d8b4fe, #8b5cf6);
        }

        .runner-icon {
            position: absolute;
            right: -14px;
            top: -6px;
            font-size: 16px;
            background: white;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 6px rgba(0,0,0,0.25);
            z-index: 2;
        }

        /* ê³„íš ìˆ˜ë¦½ìš© UI */
        .time-block {
            background: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            text-align: left;
        }

        .time-title {
            font-size: 15px;
            font-weight: 800;
            color: var(--p);
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cat-selector {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }

        .cat-btn {
            flex: 1;
            padding: 10px 5px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            background: #f8fafc;
            color: #64748b;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
            text-align: center;
            transition: 0.2s;
        }

            .cat-btn.active {
                background: var(--p);
                color: white;
                border-color: var(--p);
                box-shadow: 0 2px 5px rgba(79, 70, 229, 0.3);
            }

        .mission-row {
            display: flex;
            gap: 5px;
            margin-bottom: 8px;
            align-items: center;
        }

            .mission-row select, .mission-row input {
                flex: 1;
            }

        .fixed-label {
            background: #f1f5f9;
            padding: 12px;
            border-radius: 8px;
            font-weight: bold;
            color: #475569;
            border: 1px solid #e2e8f0;
            text-align: center;
            flex: 1;
        }

        select, input[type=text], textarea {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            font-size: 14px;
            box-sizing: border-box;
        }

        button.primary {
            background: var(--p);
            color: white;
            border: none;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            padding: 14px;
            border-radius: 12px;
            font-size: 16px;
            margin-top: 10px;
        }

        .fixed-box {
            background: #f1f5f9;
            padding: 15px;
            border-radius: 10px;
            font-weight: bold;
            color: #475569;
            text-align: center;
            border: 1px solid #cbd5e1;
        }

        /* ë¯¸ì…˜ ì‹¤í–‰ í™”ë©´ */
        .mission-item {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 10px;
            text-align: left;
            position: relative;
        }

        .mission-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .mission-name {
            font-weight: bold;
            font-size: 16px;
        }

        .mission-lv {
            font-size: 12px;
            color: #64748b;
            background: #f1f5f9;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .btn-action {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            border: 1px solid var(--p);
            background: white;
            color: var(--p);
            transition: 0.2s;
        }

            .btn-action.ing {
                background: #fff7ed;
                border: 2px solid orange;
                color: #d97706;
                animation: pulse 1.5s infinite;
            }

            .btn-action.done {
                background: #f1f5f9;
                color: #94a3b8;
                border: 1px solid #e2e8f0;
                cursor: pointer;
            }

            .btn-action:disabled {
                opacity: 0.4;
                cursor: not-allowed;
                background: #f1f5f9;
                border-color: #cbd5e1;
                color: #94a3b8;
            }

        .live-timer {
            font-size: 26px;
            font-weight: 900;
            color: #d97706;
            text-align: center;
            margin: 10px 0;
            letter-spacing: 2px;
        }

        .schedule-block {
            background: #f8fafc;
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            text-align: center;
            color: #475569;
            font-weight: bold;
            font-size: 15px;
        }

        #modal, #reflectionModal, #sinmungoModal, #adminModalOverlay, #adminTimeModal, #lateStartModal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-box {
            background: white;
            padding: 25px;
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
            text-align: center;
            box-sizing: border-box;
        }

        .hidden {
            display: none !important;
        }

        #refFeedback {
            font-size: 13px;
            font-weight: bold;
            padding: 5px;
            margin-top: 5px;
            border-radius: 5px;
            background: #f1f5f9;
        }

        .ref-easy {
            color: #10b981;
        }

        .ref-normal {
            color: #3b82f6;
        }

        .ref-hard {
            color: #ef4444;
        }

        #sinmungoBtn {
            position: absolute;
            top: 15px;
            left: 15px;
            font-size: 28px;
            cursor: pointer;
            background: white;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            line-height: 1;
        }

        #adminBtn {
            position: fixed;
            bottom: 15px;
            right: 15px;
            font-size: 18px;
            cursor: pointer;
            background: rgba(0,0,0,0.1);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: none;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            line-height: 1;
            z-index: 999;
        }
    </style>
</head>
<body>

    <div id="view-dashboard" class="view active container">
        <button id="sinmungoBtn" onclick="openSinmungo()">ğŸ“©</button>
        <button id="adminBtn" onclick="openAdminModal()">âš™ï¸</button>

        <div class="lds-header"><div class="lds-logo-text">LIFE DESIGN STUDIO</div><h1 class="lds-main-title">LDS ì‚¬ì› ì•±</h1><p id="todayDate" class="lds-date"></p></div>

        <div id="topNoticeBar"></div>

        <div class="race-card" id="raceWidget" style="display: none;">
            <h3 class="race-title">ğŸ† ì´ë²ˆ ì£¼ ì‹¤ì  ë ˆì´ìŠ¤ <span class="race-goal">ëª©í‘œ 52ë§Œ ì›</span></h3>
            <div class="race-track" id="raceTrackArea">
                <div class="finish-line"></div>
            </div>
        </div>

        <div id="adminPanel" class="hidden" style="background: #1e293b; color: white; padding: 15px; border-radius: 15px; margin-bottom: 20px; display: flex; flex-direction: column; align-items: center; gap: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
            <div style="font-weight:bold; color:#fbbf24;">ğŸ”§ ê´€ë¦¬ì íƒ€ì„ë¨¸ì‹ </div>
            <div style="display: flex; gap: 5px; width: 100%; justify-content: center;">
                <input type="date" id="simDateInput" style="width:auto; padding:8px; border-radius:8px;">
                <button onclick="applySimDate()" style="background:var(--p); color:white; border:none; padding:8px 15px; border-radius:8px; font-weight:bold; cursor:pointer;">ì´ë™</button>
            </div>
            <button onclick="exitAdmin()" style="background:#475569; color:white; border:none; padding:8px 15px; border-radius:8px; width:100%; cursor:pointer;">ê´€ë¦¬ì ëª¨ë“œ ì¢…ë£Œ</button>
        </div>

        <div class="card user-card" onclick="checkUser('S01','ê°•íƒœìœ¤')"><div class="avatar">ğŸ‘¨â€ğŸ’¼</div><div class="user-info"><h2 class="user-name">ê°•íƒœìœ¤ ì£¼ì„</h2></div></div>
        <div class="card user-card" onclick="checkUser('S02','ê¹€ëŒ€ì¤‘')"><div class="avatar">ğŸ‘¨â€ğŸ’¼</div><div class="user-info"><h2 class="user-name">ê¹€ëŒ€ì¤‘ ì‚¬ì›</h2></div></div>
        <div class="card user-card" onclick="checkUser('S03','ìµœì›ì¤€')"><div class="avatar">ğŸ‘¨â€ğŸ’¼</div><div class="user-info"><h2 class="user-name">ìµœì›ì¤€ ëŒ€ë¦¬</h2></div></div>
        <div class="card user-card" onclick="checkUser('S04','ì´ë¡œìš´')"><div class="avatar">ğŸ‘¨â€ğŸ’¼</div><div class="user-info"><h2 class="user-name">ì´ë¡œìš´ ì¸í„´</h2></div></div>
        <div class="card user-card" onclick="checkUser('S05','ìµœíƒœë¯¼')"><div class="avatar">ğŸ‘¨â€ğŸ’¼</div><div class="user-info"><h2 class="user-name">ìµœíƒœë¯¼ ì¸í„´</h2></div></div>
    </div>

    <div id="view-plan" class="view container">
        <div class="card">
            <h2 style="color:#1e293b; margin-top:0;">ğŸ“‹ ì—…ë¬´ ê³„íš ìˆ˜ë¦½</h2>
            <div id="planContainer"></div>
            <button class="primary" onclick="savePlan()">ê³„íš ì œì¶œí•˜ê¸°</button>
            <button onclick="goHome()" style="background:white; color:#64748b; width:100%; padding:10px; border:none; margin-top:10px; cursor:pointer;">ì·¨ì†Œ</button>
        </div>
    </div>

    <div id="view-mission" class="view container">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h2 id="missionTitle" style="font-size:18px; margin:0;"></h2>
            <button onclick="editPlan()" style="background:white; border:1px solid #cbd5e1; padding:5px 10px; border-radius:8px; font-size:13px; font-weight:bold; color:#4f46e5;">âœï¸ ê³„íš ìˆ˜ì •</button>
            <button onclick="goHome()" style="background:#f1f5f9; border:none; padding:5px 10px; border-radius:8px; font-size:13px; margin-left:5px;">ë‚˜ê°€ê¸°</button>
        </div>
        <div id="missionList"></div>
    </div>

    <div id="reflectionModal"><div class="modal-box"><h3>ğŸ“ í–‰ì‚¬ ì†Œê°ë¬¸</h3><input type="text" id="eventNameInput" placeholder="í–‰ì‚¬ëª…" readonly style="background:#f1f5f9; text-align:center; font-weight:bold; margin-bottom:10px;"><textarea id="reflectionText" rows="6" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..." oninput="checkRefLen()"></textarea><div id="refFeedback">EASY (0ì)</div><button id="btnRefSubmit" class="primary" onclick="submitReflection()">ì™„ë£Œí•˜ê¸°</button><button onclick="document.getElementById('reflectionModal').style.display='none'" style="margin-top:10px; background:none; border:none; color:#666;">ì·¨ì†Œ</button></div></div>
    <div id="sinmungoModal"><div class="modal-box"><h3>ğŸ“© LDS ì‹ ë¬¸ê³ </h3><input type="text" id="smNick" placeholder="ë‹‰ë„¤ì„ (ìµëª… ê°€ëŠ¥)"><textarea id="smContent" rows="5" placeholder="ê±´ì˜ì‚¬í•­ì„ ì ì–´ì£¼ì„¸ìš”."></textarea><button onclick="submitSinmungo()" class="primary">ë³´ë‚´ê¸°</button><button onclick="document.getElementById('sinmungoModal').style.display='none'" style="margin-top:10px; background:none; border:none; color:#666;">ë‹«ê¸°</button></div></div>
    <div id="lateStartModal"><div class="modal-box"><h3>â³ ëŠ¦ì€ ì‹œì‘</h3><div style="display:flex; gap:5px; justify-content:center; margin:15px 0;"><input type="time" id="lateStartT"> ~ <input type="time" id="lateEndT"></div><button onclick="submitLateStart()" class="primary">ì…ë ¥ ì™„ë£Œ</button><button onclick="document.getElementById('lateStartModal').style.display='none'" style="margin-top:10px; background:none; border:none; color:#666;">ì·¨ì†Œ</button></div></div>
    <div id="adminModalOverlay"><div class="modal-box"><h3>ğŸ”’ ê´€ë¦¬ì ì¸ì¦</h3><input type="password" id="adminPw" placeholder="ë¹„ë°€ë²ˆí˜¸"><button onclick="checkAdminPw()" class="primary" style="margin-top:10px;">í™•ì¸</button><button onclick="document.getElementById('adminModalOverlay').style.display='none'" style="margin-top:10px; border:none; background:none;">ì·¨ì†Œ</button></div></div>
    <div id="adminTimeModal"><div class="modal-box"><h3>â° ì‹œê°„ ì…ë ¥ (ê´€ë¦¬ì ê¶Œí•œ)</h3><input type="time" id="admStart" style="margin-bottom:10px;"> ~ <input type="time" id="admEnd" style="margin-bottom:10px;"><button onclick="finishAdminMission()" class="primary" style="margin-top:10px;">ê°•ì œ ì™„ë£Œ ì²˜ë¦¬</button><button onclick="document.getElementById('adminTimeModal').style.display='none'" style="margin-top:10px; border:none; background:none;">ì·¨ì†Œ</button></div></div>

    <script>
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzUggqi6Wugy1SfMwak8eJYut0t2M2XGwvn15GcKNQlTNHIwE6B4EAOD5mos5pMAIp33Q/exec";

        const NO_LEVEL_LIST = ["ìŒì•…", "ê²€ì •ê³ ì‹œ", "SCLì±…ë ¥", "ì‹¬í™”ê³µë¶€", "êµë¥˜ìˆ˜ì—…", "ì˜¤í›„í™œë™", "ë§ì¶¤í•™ìŠµ", "ì˜ˆë°°", "ì¶•êµ¬"];
        const LIST_AUTO_SELECT = ["ìš´ë™", "ì˜ì–´íšŒí™”", "ê¸€ì”¨ì—°ìŠµ", "ì»´í“¨í„°"];
        const LIST_CHOICE = ["ê²€ì •ê³ ì‹œ", "ìŒì•…", "SCLì±…ë ¥", "ì‹¬í™”ê³µë¶€", "êµë¥˜ìˆ˜ì—…"];
        const MAX_GOAL = 520000;

        let appDate = new Date(); let curId, curName; let currentScheduleData = null; let currentLogs = {};
        let currentEventMission = null; let curLateMission = null; let curLateLevel = null; let isAdminMode = false; let curM;
        let timerInterval = null;

        document.addEventListener("DOMContentLoaded", () => {
            renderDate();
            fetch(WEB_APP_URL, { method: "POST", body: JSON.stringify({ action: "getActiveNotices" }) }).then(r => r.json()).then(res => {
                if (res.notices && res.notices.length > 0) {
                    const bar = document.getElementById('topNoticeBar');
                    bar.style.display = 'flex';
                    let html = "";
                    res.notices.forEach(n => {
                        let dateMatch = n.match(/^\[(.*?)\] (.*)$/);
                        if (dateMatch) html += `<div class="notice-banner"><span class="n-date">${dateMatch[1]}</span><span>ğŸ“¢ ${dateMatch[2]}</span></div>`;
                        else html += `<div class="notice-banner">ğŸ“¢ ${n}</div>`;
                    });
                    bar.innerHTML = html;
                }
            });
            loadRaceBoard();
        });

        function loadRaceBoard() {
            fetch(WEB_APP_URL, { method: "POST", body: JSON.stringify({ action: "getWeeklyRank", date: getAppDateStr() }) })
                .then(r => r.json()).then(res => {
                    if (res.ok && res.rank) {
                        const track = document.getElementById('raceTrackArea');
                        document.getElementById('raceWidget').style.display = 'block';
                        let html = `<div class="finish-line"></div>`;

                        const sList = [
                            { id: 'S01', name: 'ê°•íƒœìœ¤ ì£¼ì„', icon: 'ğŸ’€' },
                            { id: 'S02', name: 'ê¹€ëŒ€ì¤‘ ì‚¬ì›', icon: 'ğŸ”«' },
                            { id: 'S03', name: 'ìµœì›ì¤€ ëŒ€ë¦¬', icon: 'ğŸ’»' },
                            { id: 'S04', name: 'ì´ë¡œìš´ ì¸í„´', icon: 'ğŸ' },
                            { id: 'S05', name: 'ìµœíƒœë¯¼ ì¸í„´', icon: 'ğŸš²' }
                        ];

                        sList.forEach(s => {
                            let money = res.rank[s.id] || 0;
                            let percent = Math.min(100, (money / MAX_GOAL) * 100);
                            let visualWidth = percent * 0.9;

                            html += `
                    <div class="lane lane-${s.id}">
                        <div class="lane-info">
                            <span class="runner-name">${s.name}</span>
                            <span class="runner-money">â‚©${money.toLocaleString()}</span>
                        </div>
                        <div class="track-bg">
                            <div class="runner-bar" style="width:0%;" data-width="${visualWidth}%">
                                <div class="runner-icon">${s.icon}</div>
                            </div>
                        </div>
                    </div>`;
                        });
                        track.innerHTML = html;
                        setTimeout(() => { document.querySelectorAll('.runner-bar').forEach(b => { b.style.width = b.getAttribute('data-width'); }); }, 300);
                    }
                });
        }

        function renderDate() { const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ']; document.getElementById('todayDate').innerText = `${appDate.toLocaleDateString()} (${days[appDate.getDay()]})`; }
        function getAppDateStr() { const offset = appDate.getTimezoneOffset() * 60000; return new Date(appDate.getTime() - offset).toISOString().slice(0, 10); }
        function showView(id) { document.querySelectorAll('.view').forEach(v => v.classList.remove('active')); document.getElementById(id).classList.add('active'); }
        function goHome() { showView('view-dashboard'); loadRaceBoard(); }

        function checkUser(id, name) {
            curId = id; curName = name;
            fetch(WEB_APP_URL, { method: "POST", body: JSON.stringify({ action: "checkSchedule", id: id, date: getAppDateStr() }) }).then(r => r.json()).then(res => {
                currentLogs = res.logs || {};
                if (res.hasSchedule) {
                    currentScheduleData = res.data; renderMissions(res.data); showView('view-mission'); document.getElementById('missionTitle').innerText = `${name} ì‚¬ì› (${getAppDateStr()})`;
                } else {
                    generatePlanForm(); showView('view-plan');
                }
            });
        }

        function editPlan() { generatePlanForm(); showView('view-plan'); }

        // [â˜…ìˆ˜ì •] ëª¨ë“  ìš”ì¼ì˜ ë¸”ë¡ì„ 2ê°œ(ì˜¤ì „, ì˜¤í›„)ë¡œ í†µì¼
        function generatePlanForm() {
            const container = document.getElementById('planContainer');
            container.innerHTML = "";
            const day = appDate.getDay();

            // ëª¨ë“  ìš”ì¼ì€ 15ì‹œì— ì¢…ë£Œë˜ë¯€ë¡œ ë¸”ë¡ì€ 2ê°œì…ë‹ˆë‹¤.
            const blocks = [
                { id: "b1", time: "09:00 ~ 12:00", label: "ì˜¤ì „ í™œë™" },
                { id: "b2", time: "13:00 ~ 15:00", label: (day === 4) ? "ì˜¤í›„ 1ë¶€" : "ì˜¤í›„ í™œë™" }
            ];

            blocks.forEach((b, idx) => {
                const div = document.createElement('div'); div.className = "time-block";
                let isFixed = false; let fixedText = ""; let fixedValue = "";

                // ëª©ìš”ì¼ ì˜¤ì „ ê³ ì •
                if (day === 4 && idx === 0) { isFixed = true; fixedText = "âš½ ì˜¤ì „ ì¶•êµ¬ ìˆ˜ì—… (09:30 ~ 12:00)"; fixedValue = "ì¶•êµ¬"; }
                // ê¸ˆìš”ì¼ ì˜¤í›„ ê³ ì •
                if (day === 5 && idx === 1) { isFixed = true; fixedText = "ğŸ™ ì˜ˆë°° ë° ìš°ë¦¬ë‹¤ì›€ (13:00 ~ 15:00)"; fixedValue = "ì˜ˆë°°"; }

                let html = `<div class="time-title"><span>ğŸ•°ï¸ ${b.time}</span><span style="font-size:12px;color:#64748b;">${b.label}</span></div>`;

                if (isFixed) {
                    html += `<div class="fixed-box">${fixedText}</div>
                         <input type="hidden" id="type_${b.id}" value="fixed">
                         <input type="hidden" id="m1_${b.id}" value="${fixedValue}">`;
                } else {
                    html += `
                <div class="cat-selector" id="cat_${b.id}">
                    <div class="cat-btn active" onclick="setCat('${b.id}', 'auto', this)">ììœ¨ ë¯¸ì…˜</div>
                    <div class="cat-btn" onclick="setCat('${b.id}', 'choice', this)">ì„ íƒ ë¯¸ì…˜</div>
                    <div class="cat-btn" onclick="setCat('${b.id}', 'event', this)">ğŸ‰ í–‰ì‚¬</div>
                </div>
                <input type="hidden" id="type_${b.id}" value="auto">
                <div id="area_${b.id}">${renderAutoRows(b.id)}</div>`;
                }
                div.innerHTML = html; container.appendChild(div);
            });
        }

        function setCat(bid, type, btn) {
            const parent = document.getElementById(`cat_${bid}`);
            Array.from(parent.children).forEach(c => c.classList.remove('active')); btn.classList.add('active');
            document.getElementById(`type_${bid}`).value = type;
            const area = document.getElementById(`area_${bid}`);
            if (type === 'auto') area.innerHTML = renderAutoRows(bid);
            else if (type === 'choice') area.innerHTML = renderChoiceRows(bid);
            else if (type === 'event') area.innerHTML = `<div class="fixed-box" style="background:#fff7ed; color:#d97706; border-color:#fdba74;">ğŸ‰ ì´ ì‹œê°„ì€ ì „ì²´ í–‰ì‚¬ë¡œ ì§„í–‰ë©ë‹ˆë‹¤.</div>`;
        }

        function renderAutoRows(bid) {
            const lvOpts = `<option>NORMAL</option><option>EASY</option><option>HARD</option>`;
            const selectOpts = LIST_AUTO_SELECT.map(i => `<option value="${i}">${i}</option>`).join('');
            return `
        <div class="mission-row"><div class="fixed-label">âœï¸ ê¸€ì“°ê¸°</div><select id="l1_${bid}">${lvOpts}</select><input type="hidden" id="m1_${bid}" value="ê¸€ì“°ê¸°"></div>
        <div class="mission-row"><div class="fixed-label">ğŸ“š ë…ì„œ</div><select id="l2_${bid}">${lvOpts}</select><input type="hidden" id="m2_${bid}" value="ë…ì„œ"></div>
        <div class="mission-row"><div class="fixed-label">ğŸ“– ìì„œì „</div><select id="l3_${bid}">${lvOpts}</select><input type="hidden" id="m3_${bid}" value="ìì„œì „"></div>
        <div class="mission-row"><select id="m4_${bid}">${selectOpts}</select><select id="l4_${bid}">${lvOpts}</select></div>
        <div class="mission-row"><select id="m5_${bid}">${selectOpts}</select><select id="l5_${bid}">${lvOpts}</select></div>`;
        }

        function renderChoiceRows(bid) { const selectOpts = LIST_CHOICE.map(i => `<option value="${i}">${i}</option>`).join(''); return `<div class="mission-row"><select id="m1_${bid}">${selectOpts}</select></div>`; }

        function savePlan() {
            let data = { action: "saveSchedule", id: curId, date: getAppDateStr(), dayStr: ["ì¼", "ì›”", "í™”", "ìˆ˜", "ëª©", "ê¸ˆ", "í† "][appDate.getDay()] };
            const dbSlots = [
                { n: 'm1n', l: 'm1l' }, { n: 'm2n', l: 'm2l' }, { n: 'm3n', l: 'm3l' },
                { n: 'c1an', l: 'c1al' }, { n: 'c1bn', l: 'c1bl' }, { n: 'c2n', l: 'c2l' }, { n: 'c3n', l: 'c3l' }
            ];
            let slotIdx = 0;

            // ë¸”ë¡ì´ b1, b2 ë‘ ê°œë§Œ ì¡´ì¬í•˜ë¯€ë¡œ ì•ˆì „í•˜ê²Œ ë§¤í•‘ë©ë‹ˆë‹¤.
            const mapBlock = (bid) => {
                const typeEl = document.getElementById(`type_${bid}`);
                if (!typeEl) return;

                const type = typeEl.value;
                if (type === 'fixed' || type === 'event') {
                    if (slotIdx < 7) { data[dbSlots[slotIdx].n] = (type === 'fixed') ? document.getElementById(`m1_${bid}`).value : "í–‰ì‚¬"; slotIdx++; }
                } else if (type === 'auto') {
                    const items = [{ n: "ê¸€ì“°ê¸°", l: document.getElementById(`l1_${bid}`).value }, { n: "ë…ì„œ", l: document.getElementById(`l2_${bid}`).value }, { n: "ìì„œì „", l: document.getElementById(`l3_${bid}`).value }, { n: document.getElementById(`m4_${bid}`).value, l: document.getElementById(`l4_${bid}`).value }, { n: document.getElementById(`m5_${bid}`).value, l: document.getElementById(`l5_${bid}`).value }];
                    items.forEach(item => { if (slotIdx < 7) { data[dbSlots[slotIdx].n] = item.n; if (dbSlots[slotIdx].l) data[dbSlots[slotIdx].l] = item.l; slotIdx++; } });
                } else if (type === 'choice') {
                    if (slotIdx < 7) { data[dbSlots[slotIdx].n] = document.getElementById(`m1_${bid}`).value; slotIdx++; }
                }
            };
            mapBlock('b1'); mapBlock('b2');

            fetch(WEB_APP_URL, { method: "POST", body: JSON.stringify(data) });
            alert("ê³„íšì´ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤.");
            currentScheduleData = {
                day: data.dayStr,
                m1: { n: data.m1n, l: data.m1l }, m2: { n: data.m2n, l: data.m2l }, m3: { n: data.m3n, l: data.m3l },
                c1a: { n: data.c1an, l: data.c1al }, c1b: { n: data.c1bn, l: data.c1bl }, c2: { n: data.c2n, l: data.c2l }, c3: { n: data.c3n, l: data.c3l }
            };
            renderMissions(currentScheduleData); showView('view-mission');
        }

        function renderMissions(d) {
            const list = document.getElementById('missionList'); list.innerHTML = "";
            const lifeLog = currentLogs["ìƒí™œë¯¸ì…˜"]; let lifeSt = "ë¯¸ì™„ë£Œ", imgH = "", msgH = "";
            if (lifeLog) { if (lifeLog.status === 'life_ok') lifeSt = "âœ… í™•ì¸ë¨"; else if (lifeLog.status === 'fail') lifeSt = "âŒ ì‹¤íŒ¨"; if (lifeLog.photo) imgH = `<img src="${lifeLog.photo}" class="proof-photo" onclick="window.open(this.src)">`; if (lifeLog.message) msgH = `<div class="teacher-msg">ğŸ“¢ ${lifeLog.message}</div>`; }
            list.innerHTML += `<div class="mission-item" style="border-left:5px solid #f59e0b; background:#fffbeb;"><div class="mission-header"><span class="mission-name">ğŸŒ ìƒí™œë¯¸ì…˜</span><span class="mission-lv">${lifeSt}</span></div>${imgH}${msgH}</div>`;

            const slots = [d.m1, d.m2, d.m3, d.c1a, d.c1b, d.c2, d.c3];
            slots.forEach(t => {
                if (!t || !t.n) return;
                if (t.n === 'ì¶•êµ¬' || t.n === 'ì˜ˆë°°') {
                    list.innerHTML += `<div class="schedule-block">${t.n === 'ì¶•êµ¬' ? 'âš½' : 'ğŸ™'} ${t.n} <span style="font-size:11px; font-weight:normal;">(ê³ ì • ì¼ì •)</span></div>`;
                }
                else if (t.n === 'í–‰ì‚¬') {
                    renderEventCard(list, "ğŸ‰ í–‰ì‚¬", "í–‰ì‚¬");
                }
                else {
                    renderItem(list, t);
                }
            });
        }

        function renderItem(container, t) {
            if (!t || !t.n) return;

            const serverLog = currentLogs[t.n];
            const isDone = serverLog && (serverLog.status === 'end' || serverLog.status === 'ok' || serverLog.status === 'gong');
            const isStart = serverLog && serverLog.status === 'start';
            const isAnyRunning = Object.values(currentLogs).some(l => l.status === 'start');
            const lvDisplay = NO_LEVEL_LIST.includes(t.n) ? "-" : (t.l || "-");

            const div = document.createElement('div'); div.className = "mission-item";
            let btns = "";

            if (isAdminMode) {
                let stateTxt = isDone ? "ìˆ˜ì •" : "ê°•ì œ ì™„ë£Œ";
                btns = `<button class="btn-action" style="border:1px solid red; color:red;" onclick="handleMission('${t.n}','${t.l}')">ğŸ›  ${stateTxt}(ê´€ë¦¬ì)</button>`;
            } else {
                if (isDone) {
                    let btnText = serverLog.status === 'gong' ? "âœ… ê³µê²°" : "âœ… ì™„ë£Œë¨";
                    btns = `<button class="btn-action done" disabled>${btnText}</button>`;
                } else if (isStart) {
                    btns = `<div class="live-timer" id="timer-${t.n}">00:00:00</div><button class="btn-action ing" onclick="handleMission('${t.n}','${t.l}')">ğŸ”¥ ì™„ë£Œí•˜ê¸°</button>`;
                    startTimer(t.n);
                } else {
                    let disabledAttr = isAnyRunning ? "disabled" : "";
                    btns = `<div style="display:flex; gap:5px;">
                          <button class="btn-action" onclick="handleMission('${t.n}','${t.l}')" ${disabledAttr}>ì‹œì‘</button>
                          <button class="btn-action" style="background:#f1f5f9; color:#64748b; font-size:13px; border:1px solid #cbd5e1;" onclick="openLateStart('${t.n}','${t.l}')" ${disabledAttr}>ëŠ¦ì€ ì‹œì‘</button>
                        </div>`;
                }
            }
            div.innerHTML = `<div class="mission-header"><span class="mission-name">${t.n}</span><span class="mission-lv">${lvDisplay}</span></div>${btns}`;
            container.appendChild(div);
        }

        function renderEventCard(container, name, keyName) {
            const log = currentLogs[keyName]; const isDone = log && (log.status === 'end' || log.status === 'gong');
            if (document.getElementById(`evt_${keyName}`)) return;
            const div = document.createElement('div'); div.className = "mission-item"; div.id = `evt_${keyName}`;
            let btnText = isDone ? "âœ… ì™„ë£Œë¨" : "ğŸ“ ì†Œê°ë¬¸ ì‘ì„±";
            div.innerHTML = `<div class="mission-header"><span class="mission-name">${name}</span></div><button class="btn-action ${isDone ? 'done' : ''}" onclick="openReflectionModal('${name}','${keyName}')" ${isDone ? 'disabled' : ''}>${btnText}</button>`;
            container.appendChild(div);
        }

        function openReflectionModal(name, key) { currentEventMission = key; document.getElementById('eventNameInput').value = name; document.getElementById('reflectionText').value = ""; document.getElementById('reflectionModal').style.display = 'flex'; }
        function checkRefLen() { const len = document.getElementById('reflectionText').value.length; let t = "EASY"; if (len >= 200) t = "HARD"; else if (len >= 100) t = "NORMAL"; document.getElementById('refFeedback').innerText = `${t} (${len}ì)`; }
        function submitReflection() {
            const txt = document.getElementById('reflectionText').value; if (txt.length < 1) return alert("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”");
            let diff = "EASY"; if (txt.length >= 200) diff = "HARD"; else if (txt.length >= 100) diff = "NORMAL";
            fetch(WEB_APP_URL, { method: "POST", body: JSON.stringify({ action: "saveEventReflection", student_id: curId, student_name: curName, eventName: document.getElementById('eventNameInput').value, mission_id: "í–‰ì‚¬", date: getAppDateStr(), difficulty: diff, content: txt }) });
            currentLogs["í–‰ì‚¬"] = { status: 'end' }; renderMissions(currentScheduleData); document.getElementById('reflectionModal').style.display = 'none';
        }

        function handleMission(name, level) {
            const key = `${curId}_active_${getAppDateStr()}`; const serverLog = currentLogs[name];

            if (isAdminMode) {
                curM = name;
                curLateLevel = level;
                document.getElementById('adminTimeModal').style.display = 'flex';
                return;
            }

            if (!serverLog || serverLog.status !== 'start') {
                if (Object.values(currentLogs).some(l => l.status === 'start')) return alert("ì´ë¯¸ ì§„í–‰ ì¤‘ì¸ ì—…ë¬´ê°€ ìˆìŠµë‹ˆë‹¤!");
                currentLogs[name] = { status: 'start' }; localStorage.setItem(`${key}_start`, Date.now());
                fetch(WEB_APP_URL, { method: "POST", body: JSON.stringify({ action: "saveLog", subAction: "start", student_id: curId, mission_id: name, date: getAppDateStr(), note: "Start" }) });
                renderMissions(currentScheduleData);
            } else {
                if (!confirm("ì™„ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
                const st = parseInt(localStorage.getItem(`${key}_start`)); const endT = Date.now(); let note = "ì™„ë£Œ";
                if (st) { const diff = Math.round((endT - st) / 60000); const sTime = new Date(st).toTimeString().slice(0, 5); const eTime = new Date(endT).toTimeString().slice(0, 5); note = `${sTime}~${eTime} (${diff}ë¶„)`; }
                currentLogs[name] = { status: 'end' };
                fetch(WEB_APP_URL, { method: "POST", body: JSON.stringify({ action: "saveLog", subAction: "end", student_id: curId, mission_id: name, date: getAppDateStr(), difficulty: level, note: note }) });
                renderMissions(currentScheduleData);
            }
        }

        function openLateStart(name, level) { curLateMission = name; curLateLevel = level; document.getElementById('lateStartModal').style.display = 'flex'; }
        function submitLateStart() {
            const s = document.getElementById('lateStartT').value; const e = document.getElementById('lateEndT').value;
            if (!s || !e) return alert("ì‹œê°„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”");
            const note = `${s}~${e} (ìˆ˜ë™)`;
            fetch(WEB_APP_URL, { method: "POST", body: JSON.stringify({ action: "saveLog", subAction: "end", student_id: curId, mission_id: curLateMission, date: getAppDateStr(), difficulty: curLateLevel, note: note }) });
            currentLogs[curLateMission] = { status: 'end' }; alert("ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤."); document.getElementById('lateStartModal').style.display = 'none'; renderMissions(currentScheduleData);
        }

        function startTimer(name) {
            if (timerInterval) clearInterval(timerInterval);
            const key = `${curId}_active_${getAppDateStr()}`; let st = parseInt(localStorage.getItem(`${key}_start`)); if (!st) st = Date.now();
            timerInterval = setInterval(() => {
                const diff = Math.floor((Date.now() - st) / 1000); const h = String(Math.floor(diff / 3600)).padStart(2, '0'); const m = String(Math.floor((diff % 3600) / 60)).padStart(2, '0'); const s = String(diff % 60).padStart(2, '0');
                const el = document.getElementById(`timer-${name}`); if (el) el.innerText = `${h}:${m}:${s}`;
            }, 1000);
        }

        function openSinmungo() { document.getElementById('sinmungoModal').style.display = 'flex'; }
        function submitSinmungo() { fetch(WEB_APP_URL, { method: "POST", body: JSON.stringify({ action: "saveSinmungo", nickname: document.getElementById('smNick').value, content: document.getElementById('smContent').value }) }); alert("ì „ì†¡ë¨"); document.getElementById('sinmungoModal').style.display = 'none'; }

        function openAdminModal() { document.getElementById('adminModalOverlay').style.display = 'flex'; }
        function checkAdminPw() {
            if (document.getElementById('adminPw').value === "1q2w3e4r!@") {
                isAdminMode = true;
                document.getElementById('adminModalOverlay').style.display = 'none';
                document.getElementById('adminBtn').style.display = 'none';
                document.getElementById('adminPanel').classList.remove('hidden');
                document.getElementById('simDateInput').value = getAppDateStr();
                if (currentScheduleData) renderMissions(currentScheduleData);
            } else { alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤."); }
        }

        function finishAdminMission() {
            const s = document.getElementById('admStart').value;
            const e = document.getElementById('admEnd').value;
            fetch(WEB_APP_URL, {
                method: "POST",
                body: JSON.stringify({
                    action: "saveLog", subAction: "end", student_id: curId, mission_id: curM,
                    date: getAppDateStr(), difficulty: curLateLevel || "NORMAL", note: `${s}~${e} (ê´€ë¦¬ì)`
                })
            }).then(() => {
                alert("ê´€ë¦¬ì ê¶Œí•œìœ¼ë¡œ ì™„ë£Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
                document.getElementById('adminTimeModal').style.display = 'none';
                checkUser(curId, curName);
            });
        }

        function applySimDate() {
            appDate = new Date(document.getElementById('simDateInput').value);
            renderDate();
            goHome();
        }

        function exitAdmin() {
            isAdminMode = false;
            document.getElementById('adminPanel').classList.add('hidden');
            document.getElementById('adminBtn').style.display = 'flex';
            appDate = new Date();
            renderDate();
            if (curId) checkUser(curId, curName); else goHome();
        }
    </script>
</body>
</html>