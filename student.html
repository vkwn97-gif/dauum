<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ë‹¤ì›€í•™êµ ë¯¸ì…˜ ì„¼í„°</title>
  <style>
    :root { --p1: #3b82f6; --p2: #10b981; --p3: #f59e0b; --bg: #f8fafc; }
    body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 20px; }
    .main-title { text-align: center; font-weight: 900; font-size: 24px; margin-bottom: 20px; color: #1e293b; }
    
    /* í•™ìƒ ì„ íƒ ì¹´ë“œ ë ˆì´ì•„ì›ƒ */
    .student-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }
    .student-card {
      background: white; border-radius: 20px; padding: 20px; text-align: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05); cursor: pointer; transition: 0.2s;
    }
    .student-card:active { transform: scale(0.95); }
    .student-card h2 { margin: 10px 0; font-size: 20px; }
    .status-dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; background: #ccc; margin-right: 5px; }
    .status-dot.active { background: var(--p2); box-shadow: 0 0 8px var(--p2); }

    /* ë¯¸ì…˜ ìˆ˜í–‰ íŒì—…/ë ˆì´ì–´ */
    #missionOverlay {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5); justify-content: center; align-items: center;
    }
    .popup {
      background: white; width: 90%; max-width: 400px; padding: 25px;
      border-radius: 30px; position: relative;
    }
    .close-btn { position: absolute; top: 20px; right: 20px; font-size: 24px; cursor: pointer; border: none; background: none; }
    
    .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 20px; }
    .circle-btn { aspect-ratio: 1/1; border-radius: 50%; border: none; color: white; font-weight: 800; font-size: 20px; cursor: pointer; }
    .start { background: var(--p1); }
    .end { background: var(--p2); }
    select { width: 100%; padding: 12px; margin: 8px 0; border-radius: 10px; border: 1px solid #ddd; }
  </style>
</head>
<body>

<div class="main-title">ì˜¤ëŠ˜ì˜ ë¯¸ì…˜ ëŒ€ì‹œë³´ë“œ</div>

<div class="student-grid" id="studentGrid">
  </div>

<div id="missionOverlay">
  <div class="popup">
    <button class="close-btn" onclick="closePopup()">Ã—</button>
    <h1 id="popName" style="color:var(--p1)">í•™ìƒì´ë¦„</h1>
    <p id="popStatus" style="font-size:14px; color:#666;">ë¯¸ì…˜ì„ ì„ íƒí•˜ì„¸ìš”</p>
    
    <label>ìˆ˜ì—… ì„ íƒ</label>
    <select id="mSelect"></select>
    
    <label>ë‚œì´ë„</label>
    <select id="dSelect" disabled></select>

    <div class="btn-group">
      <button id="sBtn" class="circle-btn start" onclick="doStart()">ì‹œì‘</button>
      <button id="eBtn" class="circle-btn end" onclick="doEnd()" disabled>ì™„ë£Œ</button>
    </div>
  </div>
</div>

<script>
  const WEB_APP_URL = "https://script.google.com/macros/s/AKfycby92ELezN4OuXTau2V-6SpcMaRj23WYsUlNGY4f8r7FLKm_LAj-IOVAKm2zQpG9h0Jq/exec";
  const STUDENT_TOKEN = "STUDENT_1234";

// ğŸ”´ ëª…ë‹¨ ìˆœì„œ ë³€ê²½: ê°•íƒœìœ¤, ê¹€ëŒ€ì¤‘, ìµœì›ì¤€
  let studentStates = {
    "S01": { name: "ê°•íƒœìœ¤", startTime: null, attemptId: "", mId: "", d: "", active: false },
    "S02": { name: "ê¹€ëŒ€ì¤‘", startTime: null, attemptId: "", mId: "", d: "", active: false },
    "S03": { name: "ìµœì›ì¤€", startTime: null, attemptId: "", mId: "", d: "", active: false }
  };
 
  
  let currentId = ""; // í˜„ì¬ íŒì—…ì— ë– ìˆëŠ” í•™ìƒ ID
  let missionsMap = {};

  window.onload = async () => {
    renderCards();
    await loadMissions();
  };

  // ì¹´ë“œ ê·¸ë¦¬ê¸°
  function renderCards() {
    const grid = document.getElementById('studentGrid');
    grid.innerHTML = "";
    Object.keys(studentStates).forEach(id => {
      const s = studentStates[id];
      grid.innerHTML += `
        <div class="student-card" onclick="openPopup('${id}')">
          <div class="status-dot ${s.active ? 'active' : ''}"></div>
          <div style="font-size:40px">ğŸ‘¤</div>
          <h2>${s.name}</h2>
          <div style="font-size:12px; color:#888">${s.active ? 'ë¯¸ì…˜ ì§„í–‰ ì¤‘' : 'ëŒ€ê¸° ì¤‘'}</div>
        </div>
      `;
    });
  }

  async function loadMissions() {
    const res = await fetch(`${WEB_APP_URL}?action=missions&token=${STUDENT_TOKEN}`);
    const data = await res.json();
    data.missions.forEach(m => {
      if(!missionsMap[m.mission_name]) missionsMap[m.mission_name] = {};
      missionsMap[m.mission_name][m.difficulty] = m.mission_id;
    });
    
    const mSel = document.getElementById('mSelect');
    mSel.innerHTML = '<option value="">ìˆ˜ì—… ì„ íƒ</option>';
    Object.keys(missionsMap).sort().forEach(n => mSel.innerHTML += `<option value="${n}">${n}</option>`);
    mSel.onchange = onMChange;
  }

  function onMChange() {
    const dSel = document.getElementById('dSelect');
    const name = document.getElementById('mSelect').value;
    dSel.innerHTML = '<option value="">ë‚œì´ë„ ì„ íƒ</option>';
    if(!name) { dSel.disabled = true; return; }
    dSel.disabled = false;
    ["easy", "normal", "hard"].forEach(d => {
      if(missionsMap[name][d]) dSel.innerHTML += `<option value="${d}">${d.toUpperCase()}</option>`;
    });
  }

  function openPopup(id) {
    currentId = id;
    const s = studentStates[id];
    document.getElementById('popName').textContent = s.name;
    document.getElementById('missionOverlay').style.display = "flex";
    
    // ì´ í•™ìƒì˜ ê¸°ì¡´ ìƒíƒœ ë³µêµ¬
    document.getElementById('sBtn').disabled = s.active;
    document.getElementById('eBtn').disabled = !s.active;
    document.getElementById('mSelect').disabled = s.active;
    document.getElementById('dSelect').disabled = s.active;
    if(!s.active) document.getElementById('popStatus').textContent = "ìƒˆ ë¯¸ì…˜ì„ ì‹œì‘í•˜ì„¸ìš”.";
    else document.getElementById('popStatus').textContent = "ë¯¸ì…˜ì´ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤...";
  }

  function closePopup() { document.getElementById('missionOverlay').style.display = "none"; }

  function doStart() {
    const s = studentStates[currentId];
    const mName = document.getElementById('mSelect').value;
    const diff = document.getElementById('dSelect').value;
    if(!mName || !diff) return alert("ë¯¸ì…˜ê³¼ ë‚œì´ë„ë¥¼ ì„ íƒí•˜ì„¸ìš”.");

    s.active = true;
    s.startTime = Date.now();
    s.attemptId = currentId + "_" + s.startTime;
    s.mId = missionsMap[mName][diff];

    sendLog("start", s.attemptId, currentId, s.mId, `difficulty:${diff}`);
    renderCards();
    closePopup();
  }

  function doEnd() {
    const s = studentStates[currentId];
    const duration = Math.round((Date.now() - s.startTime) / 1000);

    sendLog("end", s.attemptId, currentId, s.mId, `duration:${duration}s`);
    
    s.active = false; // ìƒíƒœ í•´ì œ
    renderCards();
    closePopup();
  }

  function sendLog(val, attId, sId, mId, note) {
    fetch(WEB_APP_URL, {
      method: "POST",
      headers: { "Content-Type": "text/plain" },
      body: JSON.stringify({ token: STUDENT_TOKEN, attempt_id: attId, student_id: sId, mission_id: mId, value: val, note: note })
    });
  }
</script>
</body>
</html>