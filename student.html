<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë‹¤ì›€í•™êµ í•™ìƒì•±</title>
  <style>
    :root { --p: #4f46e5; --bg: #f8fafc; --card: #ffffff; --ok: #10b981; --fail: #ef4444; }
    body { font-family: 'Pretendard', sans-serif; background: var(--bg); padding: 15px; margin: 0; color:#333; }
    .view { display: none; } .view.active { display: block; animation: fadeIn 0.3s; }
    @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
    .container { max-width: 500px; margin: 0 auto; position: relative; }
    .card { background: var(--card); border-radius: 20px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 15px; text-align: center; }
    .user-card { cursor: pointer; transition: 0.2s; border: 1px solid transparent; }
    .user-card:active { transform: scale(0.98); border-color: var(--p); }
    .avatar { font-size: 40px; margin-bottom: 10px; display: block; }
    select, button { width: 100%; padding: 14px; border-radius: 12px; border: 1px solid #e2e8f0; margin-bottom: 10px; font-size: 16px; box-sizing: border-box; }
    button.primary { background: var(--p); color: white; border: none; font-weight: bold; cursor: pointer; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    label { font-size: 14px; font-weight: 800; color: var(--p); margin: 20px 0 10px; display: block; text-align: left; }
    .row { display: flex; gap: 8px; align-items: center; margin-bottom: 8px; }
    .fix-label { background: #f1f5f9; padding: 12px; border-radius: 12px; flex: 1; font-weight: bold; font-size: 15px; }
    .day-badge { display: inline-block; background: #e0e7ff; color: var(--p); padding: 5px 10px; border-radius: 20px; font-size: 13px; font-weight: bold; margin-bottom: 10px; }
    .mission-item { background: white; border: 1px solid #e2e8f0; border-radius: 15px; padding: 15px; margin-bottom: 10px; text-align: left; position: relative; }
    .mission-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
    .mission-name { font-weight: bold; font-size: 16px; }
    .mission-lv { font-size: 12px; color: #64748b; background: #f1f5f9; padding: 2px 6px; border-radius: 4px; }
    
    /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .btn-action { width: 100%; padding: 12px; border-radius: 10px; font-weight: bold; cursor: pointer; border: 1px solid var(--p); background: white; color: var(--p); transition: 0.2s; }
    .btn-action.ing { background: #fff7ed; border: 2px solid orange; color: #d97706; animation: pulse 1.5s infinite; }
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
    .btn-action.done { background: #f1f5f9; color: #94a3b8; border: 1px solid #e2e8f0; cursor: not-allowed; }
    /* ê´€ë¦¬ììš© ì™„ë£Œ ë²„íŠ¼ í™œì„±í™” */
    .btn-action.done.admin-active { cursor: pointer; border: 1px dashed #94a3b8; background: #f8fafc; color: #64748b; }
    .btn-action:disabled { opacity: 0.6; cursor: not-allowed; background: #f8fafc; border-color: #cbd5e1; color: #94a3b8; }
    .live-timer { font-size: 24px; font-weight: 800; color: #d97706; text-align: center; margin: 10px 0; display: none; }
    
    #adminBtn { position: absolute; top: 10px; right: 10px; font-size: 24px; cursor: pointer; background: none; border: none; z-index: 99; }
    #adminPanel { background: #1e293b; color: white; padding: 15px; border-radius: 15px; margin-bottom: 20px; display: flex; flex-direction: column; align-items: center; gap: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
    .admin-row { display: flex; gap: 5px; width: 100%; justify-content: center; }
    #adminModalOverlay, #adminTimeModal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; }
    #adminModalContent { background: white; width: 100%; max-width: 400px; border-radius: 20px; padding: 30px; box-sizing: border-box; text-align: center; margin: 20px; }
    .hidden { display: none !important; }
  </style>
</head>
<body>

<div id="view-dashboard" class="view active container">
  <button id="adminBtn" onclick="openAdminModal()">âš™ï¸</button>
  
  <div id="adminPanel" class="hidden">
    <div style="font-weight:bold; color:#fbbf24;">ğŸ”§ ê´€ë¦¬ì íƒ€ì„ë¨¸ì‹  ëª¨ë“œ</div>
    <div class="admin-row">
      <input type="date" id="simDateInput" style="padding:8px; border-radius:8px; border:none; width:auto;">
      <button onclick="applySimDate()" style="background:var(--p); color:white; border:none; padding:8px 15px; border-radius:8px; width:auto; margin:0;">ì´ë™</button>
    </div>
    <button onclick="exitAdmin()" style="background:#ef4444; color:white; border:none; padding:8px; border-radius:8px; width:100%; font-size:12px; margin:0;">ê´€ë¦¬ì ëª¨ë“œ ì¢…ë£Œ</button>
  </div>

  <div style="text-align:center; margin: 30px 0;">
    <h1 style="color:var(--p); margin:0;">ë‹¤ì›€í•™êµ</h1>
    <p id="todayDate" style="color:#64748b; margin:5px; font-weight:bold;"></p>
  </div>
  <div class="card user-card" onclick="checkUser('S01','ê°•íƒœìœ¤')"><span class="avatar">ğŸ‘¤</span><h2>ê°•íƒœìœ¤</h2></div>
  <div class="card user-card" onclick="checkUser('S02','ê¹€ëŒ€ì¤‘')"><span class="avatar">ğŸ‘¤</span><h2>ê¹€ëŒ€ì¤‘</h2></div>
  <div class="card user-card" onclick="checkUser('S03','ìµœì›ì¤€')"><span class="avatar">ğŸ‘¤</span><h2>ìµœì›ì¤€</h2></div>
</div>

<div id="view-plan" class="view container">
  <div class="card">
    <div class="day-badge" id="planDayBadge">ìš”ì¼</div>
    <h2 id="planTitle"></h2>
    
    <div id="plan-normal" class="hidden">
      <label>ğŸ•°ï¸ 09:30 ~ 11:00 ì•„ì´ë¸ŒëŸ¬ë¦¬</label>
      <div class="row"><div class="fix-label">ê¸€ì“°ê¸°</div><select id="m1_lv"><option>NORMAL</option><option>EASY</option><option>HARD</option></select></div>
      <div class="row"><div class="fix-label">ë…ì„œ</div><select id="m2_lv"><option>NORMAL</option><option>EASY</option><option>HARD</option></select></div>
      <div class="row"><div class="fix-label">ìì„œì „</div><select id="m3_lv"><option>NORMAL</option><option>EASY</option><option>HARD</option></select></div>
      <label>ğŸ•°ï¸ 11:00 ~ 12:00 ì„ íƒ ìˆ˜ì—… (2ê°œ)</label>
      <div class="grid">
        <select id="c1_a"><option>ì»´í“¨í„°</option><option>ìš´ë™</option><option>ê¸€ì”¨ ì—°ìŠµ</option><option>ì˜ì–´íšŒí™”</option></select>
        <select id="c1_a_lv"><option>NORMAL</option><option>EASY</option><option>HARD</option></select>
      </div>
      <div class="grid">
        <select id="c1_b"><option selected>ìš´ë™</option><option>ì»´í“¨í„°</option><option>ê¸€ì”¨ ì—°ìŠµ</option><option>ì˜ì–´íšŒí™”</option></select>
        <select id="c1_b_lv"><option>NORMAL</option><option>EASY</option><option>HARD</option></select>
      </div>
      <label>ğŸ•°ï¸ 13:00 ~ 15:00 ì˜¤í›„ í™œë™</label>
      <select id="c2"><option>ê²€ì •ê³ ì‹œ</option><option>ìŒì•…</option><option>SCLì±…ë ¥</option><option>ì‹¬í™”ê³µë¶€</option><option>ìš´ë™</option></select>
    </div>

    <div id="plan-thursday" class="hidden">
      <p style="color:#64748b; font-size:13px; margin:10px 0;">ğŸ˜´ ì˜¤ì „ ìˆ˜ì—… ì—†ìŒ</p>
      <label>ğŸ•°ï¸ 13:00 ~ 15:00 ì˜¤í›„ í™œë™</label>
      <select id="th_c2"><option>ê²€ì •ê³ ì‹œ</option><option>êµë¥˜ìˆ˜ì—…</option><option>ìŒì•…</option><option>ì‹¬í™”ìˆ˜ì—…</option><option>SCLì±…ë ¥</option></select>
      <label>ğŸ•°ï¸ 15:00 ~ 17:00 ì•„ì´ë¸ŒëŸ¬ë¦¬</label>
      <div class="row"><div class="fix-label">ê¸€ì“°ê¸° ê¸°ì´ˆ</div><select id="th_m1_lv"><option>NORMAL</option><option>EASY</option><option>HARD</option></select></div>
      <div class="row"><div class="fix-label">ë…ì„œ</div><select id="th_m2_lv"><option>NORMAL</option><option>EASY</option><option>HARD</option></select></div>
      <div class="row"><div class="fix-label">ìì„œì „</div><select id="th_m3_lv"><option>NORMAL</option><option>EASY</option><option>HARD</option></select></div>
      <label>â• ì„ íƒ í™œë™ (2ê°œ)</label>
      <div class="grid">
        <select id="th_c1_a"><option>ì»´í“¨í„°</option><option>ì˜ì–´</option><option>ê¸€ì”¨ ì—°ìŠµ</option><option>ìš´ë™</option></select>
        <select id="th_c1_a_lv"><option>NORMAL</option><option>EASY</option><option>HARD</option></select>
      </div>
      <div class="grid">
        <select id="th_c1_b"><option selected>ìš´ë™</option><option>ì»´í“¨í„°</option><option>ì˜ì–´</option><option>ê¸€ì”¨ ì—°ìŠµ</option></select>
        <select id="th_c1_b_lv"><option>NORMAL</option><option>EASY</option><option>HARD</option></select>
      </div>
    </div>

    <button class="primary" onclick="savePlan()" style="margin-top:20px;">ìŠ¤ì¼€ì¤„ ì €ì¥ ì™„ë£Œ</button>
    <button onclick="goHome()" style="background:white; color:#64748b; margin-top:5px;">ì·¨ì†Œ</button>
  </div>
</div>

<div id="view-mission" class="view container">
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; padding:0 5px;">
    <h2 id="missionTitle" style="font-size:20px;"></h2>
    <div style="display:flex; gap:8px;">
      <button onclick="editPlan()" style="background:white; color:var(--p); border:1px solid var(--p); padding:6px 12px; width:auto; border-radius:8px; font-size:13px; margin:0;">âœï¸ ìˆ˜ì •</button>
      <button onclick="goHome()" style="background:#f1f5f9; color:#64748b; border:none; padding:6px 12px; width:auto; border-radius:8px; font-size:13px; margin:0;">ë‚˜ê°€ê¸°</button>
    </div>
  </div>
  <div id="missionList"></div>
</div>

<div id="adminModalOverlay">
  <div id="adminModalContent">
    <h3 style="margin-top:0;">ğŸ”§ ê´€ë¦¬ì ëª¨ë“œ</h3>
    <input type="password" id="adminPw" placeholder="Password">
    <button onclick="checkAdminPw()" style="background:#333; color:white; margin-top:10px;">ë¡œê·¸ì¸</button>
    <button onclick="document.getElementById('adminModalOverlay').style.display='none'" style="margin-top:10px; background:#eee; color:#333;">ì·¨ì†Œ</button>
  </div>
</div>

<div id="adminTimeModal" class="hidden" style="position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:2000; align-items:center; justify-content:center; display:none;">
  <div style="background:white; width:300px; padding:20px; border-radius:15px; text-align:center;">
    <h3>â° ì‹œê°„ ì„¤ì • (ê´€ë¦¬ì)</h3>
    <label>ì‹œì‘ ì‹œê°„ ~ ì¢…ë£Œ ì‹œê°„</label>
    <div style="display:flex; gap:5px; margin:10px 0;">
      <input type="time" id="admStart"> ~ <input type="time" id="admEnd">
    </div>
    <button onclick="finishAdminMission()" style="background:var(--p); color:white; width:100%;">ì™„ë£Œ ì²˜ë¦¬</button>
    <button onclick="document.getElementById('adminTimeModal').style.display='none'" style="background:#eee; color:#333; width:100%; margin-top:5px;">ì·¨ì†Œ</button>
  </div>
</div>

<script>
// [í•„ìˆ˜] ë°°í¬ëœ URL ì…ë ¥
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwEyYP7LYj0np9I3T8xSJbrNjwnSpvYr5ljigtQp2BB6SYbeUKIbGLB5o6iunDitLeA7g/exec"; 

let appDate = new Date();
let curId, curName, curM;
let currentScheduleData = null;
let timerInterval = null; 
let isAdminMode = false;

document.addEventListener("DOMContentLoaded", () => { renderDate(); });

function renderDate() {
  const days = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
  document.getElementById('todayDate').innerText = `${appDate.toLocaleDateString()} (${days[appDate.getDay()]})`;
  document.getElementById('planDayBadge').innerText = `${days[appDate.getDay()]}ìš”ì¼ ìŠ¤ì¼€ì¤„`;
}
function getAppDateStr() {
  const offset = appDate.getTimezoneOffset() * 60000;
  return new Date(appDate.getTime() - offset).toISOString().slice(0,10);
}
function showView(id) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}
function goHome() { showView('view-dashboard'); }

function openAdminModal() { document.getElementById('adminModalOverlay').style.display = 'flex'; }
function checkAdminPw() {
  if (document.getElementById('adminPw').value === "1q2w3e4r!@") {
    alert("ê´€ë¦¬ì ëª¨ë“œ ON");
    isAdminMode = true;
    document.getElementById('adminModalOverlay').style.display = 'none';
    document.getElementById('adminPanel').classList.remove('hidden');
    document.getElementById('adminBtn').classList.add('hidden');
    document.getElementById('simDateInput').value = getAppDateStr();
    if(currentScheduleData) renderMissions(currentScheduleData);
  } else alert("ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜");
}
function applySimDate() {
  const d = document.getElementById('simDateInput').value;
  if(d) { appDate = new Date(d); renderDate(); alert(`ë‚ ì§œ ì´ë™: ${d}`); goHome(); }
}
function exitAdmin() {
  isAdminMode = false;
  appDate = new Date(); renderDate();
  document.getElementById('adminPanel').classList.add('hidden');
  document.getElementById('adminBtn').classList.remove('hidden');
  if(currentScheduleData) renderMissions(currentScheduleData);
  alert("ê´€ë¦¬ì ëª¨ë“œ ì¢…ë£Œ");
}

function checkUser(id, name) {
  if(WEB_APP_URL.includes("ì—¬ê¸°ì—")) return alert("URLì„ ì„¤ì •í•´ì£¼ì„¸ìš”!");
  
  curId = id; curName = name;
  // [ìˆ˜ì •] í´ë¦­ ì• ë‹ˆë©”ì´ì…˜ ì œê±° (ì¦‰ì‹œ í˜¸ì¶œ)
  fetch(WEB_APP_URL, { method: "POST", body: JSON.stringify({ action: "checkSchedule", id: id, date: getAppDateStr() }) })
  .then(res=>res.json()).then(res=>{
    if(res.hasSchedule) {
      currentScheduleData = res.data;
      renderMissions(res.data);
      showView('view-mission');
      document.getElementById('missionTitle').innerText = `${name} (${getAppDateStr()})`;
      restoreMissionState();
    } else {
      currentScheduleData = null;
      showView('view-plan');
      if(appDate.getDay()===4) { 
         document.getElementById('plan-normal').classList.add('hidden'); 
         document.getElementById('plan-thursday').classList.remove('hidden'); 
      } else {
         document.getElementById('plan-normal').classList.remove('hidden'); 
         document.getElementById('plan-thursday').classList.add('hidden');
      }
    }
  }).catch(e => {
    alert("ì˜¤ë¥˜ ë°œìƒ: ì¸í„°ë„· ì—°ê²°ì´ë‚˜ URLì„ í™•ì¸í•˜ì„¸ìš”.");
  });
}

function savePlan() {
  let data = { action: "saveSchedule", id: curId, date: getAppDateStr(), dayStr: (appDate.getDay()===4?"ëª©":"í‰ì¼") };
  if (appDate.getDay() === 4) {
    data.c2n = document.getElementById('th_c2').value;
    data.m1l = document.getElementById('th_m1_lv').value;
    data.m2l = document.getElementById('th_m2_lv').value;
    data.m3l = document.getElementById('th_m3_lv').value;
    data.c1an = document.getElementById('th_c1_a').value;
    data.c1al = document.getElementById('th_c1_a_lv').value;
    data.c1bn = document.getElementById('th_c1_b').value;
    data.c1bl = document.getElementById('th_c1_b_lv').value;
  } else {
    data.m1l = document.getElementById('m1_lv').value;
    data.m2l = document.getElementById('m2_lv').value;
    data.m3l = document.getElementById('m3_lv').value;
    data.c1an = document.getElementById('c1_a').value;
    data.c1al = document.getElementById('c1_a_lv').value;
    data.c1bn = document.getElementById('c1_b').value;
    data.c1bl = document.getElementById('c1_b_lv').value;
    data.c2n = document.getElementById('c2').value;
  }
  fetch(WEB_APP_URL, { method: "POST", body: JSON.stringify(data) }).then(()=>{ alert("ì €ì¥ë¨"); checkUser(curId, curName); });
}
function editPlan() { 
  showView('view-plan'); 
  const d = currentScheduleData;
  if(d) {
    if (appDate.getDay() === 4) {
      document.getElementById('plan-normal').classList.add('hidden'); 
      document.getElementById('plan-thursday').classList.remove('hidden'); 
      document.getElementById('th_c2').value = d.c2.n;
      document.getElementById('th_m1_lv').value = d.m1.l;
      document.getElementById('th_m2_lv').value = d.m2.l;
      document.getElementById('th_m3_lv').value = d.m3.l;
      document.getElementById('th_c1_a').value = d.c1a.n;
      document.getElementById('th_c1_a_lv').value = d.c1a.l;
      document.getElementById('th_c1_b').value = d.c1b.n;
      document.getElementById('th_c1_b_lv').value = d.c1b.l;
    } else {
      document.getElementById('plan-normal').classList.remove('hidden'); 
      document.getElementById('plan-thursday').classList.add('hidden');
      document.getElementById('m1_lv').value = d.m1.l;
      document.getElementById('m2_lv').value = d.m2.l;
      document.getElementById('m3_lv').value = d.m3.l;
      document.getElementById('c1_a').value = d.c1a.n;
      document.getElementById('c1_a_lv').value = d.c1a.l;
      document.getElementById('c1_b').value = d.c1b.n;
      document.getElementById('c1_b_lv').value = d.c1b.l;
      document.getElementById('c2').value = d.c2.n;
    }
  }
}

function renderMissions(d) {
  const list = document.getElementById('missionList');
  list.innerHTML = "";
  if (d.day === "ëª©") {
    list.innerHTML += `<div style="font-size:12px; color:#888; margin:10px 0;">ğŸ• 13:00 ~ 15:00</div>`;
    renderItem(list, d.c2);
    list.innerHTML += `<div style="font-size:12px; color:#888; margin:20px 0 10px;">ğŸ•’ 15:00 ~ 17:00</div>`;
    [d.m1, d.m2, d.m3, d.c1a, d.c1b].forEach(t => renderItem(list, t));
  } else {
    list.innerHTML += `<div style="font-size:12px; color:#888; margin:10px 0;">ğŸ•¤ 09:30 ~ 11:00</div>`;
    [d.m1, d.m2, d.m3].forEach(t => renderItem(list, t));
    list.innerHTML += `<div style="font-size:12px; color:#888; margin:20px 0 10px;">ğŸ•š 11:00 ~ 12:00</div>`;
    [d.c1a, d.c1b].forEach(t => renderItem(list, t));
    list.innerHTML += `<div style="font-size:12px; color:#888; margin:20px 0 10px;">ğŸ• 13:00 ~ 15:00</div>`;
    renderItem(list, d.c2);
  }
}

function renderItem(container, t) {
  if(!t || !t.n) return;
  const isDone = localStorage.getItem(`${curId}_${t.n}_${getAppDateStr()}_done`) === "yes";
  const div = document.createElement('div');
  div.className = "mission-item";
  
  // [ìˆ˜ì •] íœ´ê°• í‘œì‹œ ì œê±° (í•™ìƒì—ê²ŒëŠ” ì•ˆ ë³´ì„)
  
  let btnClass = "";
  let btnText = "ì‹œì‘í•˜ê¸°";
  let disabled = "";

  if(isDone) {
    if(isAdminMode) {
      btnClass = "done admin-active"; 
      btnText = "âœ… ì™„ë£Œ (ìˆ˜ì •)";
      disabled = ""; 
    } else {
      btnClass = "done";
      btnText = "âœ… ì™„ë£Œ (ì ê¹€)";
      disabled = "disabled"; 
    }
  }

  div.innerHTML = `
    <div class="mission-header"><span class="mission-name">${t.n}</span><span class="mission-lv">${t.l||"-"}</span></div>
    <div class="live-timer" id="timer-${t.n}">00:00:00</div>
    <button class="btn-action ${btnClass}" id="btn-${t.n}" onclick="handleMission('${t.n}','${t.l}')" ${disabled}>
      ${btnText}
    </button>`;
  container.appendChild(div);
}

function handleMission(name, level) {
  const btn = document.getElementById(`btn-${name}`);
  const key = `${curId}_active_${getAppDateStr()}`;
  const active = localStorage.getItem(key);
  
  // ì™„ë£Œëœ ë¯¸ì…˜ ì²˜ë¦¬ (ê´€ë¦¬ìë§Œ)
  const isDone = localStorage.getItem(`${curId}_${name}_${getAppDateStr()}_done`) === "yes";
  if (isDone) {
    if (isAdminMode) {
      curM = name; 
      document.getElementById('adminTimeModal').style.display = 'flex';
      document.getElementById('admStart').value = "";
      document.getElementById('admEnd').value = "";
      return;
    } else {
      return;
    }
  }

  // ì‹œì‘
  if(!active) {
    localStorage.setItem(key, name);
    localStorage.setItem(`${key}_start`, Date.now());
    btn.classList.add('ing'); btn.innerText = "ğŸ”¥ ì§„í–‰ ì¤‘ (ì™„ë£Œí•˜ê¸°)";
    document.getElementById(`timer-${name}`).style.display='block';
    
    fetch(WEB_APP_URL, { method:"POST", body:JSON.stringify({
      action:"saveLog", subAction:"start", student_id:curId, mission_id:name,
      date: getAppDateStr(), 
      note: `Start: ${new Date().toTimeString().slice(0,5)}`
    }) });
    startTimer(name);
  } 
  // ì™„ë£Œ (ì§„í–‰ ì¤‘ì¼ ë•Œ) - [ìˆ˜ì •] ì¦‰ì‹œ confirm í˜¸ì¶œ
  else if(active === name) {
    if (isAdminMode) {
      curM = name; 
      document.getElementById('adminTimeModal').style.display = 'flex';
      document.getElementById('admStart').value = "";
      document.getElementById('admEnd').value = "";
    } else {
      finishImmediate(name, level);
    }
  } else {
    alert("ë‹¤ë¥¸ ë¯¸ì…˜ ì§„í–‰ ì¤‘!");
  }
}

function finishAdminMission() {
  const s = document.getElementById('admStart').value;
  const e = document.getElementById('admEnd').value;
  if(!s || !e) return alert("ì‹œê°„ì„ ì…ë ¥í•˜ì„¸ìš”");
  
  const startD = new Date(`2000-01-01T${s}:00`);
  const endD = new Date(`2000-01-01T${e}:00`);
  let diff = (endD - startD) / 60000;
  if(diff < 0) diff += 1440; 
  
  const noteStr = `${s}~${e} (${diff}ë¶„)`; 
  const name = curM;
  const key = `${curId}_active_${getAppDateStr()}`;
  
  localStorage.removeItem(key);
  localStorage.setItem(`${curId}_${name}_${getAppDateStr()}_done`, "yes");
  
  fetch(WEB_APP_URL, { method:"POST", body:JSON.stringify({
    action:"saveLog", subAction:"end", student_id:curId, mission_id:name,
    date: getAppDateStr(), 
    difficulty: "NORMAL", note: noteStr 
  })}).then(()=>{
    alert("ê´€ë¦¬ì ê¶Œí•œìœ¼ë¡œ ì™„ë£Œë¨");
    document.getElementById('adminTimeModal').style.display='none';
    checkUser(curId, curName); 
  });
}

function finishImmediate(name, level) {
  // [ìˆ˜ì •] confirm ì°½ í˜¸ì¶œ ë³´ì¥
  if(!confirm("ì™„ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
  
  const key = `${curId}_active_${getAppDateStr()}`;
  const st = parseInt(localStorage.getItem(`${key}_start`));
  const diff = Math.floor((Date.now()-st)/1000/60); 
  const noteStr = `${diff}ë¶„ ì†Œìš”`;

  localStorage.removeItem(key);
  localStorage.setItem(`${curId}_${name}_${getAppDateStr()}_done`, "yes");
  
  fetch(WEB_APP_URL, { method:"POST", body:JSON.stringify({
    action:"saveLog", subAction:"end", student_id:curId, mission_id:name,
    date: getAppDateStr(), 
    difficulty: level, note: noteStr
  })}).then(()=>{
    alert("ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
    checkUser(curId, curName);
  });
}

function startTimer(name) {
  const key = `${curId}_active_${getAppDateStr()}`;
  const st = parseInt(localStorage.getItem(`${key}_start`));
  const display = document.getElementById(`timer-${name}`);
  if (timerInterval) clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    const diff = Math.floor((Date.now() - st) / 1000);
    const h = String(Math.floor(diff / 3600)).padStart(2,'0');
    const m = String(Math.floor((diff % 3600) / 60)).padStart(2,'0');
    const s = String(diff % 60).padStart(2,'0');
    display.innerText = `${h}:${m}:${s}`;
  }, 1000);
}

function restoreMissionState() {
  const key = `${curId}_active_${getAppDateStr()}`;
  const active = localStorage.getItem(key);
  if (active) {
    const btn = document.getElementById(`btn-${active}`);
    if (btn) {
      btn.classList.add('ing'); btn.innerText = "ğŸ”¥ ì§„í–‰ ì¤‘ (ì™„ë£Œí•˜ê¸°)";
      document.getElementById(`timer-${active}`).style.display='block';
      startTimer(active);
      document.querySelectorAll('.btn-action').forEach(b => {
        if(b.id !== `btn-${active}` && !b.classList.contains('done')) { b.disabled=true; b.innerText="â›” ëŒ€ê¸°ì¤‘"; }
      });
    }
  }
}
</script>
</body>
</html>