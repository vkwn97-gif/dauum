<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LDS ì‚¬ì› ì•±</title>
  <style>
    /* CSS ìœ ì§€ */
    :root { --p: #4f46e5; --bg: #f8fafc; --card: #ffffff; --ok: #10b981; --fail: #ef4444; }
    body { font-family: 'Pretendard', sans-serif; background: var(--bg); padding: 15px; margin: 0; color:#333; }
    .view { display: none; } .view.active { display: block; animation: fadeIn 0.3s; }
    @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
    .container { max-width: 500px; margin: 0 auto; position: relative; }
    .card { background: var(--card); border-radius: 20px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 15px; text-align: center; }
    .user-card { cursor: pointer; transition: 0.2s; border: 1px solid transparent; display: flex; align-items: center; justify-content: flex-start; gap: 15px; padding: 20px; }
    .user-card:active { transform: scale(0.98); border-color: var(--p); }
    .avatar { font-size: 24px; background: #e0e7ff; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; border-radius: 50%; }
    .user-info { text-align: left; }
    .user-name { font-size: 18px; font-weight: bold; margin: 0; color: #1e293b; }
    .user-role { font-size: 12px; color: #64748b; margin: 0; }
    .lds-header { text-align: center; margin: 40px 0 30px; }
    .lds-logo-text { font-size: 12px; font-weight: 900; color: #94a3b8; letter-spacing: 2px; margin-bottom: 5px; text-transform: uppercase; }
    .lds-main-title { font-size: 26px; font-weight: 800; color: #1e293b; margin: 0; }
    .lds-date { color: #64748b; margin-top: 8px; font-size: 14px; font-weight: 500; }
    select, button, textarea, input[type=text] { width: 100%; padding: 14px; border-radius: 12px; border: 1px solid #e2e8f0; margin-bottom: 10px; font-size: 16px; box-sizing: border-box; }
    button.primary { background: var(--p); color: white; border: none; font-weight: bold; cursor: pointer; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    label { font-size: 14px; font-weight: 800; color: var(--p); margin: 20px 0 10px; display: block; text-align: left; }
    .day-badge { display: inline-block; background: #e0e7ff; color: var(--p); padding: 5px 10px; border-radius: 20px; font-size: 13px; font-weight: bold; margin-bottom: 10px; }
    .mission-item { background: white; border: 1px solid #e2e8f0; border-radius: 15px; padding: 15px; margin-bottom: 10px; text-align: left; position: relative; }
    .mission-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
    .mission-name { font-weight: bold; font-size: 16px; }
    .mission-lv { font-size: 12px; color: #64748b; background: #f1f5f9; padding: 2px 6px; border-radius: 4px; }
    .btn-action { width: 100%; padding: 12px; border-radius: 10px; font-weight: bold; cursor: pointer; border: 1px solid var(--p); background: white; color: var(--p); transition: 0.2s; }
    .btn-action.ing { background: #fff7ed; border: 2px solid orange; color: #d97706; animation: pulse 1.5s infinite; }
    .btn-action.done { background: #f1f5f9; color: #94a3b8; border: 1px solid #e2e8f0; cursor: not-allowed; }
    .btn-action.done.admin-active { cursor: pointer; border: 1px dashed #94a3b8; background: #f8fafc; color: #64748b; }
    .btn-action:disabled { opacity: 0.6; cursor: not-allowed; background: #f8fafc; border-color: #cbd5e1; color: #94a3b8; }
    .live-timer { font-size: 24px; font-weight: 800; color: #d97706; text-align: center; margin: 10px 0; display: none; }
    .proof-photo { width: 100%; max-height: 200px; object-fit: contain; border-radius: 10px; margin-top: 10px; border: 2px solid #e2e8f0; display: block; cursor: pointer; background: #000; }
    .teacher-msg { background: #fef3c7; border: 1px solid #f59e0b; color: #92400e; padding: 10px; border-radius: 8px; margin-top: 10px; font-size: 14px; font-weight: bold; line-height: 1.4; }
    #sinmungoBtn { position: absolute; top: 15px; left: 15px; font-size: 32px; cursor: pointer; background: white; border: none; z-index: 99; border-radius: 50%; width: 50px; height: 50px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); display:flex; justify-content:center; align-items:center; }
    #noticeBtn { position: absolute; top: 15px; right: 15px; font-size: 32px; cursor: pointer; background: white; border: none; z-index: 99; border-radius: 50%; width: 50px; height: 50px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); display:flex; justify-content:center; align-items:center; }
    #adminBtn { position: fixed; bottom: 15px; right: 15px; font-size: 18px; cursor: pointer; background: rgba(0,0,0,0.1); border: none; z-index: 99; color: #fff; width: 30px; height: 30px; border-radius: 50%; display:flex; justify-content:center; align-items:center; }
    #adminPanel { background: #1e293b; color: white; padding: 15px; border-radius: 15px; margin-bottom: 20px; display: flex; flex-direction: column; align-items: center; gap: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
    .admin-row { display: flex; gap: 5px; width: 100%; justify-content: center; }
    #adminModalOverlay, #adminTimeModal, #reflectionModal, #sinmungoModal, #noticeModal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; }
    #adminModalContent, #reflectionContent, #sinmungoContent, #noticeContent { background: white; width: 100%; max-width: 400px; border-radius: 20px; padding: 30px; box-sizing: border-box; text-align: center; margin: 20px; }
    .hidden { display: none !important; }
    #refFeedback { font-size: 14px; font-weight: bold; margin-bottom: 10px; padding: 8px; border-radius: 8px; background: #f1f5f9; color: #64748b; }
    .ref-easy { color: #10b981; background: #ecfdf5; }
    .ref-normal { color: #3b82f6; background: #eff6ff; }
    .ref-hard { color: #ef4444; background: #fef2f2; }
  </style>
</head>
<body>

<div id="view-dashboard" class="view active container">
  <button id="sinmungoBtn" onclick="openSinmungo()">ğŸ“©</button>
  <button id="noticeBtn" onclick="openNotice()">ğŸ“¢</button>
  <button id="adminBtn" onclick="openAdminModal()">âš™ï¸</button>
  
  <div id="adminPanel" class="hidden">
    <div style="font-weight:bold; color:#fbbf24;">ğŸ”§ ê´€ë¦¬ì íƒ€ì„ë¨¸ì‹  ëª¨ë“œ</div>
    <div class="admin-row">
      <input type="date" id="simDateInput" style="padding:8px; border-radius:8px; border:none; width:auto;">
      <button onclick="applySimDate()" style="background:var(--p); color:white; border:none; padding:8px 15px; border-radius:8px; width:auto; margin:0;">ì´ë™</button>
    </div>
    <button onclick="exitAdmin()" style="background:#ef4444; color:white; border:none; padding:8px; border-radius:8px; width:100%; font-size:12px; margin:0;">ê´€ë¦¬ì ëª¨ë“œ ì¢…ë£Œ</button>
  </div>
  
  <div class="lds-header"><div class="lds-logo-text">LIFE DESIGN STUDIO</div><h1 class="lds-main-title">LDS ì‚¬ì› ì•±</h1><p id="todayDate" class="lds-date"></p></div>
  <div class="card user-card" onclick="checkUser('S01','ê°•íƒœìœ¤')"><div class="avatar">ğŸ‘¨â€ğŸ’¼</div><div class="user-info"><h2 class="user-name">ê°•íƒœìœ¤</h2><p class="user-role">LDS ì‚¬ì› (S01)</p></div></div>
  <div class="card user-card" onclick="checkUser('S02','ê¹€ëŒ€ì¤‘')"><div class="avatar">ğŸ‘¨â€ğŸ’¼</div><div class="user-info"><h2 class="user-name">ê¹€ëŒ€ì¤‘</h2><p class="user-role">LDS ì‚¬ì› (S02)</p></div></div>
  <div class="card user-card" onclick="checkUser('S03','ìµœì›ì¤€')"><div class="avatar">ğŸ‘¨â€ğŸ’¼</div><div class="user-info"><h2 class="user-name">ìµœì›ì¤€</h2><p class="user-role">LDS ì‚¬ì› (S03)</p></div></div>
</div>

<div id="view-plan" class="view container">
  <div class="card">
    <div class="day-badge" id="planDayBadge">ìš”ì¼</div>
    <h2 id="planTitle" style="color:#1e293b;">ì—…ë¬´ ê³„íš ìˆ˜ë¦½</h2>
    <div id="plan-normal">
      <label>ğŸ•°ï¸ 09:30 ~ 11:00 ì•„ì´ë¸ŒëŸ¬ë¦¬</label>
      <div class="grid"><select id="m1_name"><option selected>ê¸€ì“°ê¸°</option><option value="í–‰ì‚¬">ğŸ‰ í–‰ì‚¬</option></select><select id="m1_lv"><option>NORMAL</option><option>EASY</option><option>HARD</option></select></div>
      <div class="grid"><select id="m2_name"><option selected>ë…ì„œ</option><option value="í–‰ì‚¬">ğŸ‰ í–‰ì‚¬</option></select><select id="m2_lv"><option>NORMAL</option><option>EASY</option><option>HARD</option></select></div>
      <div class="grid"><select id="m3_name"><option selected>ìì„œì „</option><option value="í–‰ì‚¬">ğŸ‰ í–‰ì‚¬</option></select><select id="m3_lv"><option>NORMAL</option><option>EASY</option><option>HARD</option></select></div>
      <label>ğŸ•°ï¸ 11:00 ~ 12:00 ì„ íƒ ìˆ˜ì—…</label>
      <div class="grid"><select id="c1_a"><option>ì»´í“¨í„°</option><option>ìš´ë™</option><option>ê¸€ì”¨ ì—°ìŠµ</option><option>ì˜ì–´íšŒí™”</option><option value="í–‰ì‚¬">ğŸ‰ í–‰ì‚¬</option></select><select id="c1_a_lv"><option>NORMAL</option><option>EASY</option><option>HARD</option></select></div>
      <div class="grid"><select id="c1_b"><option selected>ìš´ë™</option><option>ì»´í“¨í„°</option><option>ê¸€ì”¨ ì—°ìŠµ</option><option>ì˜ì–´íšŒí™”</option><option value="í–‰ì‚¬">ğŸ‰ í–‰ì‚¬</option></select><select id="c1_b_lv"><option>NORMAL</option><option>EASY</option><option>HARD</option></select></div>
      <label>ğŸ•°ï¸ 13:00 ~ 15:00 ì˜¤í›„ í™œë™</label>
      <select id="c2"><option>ê²€ì •ê³ ì‹œ</option><option>ìŒì•…</option><option>SCLì±…ë ¥</option><option>ì‹¬í™”ê³µë¶€</option><option>ìš´ë™</option><option value="í–‰ì‚¬">ğŸ‰ í–‰ì‚¬</option></select>
    </div>
    <div id="plan-thursday" style="display:none;">
        <div style="background:#f1f5f9; padding:10px; border-radius:10px; margin-bottom:10px;"><b>âš½ ì˜¤ì „: ì¶•êµ¬ ìˆ˜ì—…</b> (09:30 ~ 12:00)</div>
        <label>ğŸ•°ï¸ 13:00 ~ 15:00 ì˜¤í›„ ì„ íƒ</label>
        <select id="th_c2"><option>ê²€ì •ê³ ì‹œ</option><option>êµë¥˜ìˆ˜ì—…</option><option value="í–‰ì‚¬">ğŸ‰ í–‰ì‚¬</option></select>
        <label>ğŸ•°ï¸ 15:00 ~ 17:00 ì•„ì´ë¸ŒëŸ¬ë¦¬</label>
        <div class="grid"><select id="th_m1_name"><option selected>ê¸€ì“°ê¸°</option><option value="í–‰ì‚¬">ğŸ‰ í–‰ì‚¬</option></select><select id="th_m1_lv"><option>NORMAL</option><option>EASY</option><option>HARD</option></select></div>
        <div class="grid"><select id="th_m2_name"><option selected>ë…ì„œ</option><option value="í–‰ì‚¬">ğŸ‰ í–‰ì‚¬</option></select><select id="th_m2_lv"><option>NORMAL</option><option>EASY</option><option>HARD</option></select></div>
        <div class="grid"><select id="th_m3_name"><option selected>ìì„œì „</option><option value="í–‰ì‚¬">ğŸ‰ í–‰ì‚¬</option></select><select id="th_m3_lv"><option>NORMAL</option><option>EASY</option><option>HARD</option></select></div>
    </div>
    <div id="plan-friday" style="display:none;">
        <label>ğŸ•°ï¸ 09:30 ~ 12:00 ì•„ì´ë¸ŒëŸ¬ë¦¬</label>
        <div class="grid"><select id="fr_m1_name"><option selected>ê¸€ì“°ê¸°</option><option value="í–‰ì‚¬">ğŸ‰ í–‰ì‚¬</option></select><select id="fr_m1_lv"><option>NORMAL</option><option>EASY</option><option>HARD</option></select></div>
        <div class="grid"><select id="fr_m2_name"><option selected>ë…ì„œ</option><option value="í–‰ì‚¬">ğŸ‰ í–‰ì‚¬</option></select><select id="fr_m2_lv"><option>NORMAL</option><option>EASY</option><option>HARD</option></select></div>
        <div class="grid"><select id="fr_m3_name"><option selected>ìì„œì „</option><option value="í–‰ì‚¬">ğŸ‰ í–‰ì‚¬</option></select><select id="fr_m3_lv"><option>NORMAL</option><option>EASY</option><option>HARD</option></select></div>
        <label>ğŸ•°ï¸ 11:00 ~ 12:00 ì„ íƒ ìˆ˜ì—…</label>
        <div class="grid"><select id="fr_c1_a"><option>ì»´í“¨í„°</option><option>ìš´ë™</option><option>ê¸€ì”¨ ì—°ìŠµ</option><option>ì˜ì–´íšŒí™”</option><option value="í–‰ì‚¬">ğŸ‰ í–‰ì‚¬</option></select><select id="fr_c1_a_lv"><option>NORMAL</option><option>EASY</option><option>HARD</option></select></div>
        <div class="grid"><select id="fr_c1_b"><option selected>ìš´ë™</option><option>ì»´í“¨í„°</option><option>ê¸€ì”¨ ì—°ìŠµ</option><option>ì˜ì–´íšŒí™”</option><option value="í–‰ì‚¬">ğŸ‰ í–‰ì‚¬</option></select><select id="fr_c1_b_lv"><option>NORMAL</option><option>EASY</option><option>HARD</option></select></div>
        <div style="background:#f1f5f9; padding:10px; border-radius:10px; margin-top:20px;"><b>ğŸ™ ì˜¤í›„: ì˜ˆë°° ë° ìš°ë¦¬ë‹¤ì›€</b> (13:00 ~ 15:00)</div>
    </div>
    <button class="primary" onclick="savePlan()" style="margin-top:20px;">ì—…ë¬´ ìŠ¤ì¼€ì¤„ ì œì¶œ</button>
    <button onclick="goHome()" style="background:white; color:#64748b; margin-top:5px;">ì·¨ì†Œ</button>
  </div>
</div>

<div id="view-mission" class="view container">
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; padding:0 5px;">
    <h2 id="missionTitle" style="font-size:18px; color:#1e293b;"></h2>
    <div style="display:flex; gap:8px;">
      <button onclick="editPlan()" style="background:white; color:var(--p); border:1px solid var(--p); padding:6px 12px; width:auto; border-radius:8px; font-size:13px; margin:0;">âœï¸ ìˆ˜ì •</button>
      <button onclick="goHome()" style="background:#f1f5f9; color:#64748b; border:none; padding:6px 12px; width:auto; border-radius:8px; font-size:13px; margin:0;">ë‚˜ê°€ê¸°</button>
    </div>
  </div>
  <div id="missionList"></div>
</div>

<div id="reflectionModal"><div id="reflectionContent"><h3>ğŸ“ í–‰ì‚¬ ì†Œê°ë¬¸</h3><input type="text" id="eventNameInput" placeholder="í–‰ì‚¬ëª…"><textarea id="reflectionText" rows="6" placeholder="ì†Œê°ë¬¸ ì‘ì„± (100ì ì´ìƒ NORMAL, 200ì ì´ìƒ HARD)"></textarea><div id="refFeedback">í˜„ì¬: EASY (0ì)</div><button id="btnRefSubmit" onclick="submitReflection()" style="background:var(--ok); color:white; margin-top:10px;">ì™„ë£Œí•˜ê¸°</button><button onclick="document.getElementById('reflectionModal').style.display='none'" style="background:#eee; color:#333; margin-top:5px;">ì·¨ì†Œ</button></div></div>
<div id="noticeModal"><div id="noticeContent"><h3>ğŸ“¢ LDS ê³µì§€ì‚¬í•­</h3><div id="noticeText" style="text-align:left;padding:15px;background:#f8fafc;border-radius:10px;"></div><button onclick="document.getElementById('noticeModal').style.display='none'" style="background:var(--p); color:white; margin-top:10px;">í™•ì¸</button></div></div>
<div id="sinmungoModal"><div id="sinmungoContent"><h3>ğŸ“© LDS ì‹ ë¬¸ê³ </h3><input type="text" id="smNick" placeholder="ë‹‰ë„¤ì„"><textarea id="smContent" rows="5"></textarea><button onclick="submitSinmungo()" style="background:var(--p); color:white;">ë³´ë‚´ê¸°</button><button onclick="document.getElementById('sinmungoModal').style.display='none'">ë‹«ê¸°</button></div></div>
<div id="adminModalOverlay"><div id="adminModalContent"><h3>ğŸ”§ ê´€ë¦¬ì ëª¨ë“œ</h3><input type="password" id="adminPw"><button onclick="checkAdminPw()">ë¡œê·¸ì¸</button><button onclick="document.getElementById('adminModalOverlay').style.display='none'">ì·¨ì†Œ</button></div></div>
<div id="adminTimeModal" style="position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:2000; align-items:center; justify-content:center; display:none;"><div style="background:white; width:300px; padding:20px; border-radius:15px; text-align:center;"><h3>â° ì‹œê°„ ì„¤ì •</h3><div style="display:flex; gap:5px;"><input type="time" id="admStart">~<input type="time" id="admEnd"></div><button onclick="finishAdminMission()">ì™„ë£Œ ì²˜ë¦¬</button><button onclick="document.getElementById('adminTimeModal').style.display='none'">ì·¨ì†Œ</button></div></div>

<script>
// â–¼â–¼â–¼â–¼â–¼ ì„ ìƒë‹˜ ë°°í¬ URL â–¼â–¼â–¼â–¼â–¼
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyQmCpxD9AfGTGExe-Th4dw1Kr4lSZeSZ_6SserR1lt-D9ementbdlfF5tL3GIDzxOe2g/exec";
// â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

let appDate = new Date(); let curId, curName, curM;
let currentScheduleData = null; let currentLogs = {}; 
let timerInterval = null; let isAdminMode = false; let currentEventMission = null;

document.addEventListener("DOMContentLoaded", () => { renderDate(); updatePlanView(); });

function renderDate() { const days=['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† ']; document.getElementById('todayDate').innerText = `${appDate.toLocaleDateString()} (${days[appDate.getDay()]})`; document.getElementById('planDayBadge').innerText = `${days[appDate.getDay()]}ìš”ì¼ ì—…ë¬´`; }
function getAppDateStr() { const offset = appDate.getTimezoneOffset()*60000; return new Date(appDate.getTime()-offset).toISOString().slice(0,10); }
function showView(id) { document.querySelectorAll('.view').forEach(v=>v.classList.remove('active')); document.getElementById(id).classList.add('active'); }
function goHome() { showView('view-dashboard'); }
function openNotice() { document.getElementById('noticeModal').style.display='flex'; fetch(WEB_APP_URL,{method:"POST",body:JSON.stringify({action:"getLatestNotice"})}).then(r=>r.json()).then(res=>{document.getElementById('noticeText').innerText=res.notice;}); }
function openSinmungo() { document.getElementById('sinmungoModal').style.display='flex'; document.getElementById('smContent').value=""; }
function submitSinmungo() { const n=document.getElementById('smNick').value; const c=document.getElementById('smContent').value; fetch(WEB_APP_URL,{method:"POST",body:JSON.stringify({action:"saveSinmungo",nickname:n,content:c})}).then(()=>{alert("ì ‘ìˆ˜ì™„ë£Œ");document.getElementById('sinmungoModal').style.display='none';}); }
function openAdminModal() { document.getElementById('adminModalOverlay').style.display='flex'; }
function checkAdminPw() { if(document.getElementById('adminPw').value==="1q2w3e4r!@"){ isAdminMode=true; document.getElementById('adminModalOverlay').style.display='none'; document.getElementById('adminPanel').classList.remove('hidden'); document.getElementById('adminBtn').classList.add('hidden'); document.getElementById('simDateInput').value=getAppDateStr(); if(currentScheduleData)renderMissions(currentScheduleData); } }
function applySimDate() { appDate=new Date(document.getElementById('simDateInput').value); renderDate(); updatePlanView(); goHome(); }
function exitAdmin() { isAdminMode=false; appDate=new Date(); renderDate(); document.getElementById('adminPanel').classList.add('hidden'); document.getElementById('adminBtn').classList.remove('hidden'); updatePlanView(); }

function updatePlanView() {
    const day = appDate.getDay();
    document.getElementById('plan-normal').style.display='none';
    document.getElementById('plan-thursday').style.display='none';
    document.getElementById('plan-friday').style.display='none';
    if(day===4) document.getElementById('plan-thursday').style.display='block';
    else if(day===5) document.getElementById('plan-friday').style.display='block';
    else document.getElementById('plan-normal').style.display='block';
}

function checkUser(id, name) { 
    curId=id; curName=name; 
    fetch(WEB_APP_URL, { method:"POST", body:JSON.stringify({action:"checkSchedule", id:id, date:getAppDateStr()}) }).then(r=>r.json()).then(res=>{ 
        currentLogs=res.logs||{}; 
        if(res.hasSchedule){ currentScheduleData=res.data; renderMissions(res.data); showView('view-mission'); document.getElementById('missionTitle').innerText=`${name} ì‚¬ì› (${getAppDateStr()})`; restoreMissionState(); } 
        else { showView('view-plan'); } 
    }); 
}

function savePlan() { 
  const d = {action:"saveSchedule",id:curId,date:getAppDateStr(),dayStr:(appDate.getDay()===4?"ëª©":appDate.getDay()===5?"ê¸ˆ":"í‰ì¼")};
  const day = appDate.getDay();
  if(day===4) { 
      d.c2n=document.getElementById('th_c2').value; 
      d.m1n=document.getElementById('th_m1_name').value; d.m1l=document.getElementById('th_m1_lv').value; 
      d.m2n=document.getElementById('th_m2_name').value; d.m2l=document.getElementById('th_m2_lv').value; 
      d.m3n=document.getElementById('th_m3_name').value; d.m3l=document.getElementById('th_m3_lv').value; 
  } else if(day===5) { 
      d.m1n=document.getElementById('fr_m1_name').value; d.m1l=document.getElementById('fr_m1_lv').value; 
      d.m2n=document.getElementById('fr_m2_name').value; d.m2l=document.getElementById('fr_m2_lv').value; 
      d.m3n=document.getElementById('fr_m3_name').value; d.m3l=document.getElementById('fr_m3_lv').value; 
      d.c1an=document.getElementById('fr_c1_a').value; d.c1al=document.getElementById('fr_c1_a_lv').value; 
      d.c1bn=document.getElementById('fr_c1_b').value; d.c1bl=document.getElementById('fr_c1_b_lv').value; 
      d.c2n="ì˜ˆë°°"; 
  } else { 
      d.m1n=document.getElementById('m1_name').value; d.m1l=document.getElementById('m1_lv').value; 
      d.m2n=document.getElementById('m2_name').value; d.m2l=document.getElementById('m2_lv').value; 
      d.m3n=document.getElementById('m3_name').value; d.m3l=document.getElementById('m3_lv').value; 
      d.c1an=document.getElementById('c1_a').value; d.c1al=document.getElementById('c1_a_lv').value; 
      d.c1bn=document.getElementById('c1_b').value; d.c1bl=document.getElementById('c1_b_lv').value; 
      d.c2n=document.getElementById('c2').value; 
  }
  fetch(WEB_APP_URL,{method:"POST",body:JSON.stringify(d)});
  alert("ì œì¶œì™„ë£Œ"); 
  currentScheduleData = { day: d.dayStr, m1: {n:d.m1n,l:d.m1l}, m2: {n:d.m2n,l:d.m2l}, m3: {n:d.m3n,l:d.m3l}, c1a: {n:d.c1an||"",l:d.c1al||""}, c1b: {n:d.c1bn||"",l:d.c1bl||""}, c2: {n:d.c2n,l:""} };
  renderMissions(currentScheduleData); showView('view-mission');
}

function editPlan() { showView('view-plan'); }

function renderMissions(d) {
  const list = document.getElementById('missionList'); list.innerHTML = "";
  const lifeLog = currentLogs["ìƒí™œë¯¸ì…˜"]; let lifeSt="ë¯¸ì™„ë£Œ", imgH="", msgH="";
  if(lifeLog){ 
      if(lifeLog.status==='life_ok') lifeSt="âœ… í™•ì¸ë¨"; 
      else if(lifeLog.status==='fail') lifeSt="âŒ ì‹¤íŒ¨"; 
      else if(lifeLog.status==='gong') lifeSt="âœ… ê³µê²°"; 
      if(lifeLog.photo) imgH=`<img src="${lifeLog.photo}" class="proof-photo" onclick="window.open(this.src)">`; 
      if(lifeLog.message) msgH=`<div class="teacher-msg">ğŸ“¢ ${lifeLog.message}</div>`; 
  }
  list.innerHTML += `<div class="mission-item" style="border-left:5px solid #f59e0b; background:#fffbeb;"><div class="mission-header"><span class="mission-name">ğŸŒ ìƒí™œë¯¸ì…˜</span><span class="mission-lv">${lifeSt}</span></div>${imgH}${msgH}</div>`;

  // ëª©ìš”ì¼ (ì¶•êµ¬)
  if (d.day === "ëª©") {
      list.innerHTML += `<div class="mission-item done"><b>âš½ ì˜¤ì „: ì¶•êµ¬ ìˆ˜ì—…</b></div><div style="font-size:12px;color:#888;">ì˜¤í›„ ì„ íƒ</div>`;
      if(d.c2) renderItem(list, d.c2);
      const th = [d.m1, d.m2, d.m3];
      if (th.every(m => m && m.n === "í–‰ì‚¬")) renderEventCard(list, "15:00 ~ 17:00", "ì˜¤í›„ í–‰ì‚¬", "í–‰ì‚¬_ëª©ì˜¤í›„", 3);
      else { list.innerHTML+=`<div style="font-size:12px;color:#888;">15:00 ~ 17:00</div>`; th.forEach(t => renderItem(list, t)); }
      return;
  }

  // ê¸ˆìš”ì¼ (ì˜ˆë°°)
  if (d.day === "ê¸ˆ") {
      const morning = [d.m1, d.m2, d.m3];
      if (morning.every(m => m && m.n === "í–‰ì‚¬")) renderEventCard(list, "09:30 ~ 11:00", "ì˜¤ì „ í–‰ì‚¬", "í–‰ì‚¬_ì˜¤ì „", 3);
      else { list.innerHTML+=`<div style="font-size:12px;color:#888;">ì˜¤ì „</div>`; morning.forEach(t => renderItem(list, t)); }
      
      const choice = [d.c1a, d.c1b];
      if (choice.every(m => m && m.n === "í–‰ì‚¬")) renderEventCard(list, "11:00 ~ 12:00", "ì„ íƒ í–‰ì‚¬", "í–‰ì‚¬_ì„ íƒ", 2);
      else { list.innerHTML+=`<div style="font-size:12px;color:#888;">ì„ íƒ</div>`; choice.forEach(t => renderItem(list, t)); }
      
      list.innerHTML += `<div class="mission-item done"><b>ğŸ™ ì˜¤í›„: ì˜ˆë°° ë° ìš°ë¦¬ë‹¤ì›€</b></div>`;
      return;
  }

  // í‰ì¼
  const morning = [d.m1, d.m2, d.m3];
  if (morning.every(m => m && m.n === "í–‰ì‚¬")) renderEventCard(list, "09:30 ~ 11:00", "ì˜¤ì „ í–‰ì‚¬", "í–‰ì‚¬_ì˜¤ì „", 3);
  else { list.innerHTML+=`<div style="font-size:12px;color:#888;">ì˜¤ì „</div>`; morning.forEach(t => renderItem(list, t)); }
  
  const choice = [d.c1a, d.c1b];
  if (choice.every(m => m && m.n === "í–‰ì‚¬")) renderEventCard(list, "11:00 ~ 12:00", "ì„ íƒ í–‰ì‚¬", "í–‰ì‚¬_ì„ íƒ", 2);
  else { list.innerHTML+=`<div style="font-size:12px;color:#888;">ì„ íƒ</div>`; choice.forEach(t => renderItem(list, t)); }
  
  list.innerHTML+=`<div style="font-size:12px;color:#888;">ì˜¤í›„</div>`;
  if (d.c2 && d.c2.n === "í–‰ì‚¬") renderEventCard(list, "13:00 ~ 15:00", "ì˜¤í›„ í–‰ì‚¬", "í–‰ì‚¬_ì˜¤í›„", 1);
  else renderItem(list, d.c2);
}

function renderEventCard(container, timeStr, name, keyName) { 
  const log = currentLogs[keyName]; // ì„œë²„ì—ì„œ ë°›ì€ ë¡œê·¸ í™•ì¸
  // ë§Œì•½ ë¡œê·¸ê°€ í–‰ì‚¬_ì˜¤ì „ í‚¤ë¡œ ì—†ë‹¤ë©´ 'í–‰ì‚¬' í‚¤ë¡œë„ í™•ì¸
  const isDone = (log && (log.status === 'end' || log.status === 'gong')) || (currentLogs['í–‰ì‚¬'] && currentLogs['í–‰ì‚¬'].status === 'end');
  
  const div=document.createElement('div'); div.className="mission-item"; 
  let btnText = isDone ? (log && log.status==='gong'?"âœ… ê³µê²°":"âœ… ì™„ë£Œë¨") : "ğŸ“ ì†Œê°ë¬¸ ì‘ì„± ë° ì™„ë£Œ";
  div.innerHTML=`<div style="font-size:12px; color:#888;">${timeStr}</div><div class="mission-header"><span class="mission-name">ğŸ‰ ${name}</span></div><button class="btn-action ${isDone?'done':''}" onclick="openReflectionModal('${name}', '${keyName}')" ${isDone?'disabled':''}>${btnText}</button>`; 
  container.appendChild(div); 
}
function openReflectionModal(name, key) { currentEventMission = key; document.getElementById('reflectionModal').style.display='flex'; }
function checkRefLen() { const len=document.getElementById('reflectionText').value.length; let diff="EASY", cls="ref-easy"; if(len>=200){ diff="HARD"; cls="ref-hard"; } else if(len>=100){ diff="NORMAL"; cls="ref-normal"; } document.getElementById('refFeedback').innerText=`í˜„ì¬: ${diff} (${len}ì)`; document.getElementById('refFeedback').className=cls; document.getElementById('btnRefSubmit').innerText=`${diff}ë¡œ ì™„ë£Œí•˜ê¸°`; }
function submitReflection() { 
  const text=document.getElementById('reflectionText').value; 
  const len=text.length; let diff="EASY"; if(len>=200)diff="HARD"; else if(len>=100)diff="NORMAL"; 
  const key = currentEventMission;
  currentLogs[key] = { status: 'end' }; renderMissions(currentScheduleData); 
  document.getElementById('reflectionModal').style.display='none'; 
  fetch(WEB_APP_URL,{method:"POST",body:JSON.stringify({action:"saveEventReflection", student_id:curId, student_name:curName, eventName:"í–‰ì‚¬", mission_id:key, date:getAppDateStr(), difficulty:diff, content:text})});
}

function renderItem(container, t) { 
  if(!t||!t.n)return; 
  const serverLog=currentLogs[t.n]; 
  const isDone=serverLog&&(serverLog.status==='end'||serverLog.status==='ok'||serverLog.status==='gong'); 
  const isStart=serverLog&&serverLog.status==='start';
  
  const div=document.createElement('div'); div.className="mission-item"; 
  let btnText="ì—…ë¬´ ì‹œì‘", btnClass="";
  if(isDone) { 
      btnText = serverLog.status==='gong' ? "âœ… ê³µê²°" : "âœ… ì™„ë£Œë¨"; 
      btnClass="done"; 
  }
  else if(isStart) { btnText="ğŸ”¥ ì§„í–‰ ì¤‘ (í´ë¦­í•˜ì—¬ ì™„ë£Œ)"; btnClass="ing"; }
  if(isAdminMode && isDone) { btnText="âœ… ì™„ë£Œ (ìˆ˜ì •)"; btnClass="done admin-active"; }

  div.innerHTML=`<div class="mission-header"><span class="mission-name">${t.n}</span><span class="mission-lv">${t.l||"-"}</span></div><div class="live-timer" id="timer-${t.n}" style="display:${isStart?'block':'none'}">00:00:00</div><button class="btn-action ${btnClass}" id="btn-${t.n}" onclick="handleMission('${t.n}','${t.l}')" ${isDone&&!isAdminMode?'disabled':''}>${btnText}</button>`; 
  container.appendChild(div); 
  if(isStart) startTimer(t.n);
}

function handleMission(name, level) { 
  if(isAdminMode && currentLogs[name] && (currentLogs[name].status==='end' || currentLogs[name].status==='gong')) { curM=name; document.getElementById('adminTimeModal').style.display='flex'; return; }
  const serverLog=currentLogs[name];
  const isStart = serverLog && serverLog.status === 'start';

  if(!isStart) {
      if(Object.values(currentLogs).some(l=>l.status==='start')) return alert("ì´ë¯¸ ì§„í–‰ ì¤‘ì¸ ì—…ë¬´ê°€ ìˆìŠµë‹ˆë‹¤!");
      currentLogs[name] = { status: 'start' }; 
      fetch(WEB_APP_URL,{method:"POST",body:JSON.stringify({action:"saveLog",subAction:"start",student_id:curId,mission_id:name,date:getAppDateStr(),note:"Start"})});
      renderMissions(currentScheduleData);
  } else {
      if(!confirm("ì—…ë¬´ë¥¼ ì™„ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
      currentLogs[name] = { status: 'end' };
      fetch(WEB_APP_URL,{method:"POST",body:JSON.stringify({action:"saveLog",subAction:"end",student_id:curId,mission_id:name,date:getAppDateStr(),difficulty:level,note:"End"})});
      renderMissions(currentScheduleData);
  }
}

function finishAdminMission() { 
    const s=document.getElementById('admStart').value; const e=document.getElementById('admEnd').value; 
    fetch(WEB_APP_URL,{method:"POST",body:JSON.stringify({action:"saveLog",subAction:"end",student_id:curId,mission_id:curM,date:getAppDateStr(),difficulty:"NORMAL",note:`${s}~${e}`})})
    .then(()=>{alert("ìˆ˜ì •ì™„ë£Œ");document.getElementById('adminTimeModal').style.display='none';checkUser(curId,curName);}); 
}
function startTimer(name) { 
    if(timerInterval) clearInterval(timerInterval);
    let sec=0; 
    timerInterval = setInterval(()=>{ sec++; 
        const h=String(Math.floor(sec/3600)).padStart(2,'0'); 
        const m=String(Math.floor((sec%3600)/60)).padStart(2,'0'); 
        const s=String(sec%60).padStart(2,'0'); 
        const el=document.getElementById(`timer-${name}`);
        if(el) el.innerText=`${h}:${m}:${s}`; 
    },1000); 
}
function restoreMissionState() { }
</script>
</body>
</html>