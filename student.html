<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ë‹¤ì›€í•™êµ ë¯¸ì…˜ ì„¼í„°</title>
  <style>
    :root { --p1: #3b82f6; --p2: #10b981; --bg: #f8fafc; }
    body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 20px; }
    .student-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }
    .student-card { background: white; border-radius: 20px; padding: 25px 15px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.05); cursor: pointer; position: relative; transition: 0.2s; }
    .student-card:active { transform: scale(0.95); }
    .status-dot { display: inline-block; width: 12px; height: 12px; border-radius: 50%; background: #ccc; margin-bottom: 10px; }
    .status-dot.active { background: var(--p2); box-shadow: 0 0 8px var(--p2); animation: pulse 2s infinite; }
    .elapsed-tag { font-size: 13px; color: var(--p1); font-weight: 800; margin-top: 10px; background: #eff6ff; padding: 5px; border-radius: 10px; }
    #missionOverlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:100; }
    .popup { background:white; width:90%; max-width:400px; padding:30px; border-radius:30px; position:relative; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
    .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 25px; }
    .circle-btn { aspect-ratio: 1/1; border-radius: 50%; border: none; color: white; font-weight: 900; font-size: 18px; cursor: pointer; }
    .start { background: var(--p1); } .end { background: var(--p2); }
    .circle-btn:disabled { background: #e2e8f0; color: #94a3b8; cursor: not-allowed; }
    .photo-area { margin-top:20px; border:2px dashed #3b82f6; padding:15px; border-radius:20px; text-align:center; background: #eff6ff; }
    #photoPreview { width:100%; display:none; margin-top:10px; border-radius:15px; border: 1px solid #ddd; }
    select { width:100%; padding:12px; margin-bottom:12px; border-radius:12px; border: 1px solid #ddd; font-size: 16px; }
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
  </style>
</head>
<body>

<h2 style="text-align:center; color:#1e293b; margin-bottom:20px;">ë‹¤ì›€í•™êµ ë¯¸ì…˜ ëŒ€ì‹œë³´ë“œ</h2>
<div class="student-grid" id="studentGrid"></div>

<div id="missionOverlay">
  <div class="popup">
    <h2 id="popName" style="margin-top:0; color:#1e293b;">í•™ìƒì´ë¦„</h2>
    
    <div id="selectionArea">
      <label style="font-size:13px; color:#64748b;">ë¯¸ì…˜ ì„ íƒ</label>
      <select id="mSelect"></select>
      <div id="diffArea">
        <label style="font-size:13px; color:#64748b;">ë‚œì´ë„ ì„ íƒ</label>
        <select id="dSelect"></select>
      </div>
    </div>

    <div id="lifeMissionArea" style="display:none;">
      <div class="photo-area">
        <label for="photoInput" style="cursor:pointer; font-weight:bold; color:var(--p1);">ğŸ“¸ ìƒí™œë¯¸ì…˜ ì‚¬ì§„ ì´¬ì˜í•˜ê¸°</label>
        <input type="file" id="photoInput" accept="image/*" capture="camera" style="display:none;" onchange="previewImage(this)">
        <img id="photoPreview">
        <p id="photoStatus" style="font-size:12px; color:#64748b; margin-top:5px;">ì‚¬ì§„ì„ ì°ì–´ì•¼ ì™„ë£Œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
      </div>
    </div>

    <div class="btn-group">
      <button id="sBtn" class="circle-btn start" onclick="doStart()">ì‹œì‘</button>
      <button id="eBtn" class="circle-btn end" onclick="doEnd()">ì™„ë£Œ</button>
    </div>
    <button onclick="closePopup()" style="margin-top:20px; width:100%; border:none; background:none; color:#94a3b8; font-weight:bold;">ë‹«ê¸°</button>
  </div>
</div>

<script>
  // [ì£¼ì˜] ì„ ìƒë‹˜ì˜ ì•±ìŠ¤í¬ë¦½íŠ¸ ë°°í¬ URLì„ ë„£ì–´ì£¼ì„¸ìš”
  const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxeLTBIEznrBrZHokDS-U5AyQiK1FHyobCpnbzjUNsCiVyl4FruNkP-ld1J2qNcUBDMdA/exec"; 
  const STUDENT_TOKEN = "STUDENT_1234";

  let studentStates = {
    "S01": { name: "ê°•íƒœìœ¤", active: false, startTime: null, mId: "", attemptId: "", mName: "" },
    "S02": { name: "ê¹€ëŒ€ì¤‘", active: false, startTime: null, mId: "", attemptId: "", mName: "" },
    "S03": { name: "ìµœì›ì¤€", active: false, startTime: null, mId: "", attemptId: "", mName: "" }
  };

  let currentId = "";
  let missionsMap = {};
  let currentImageData = "";

  window.onload = async () => {
    renderCards();
    await loadMissions();
    await refreshAllStatus();
    setInterval(updateTimers, 1000); 
  };

  async function loadMissions() {
    const res = await fetch(`${WEB_APP_URL}?action=missions`);
    const data = await res.json();
    data.missions.forEach(m => {
      if(!missionsMap[m.mission_name]) missionsMap[m.mission_name] = {};
      missionsMap[m.mission_name][String(m.difficulty).toLowerCase()] = m.mission_id;
    });
    const mSel = document.getElementById('mSelect');
    mSel.innerHTML = '<option value="">ë¯¸ì…˜ì„ ì„ íƒí•´ ì£¼ì„¸ìš”</option>';
    Object.keys(missionsMap).sort().forEach(n => mSel.innerHTML += `<option value="${n}">${n}</option>`);
    mSel.onchange = onMChange;
  }

  function onMChange() {
    const name = document.getElementById('mSelect').value;
    const dSel = document.getElementById('dSelect');
    const diffArea = document.getElementById('diffArea');
    
    // ì‹œì‘ ì „ì—ëŠ” ì‚¬ì§„ ì˜ì—­ì„ ì ˆëŒ€ ë³´ì—¬ì£¼ì§€ ì•ŠìŒ
    document.getElementById('lifeMissionArea').style.display = "none";
    
    if (name.includes("ìƒí™œ")) {
      diffArea.style.display = "none";
    } else {
      diffArea.style.display = "block";
      dSel.innerHTML = '<option value="">ë‚œì´ë„</option>';
      const diffs = missionsMap[name];
      ["easy", "normal", "hard"].forEach(d => { if(diffs[d]) dSel.innerHTML += `<option value="${d}">${d.toUpperCase()}</option>`; });
    }
  }

  async function refreshAllStatus() {
    for (let id in studentStates) {
      const res = await fetch(`${WEB_APP_URL}?action=checkStatus&student_id=${id}`);
      const data = await res.json();
      if (data.ok && data.lastLog && data.lastLog.value === "start") {
        const s = studentStates[id];
        s.active = true;
        s.attemptId = data.lastLog.attempt_id;
        s.mId = data.lastLog.mission_id;
        s.startTime = new Date(data.lastLog.timestamp).getTime();
        
        // 3ë²ˆ ë³µêµ¬ ì‹œ ë¯¸ì…˜ ì´ë¦„ë„ ì°¾ì•„ì„œ ì €ì¥ (ìƒí™œë¯¸ì…˜ íŒë³„ìš©)
        for (let mName in missionsMap) {
          if (Object.values(missionsMap[mName]).includes(s.mId)) {
            s.mName = mName;
            break;
          }
        }
      }
    }
    renderCards();
  }

  function updateTimers() {
    Object.keys(studentStates).forEach(id => {
      const s = studentStates[id];
      const el = document.getElementById(`timer_${id}`);
      if (s.active && s.startTime && el) {
        const diff = Math.floor((Date.now() - s.startTime) / 1000);
        el.textContent = `${Math.floor(diff/60)}ë¶„ ${diff%60}ì´ˆ ì§„í–‰ ì¤‘`;
      }
    });
  }

  function renderCards() {
    const grid = document.getElementById('studentGrid');
    grid.innerHTML = "";
    Object.keys(studentStates).forEach(id => {
      const s = studentStates[id];
      grid.innerHTML += `
        <div class="student-card" onclick="openPopup('${id}')">
          <div class="status-dot ${s.active ? 'active' : ''}"></div>
          <div style="font-size:30px; margin-bottom:5px;">ğŸ‘¤</div>
          <div style="font-weight:bold; font-size:18px;">${s.name}</div>
          <div id="timer_${id}" class="elapsed-tag" style="${s.active ? '' : 'display:none'}"></div>
        </div>`;
    });
  }

  function openPopup(id) {
    currentId = id; const s = studentStates[id];
    document.getElementById('popName').textContent = s.name;
    document.getElementById('missionOverlay').style.display = "flex";
    
    // ë²„íŠ¼ ë° ì˜ì—­ ì´ˆê¸°í™”
    document.getElementById('sBtn').disabled = s.active;
    document.getElementById('eBtn').disabled = !s.active;
    
    // ë¯¸ì…˜ ì‹œì‘ ì „: ì„ íƒì°½ ë³´ì—¬ì¤Œ, ì‚¬ì§„ì°½ ìˆ¨ê¹€
    if(!s.active) {
      document.getElementById('selectionArea').style.display = "block";
      document.getElementById('lifeMissionArea').style.display = "none";
    } 
    // ë¯¸ì…˜ ì‹œì‘ í›„: ì„ íƒì°½ ìˆ¨ê¹€
    else {
      document.getElementById('selectionArea').style.display = "none";
      // ìƒí™œë¯¸ì…˜ì¸ ê²½ìš°ì—ë§Œ ì‚¬ì§„ì°½ ë³´ì—¬ì¤Œ
      if(s.mName && s.mName.includes("ìƒí™œ")) {
        document.getElementById('lifeMissionArea').style.display = "block";
      } else {
        document.getElementById('lifeMissionArea').style.display = "none";
      }
    }
    
    document.getElementById('photoPreview').style.display = "none";
    currentImageData = "";
  }

  function previewImage(input) {
    if (input.files && input.files[0]) {
      const reader = new FileReader();
      reader.onload = e => { 
        document.getElementById('photoPreview').src = e.target.result;
        document.getElementById('photoPreview').style.display = "block";
        document.getElementById('photoStatus').textContent = "ì‚¬ì§„ì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤! ì™„ë£Œë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.";
        currentImageData = e.target.result;
      };
      reader.readAsDataURL(input.files[0]);
    }
  }

  async function doStart() {
    const s = studentStates[currentId];
    const mName = document.getElementById('mSelect').value;
    let diff = document.getElementById('dSelect').value || "normal";
    if(!mName) return alert("ë¯¸ì…˜ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”!");
    
    s.active = true; 
    s.startTime = Date.now(); 
    s.attemptId = currentId + "_" + s.startTime; 
    s.mName = mName;
    s.mId = missionsMap[mName][diff] || Object.values(missionsMap[mName])[0];
    
    await sendLog("start", s.attemptId, currentId, s.mId, "");
    renderCards(); 
    closePopup(); // ì‹œì‘ í›„ ì¼ë‹¨ ë‹«ê¸° -> ì„ ìƒë‹˜ ë§ì”€ëŒ€ë¡œ ë‹¤ì‹œ ë“¤ì–´ì™€ì„œ ì‚¬ì§„ ì°ê²Œ í•¨
  }

  async function doEnd() {
    const s = studentStates[currentId];
    // ìƒí™œë¯¸ì…˜ì¸ë° ì‚¬ì§„ì´ ì—†ëŠ” ê²½ìš° ì²´í¬
    if(s.mName && s.mName.includes("ìƒí™œ") && !currentImageData) {
      return alert("ğŸ“¸ ì‚¬ì§„ì„ ì´¬ì˜í•´ì•¼ ì™„ë£Œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!");
    }
    
    const duration = Math.round((Date.now()-s.startTime)/1000);
    const note = `duration:${duration}s${currentImageData ? `|image:${currentImageData}` : ''}`;
    
    await sendLog("end", s.attemptId, currentId, s.mId, note);
    s.active = false; s.startTime = null; s.mName = "";
    renderCards(); 
    closePopup();
  }

  async function sendLog(val, attId, sId, mId, note) {
    await fetch(WEB_APP_URL, {
      method: "POST",
      body: JSON.stringify({ token: STUDENT_TOKEN, attempt_id: attId, student_id: sId, mission_id: mId, value: val, note: note })
    });
  }
  function closePopup() { document.getElementById('missionOverlay').style.display = "none"; }
</script>
</body>
</html>