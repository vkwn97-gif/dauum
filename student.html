<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root { --p: #4f46e5; --bg: #f8fafc; --card: #ffffff; --ok: #10b981; --fail: #ef4444; }
    body { font-family: 'Pretendard', sans-serif; background: var(--bg); padding: 15px; margin: 0; color:#333; }
    
    .view { display: none; }
    .view.active { display: block; animation: fadeIn 0.3s; }
    @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }

    .container { max-width: 500px; margin: 0 auto; }
    .card { background: var(--card); border-radius: 20px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 15px; text-align: center; }
    
    .user-card { cursor: pointer; transition: 0.2s; border: 1px solid transparent; }
    .user-card:active { transform: scale(0.98); border-color: var(--p); }
    .avatar { font-size: 40px; margin-bottom: 10px; display: block; }

    select, button { width: 100%; padding: 14px; border-radius: 12px; border: 1px solid #e2e8f0; margin-bottom: 10px; font-size: 16px; box-sizing: border-box; }
    button.primary { background: var(--p); color: white; border: none; font-weight: bold; cursor: pointer; }
    
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    label { font-size: 14px; font-weight: 800; color: var(--p); margin: 20px 0 10px; display: block; text-align: left; }
    .row { display: flex; gap: 8px; align-items: center; margin-bottom: 8px; }
    .fix-label { background: #f1f5f9; padding: 12px; border-radius: 12px; flex: 1; font-weight: bold; font-size: 15px; }
    .day-badge { display: inline-block; background: #e0e7ff; color: var(--p); padding: 5px 10px; border-radius: 20px; font-size: 13px; font-weight: bold; margin-bottom: 10px; }

    /* ë¯¸ì…˜ ì•„ì´í…œ */
    .mission-item { background: white; border: 1px solid #e2e8f0; border-radius: 15px; padding: 15px; margin-bottom: 10px; text-align: left; position: relative; }
    .mission-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
    .mission-name { font-weight: bold; font-size: 16px; }
    .mission-lv { font-size: 12px; color: #64748b; background: #f1f5f9; padding: 2px 6px; border-radius: 4px; }
    
    /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .btn-action { width: 100%; padding: 12px; border-radius: 10px; font-weight: bold; cursor: pointer; border: 1px solid var(--p); background: white; color: var(--p); transition: 0.2s; }
    
    /* ì§„í–‰ ì¤‘ (ê¹œë¹¡ì„ íš¨ê³¼) */
    .btn-action.ing { 
      background: #fff7ed; border: 2px solid orange; color: #d97706; 
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
    
    /* ì™„ë£Œë¨ (í´ë¦­ ë¶ˆê°€) */
    .btn-action.done { 
      background: #f1f5f9; color: #94a3b8; border: 1px solid #e2e8f0; 
      cursor: not-allowed; pointer-events: none; 
    }
    
    /* ëŒ€ê¸°ì¤‘ (ì ê¹€) */
    .btn-action:disabled { opacity: 0.6; cursor: not-allowed; background: #f8fafc; border-color: #cbd5e1; color: #94a3b8; }

    .live-timer { font-size: 24px; font-weight: 800; color: #d97706; text-align: center; margin: 10px 0; display: none; }
    
    .hidden { display: none !important; }
  </style>
</head>
<body>

<div id="view-dashboard" class="view active container">
  <div style="text-align:center; margin: 30px 0;">
    <h1 style="color:var(--p); margin:0;">ë‹¤ì›€í•™êµ</h1>
    <p id="todayDate" style="color:#64748b; margin:5px; font-weight:bold;"></p>
  </div>
  <div class="card user-card" onclick="checkUser('S01','ê°•íƒœìœ¤')"><span class="avatar">ğŸ‘¤</span><h2>ê°•íƒœìœ¤</h2></div>
  <div class="card user-card" onclick="checkUser('S02','ê¹€ëŒ€ì¤‘')"><span class="avatar">ğŸ‘¤</span><h2>ê¹€ëŒ€ì¤‘</h2></div>
  <div class="card user-card" onclick="checkUser('S03','ìµœì›ì¤€')"><span class="avatar">ğŸ‘¤</span><h2>ìµœì›ì¤€</h2></div>
</div>

<div id="view-plan" class="view container">
  <div class="card">
    <div class="day-badge" id="planDayBadge">ìš”ì¼</div>
    <h2 id="planTitle"></h2>
    
    <div id="plan-normal" class="hidden">
      <label>ğŸ•°ï¸ 09:30 ~ 11:00 ì•„ì´ë¸ŒëŸ¬ë¦¬</label>
      <div class="row"><div class="fix-label">ê¸€ì“°ê¸°</div><select id="m1_lv"><option>NORMAL</option><option>EASY</option><option>HARD</option></select></div>
      <div class="row"><div class="fix-label">ë…ì„œ</div><select id="m2_lv"><option>NORMAL</option><option>EASY</option><option>HARD</option></select></div>
      <div class="row"><div class="fix-label">ìì„œì „</div><select id="m3_lv"><option>NORMAL</option><option>EASY</option><option>HARD</option></select></div>
      <label>ğŸ•°ï¸ 11:00 ~ 12:00 ì„ íƒ ìˆ˜ì—… (2ê°œ)</label>
      <div class="grid">
        <select id="c1_a"><option>ì»´í“¨í„°</option><option>ìš´ë™</option><option>ê¸€ì”¨ ì—°ìŠµ</option><option>ì˜ì–´íšŒí™”</option></select>
        <select id="c1_a_lv"><option>NORMAL</option><option>EASY</option><option>HARD</option></select>
      </div>
      <div class="grid">
        <select id="c1_b"><option selected>ìš´ë™</option><option>ì»´í“¨í„°</option><option>ê¸€ì”¨ ì—°ìŠµ</option><option>ì˜ì–´íšŒí™”</option></select>
        <select id="c1_b_lv"><option>NORMAL</option><option>EASY</option><option>HARD</option></select>
      </div>
      <label>ğŸ•°ï¸ 13:00 ~ 15:00 ì˜¤í›„ í™œë™</label>
      <select id="c2"><option>ê²€ì •ê³ ì‹œ</option><option>ìŒì•…</option><option>SCLì±…ë ¥</option><option>ì‹¬í™”ê³µë¶€</option><option>ìš´ë™</option></select>
    </div>

    <div id="plan-thursday" class="hidden">
      <p style="color:#64748b; font-size:13px; margin:10px 0;">ğŸ˜´ ì˜¤ì „ ìˆ˜ì—… ì—†ìŒ</p>
      <label>ğŸ•°ï¸ 13:00 ~ 15:00 ì˜¤í›„ í™œë™</label>
      <select id="th_c2"><option>ê²€ì •ê³ ì‹œ</option><option>êµë¥˜ìˆ˜ì—…</option><option>ìŒì•…</option><option>ì‹¬í™”ìˆ˜ì—…</option><option>SCLì±…ë ¥</option></select>
      <label>ğŸ•°ï¸ 15:00 ~ 17:00 ì•„ì´ë¸ŒëŸ¬ë¦¬</label>
      <div class="row"><div class="fix-label">ê¸€ì“°ê¸° ê¸°ì´ˆ</div><select id="th_m1_lv"><option>NORMAL</option><option>EASY</option><option>HARD</option></select></div>
      <div class="row"><div class="fix-label">ë…ì„œ</div><select id="th_m2_lv"><option>NORMAL</option><option>EASY</option><option>HARD</option></select></div>
      <div class="row"><div class="fix-label">ìì„œì „</div><select id="th_m3_lv"><option>NORMAL</option><option>EASY</option><option>HARD</option></select></div>
      <label>â• ì„ íƒ í™œë™ (2ê°œ)</label>
      <div class="grid">
        <select id="th_c1_a"><option>ì»´í“¨í„°</option><option>ì˜ì–´</option><option>ê¸€ì”¨ ì—°ìŠµ</option><option>ìš´ë™</option></select>
        <select id="th_c1_a_lv"><option>NORMAL</option><option>EASY</option><option>HARD</option></select>
      </div>
      <div class="grid">
        <select id="th_c1_b"><option selected>ìš´ë™</option><option>ì»´í“¨í„°</option><option>ì˜ì–´</option><option>ê¸€ì”¨ ì—°ìŠµ</option></select>
        <select id="th_c1_b_lv"><option>NORMAL</option><option>EASY</option><option>HARD</option></select>
      </div>
    </div>

    <button class="primary" onclick="savePlan()" style="margin-top:20px;">ìŠ¤ì¼€ì¤„ ì €ì¥ ì™„ë£Œ</button>
    <button onclick="goHome()" style="background:white; color:#64748b; margin-top:5px;">ì·¨ì†Œ</button>
  </div>
</div>

<div id="view-mission" class="view container">
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; padding:0 5px;">
    <h2 id="missionTitle" style="font-size:20px;"></h2>
    <div style="display:flex; gap:8px;">
      <button onclick="editPlan()" style="background:white; color:var(--p); border:1px solid var(--p); padding:6px 12px; width:auto; border-radius:8px; font-size:13px; margin:0;">âœï¸ ìˆ˜ì •</button>
      <button onclick="goHome()" style="background:#f1f5f9; color:#64748b; border:none; padding:6px 12px; width:auto; border-radius:8px; font-size:13px; margin:0;">ë‚˜ê°€ê¸°</button>
    </div>
  </div>
  <div id="missionList"></div>
</div>

<script>
// [í•„ìˆ˜] ë°°í¬ëœ URL ì…ë ¥
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwtygjf78iOlNExb6AQJ2xKlO76XFK-ApnTYxNsCNV1iLWTkX-korPp7nu_EA8H1GKZpQ/exec"; 

let curId, curName, curM;
let currentScheduleData = null;
let todayDay = new Date().getDay(); 
let timerInterval = null; 

document.addEventListener("DOMContentLoaded", () => {
  const days = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
  document.getElementById('todayDate').innerText = `${new Date().toLocaleDateString()} (${days[todayDay]})`;
  document.getElementById('planDayBadge').innerText = `${days[todayDay]}ìš”ì¼ ìŠ¤ì¼€ì¤„`;
});

function showView(id) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}
function goHome() { location.reload(); }

function checkUser(id, name) {
  curId = id; curName = name;
  const card = event.currentTarget;
  card.style.opacity = "0.5";
  
  fetch(WEB_APP_URL, {
    method: "POST",
    body: JSON.stringify({ action: "checkSchedule", id: id, date: new Date().toISOString().slice(0,10) })
  })
  .then(res => res.json())
  .then(res => {
    if(res.hasSchedule) {
      currentScheduleData = res.data;
      renderMissions(res.data);
      showView('view-mission');
      document.getElementById('missionTitle').innerText = `${name}ë‹˜ì˜ ë¯¸ì…˜`;
      restoreMissionState(); 
    } else {
      currentScheduleData = null;
      showView('view-plan');
      document.getElementById('planTitle').innerText = `${name}ë‹˜`;
      togglePlanView();
    }
    card.style.opacity = "1";
  });
}

function togglePlanView() {
  if (todayDay === 4) {
    document.getElementById('plan-normal').classList.add('hidden');
    document.getElementById('plan-thursday').classList.remove('hidden');
  } else {
    document.getElementById('plan-normal').classList.remove('hidden');
    document.getElementById('plan-thursday').classList.add('hidden');
  }
}

function editPlan() {
  if (!currentScheduleData) return;
  showView('view-plan');
  document.getElementById('planTitle').innerText = `${curName}ë‹˜ ìŠ¤ì¼€ì¤„ ìˆ˜ì •`;
  togglePlanView();
  // ë°ì´í„° ì±„ìš°ê¸° (ìƒëµ - ê¸°ì¡´ê³¼ ë™ì¼)
  const d = currentScheduleData;
  if (todayDay === 4) {
    document.getElementById('th_c2').value = d.c2.n;
    document.getElementById('th_m1_lv').value = d.m1.l;
    document.getElementById('th_m2_lv').value = d.m2.l;
    document.getElementById('th_m3_lv').value = d.m3.l;
    document.getElementById('th_c1_a').value = d.c1a.n;
    document.getElementById('th_c1_a_lv').value = d.c1a.l;
    document.getElementById('th_c1_b').value = d.c1b.n;
    document.getElementById('th_c1_b_lv').value = d.c1b.l;
  } else {
    document.getElementById('m1_lv').value = d.m1.l;
    document.getElementById('m2_lv').value = d.m2.l;
    document.getElementById('m3_lv').value = d.m3.l;
    document.getElementById('c1_a').value = d.c1a.n;
    document.getElementById('c1_a_lv').value = d.c1a.l;
    document.getElementById('c1_b').value = d.c1b.n;
    document.getElementById('c1_b_lv').value = d.c1b.l;
    document.getElementById('c2').value = d.c2.n;
  }
}

function savePlan() {
  let data = { action: "saveSchedule", id: curId, date: new Date().toISOString().slice(0,10), dayStr: (todayDay===4?"ëª©":"í‰ì¼") };
  if (todayDay === 4) {
    data.c2n = document.getElementById('th_c2').value;
    data.m1l = document.getElementById('th_m1_lv').value;
    data.m2l = document.getElementById('th_m2_lv').value;
    data.m3l = document.getElementById('th_m3_lv').value;
    data.c1an = document.getElementById('th_c1_a').value;
    data.c1al = document.getElementById('th_c1_a_lv').value;
    data.c1bn = document.getElementById('th_c1_b').value;
    data.c1bl = document.getElementById('th_c1_b_lv').value;
  } else {
    data.m1l = document.getElementById('m1_lv').value;
    data.m2l = document.getElementById('m2_lv').value;
    data.m3l = document.getElementById('m3_lv').value;
    data.c1an = document.getElementById('c1_a').value;
    data.c1al = document.getElementById('c1_a_lv').value;
    data.c1bn = document.getElementById('c1_b').value;
    data.c1bl = document.getElementById('c1_b_lv').value;
    data.c2n = document.getElementById('c2').value;
  }
  fetch(WEB_APP_URL, { method: "POST", body: JSON.stringify(data) })
  .then(res => res.json())
  .then(() => { alert("ìŠ¤ì¼€ì¤„ ì €ì¥ ì™„ë£Œ!"); goHome(); });
}

/* ======== ì‹¬í”Œ ë¯¸ì…˜ ì œì–´ ë¡œì§ (íŒì—… ì œê±°ë¨) ======== */

function renderMissions(d) {
  const list = document.getElementById('missionList');
  list.innerHTML = "";
  
  // ìš”ì¼ë³„ ìˆœì„œ
  if (d.day === "ëª©") {
    list.innerHTML += `<div style="font-size:12px; color:#888; margin:10px 0;">ğŸ• 13:00 ~ 15:00</div>`;
    renderItem(list, d.c2);
    list.innerHTML += `<div style="font-size:12px; color:#888; margin:20px 0 10px;">ğŸ•’ 15:00 ~ 17:00</div>`;
    [d.m1, d.m2, d.m3, d.c1a, d.c1b].forEach(t => renderItem(list, t));
  } else {
    list.innerHTML += `<div style="font-size:12px; color:#888; margin:10px 0;">ğŸ•¤ 09:30 ~ 11:00</div>`;
    [d.m1, d.m2, d.m3].forEach(t => renderItem(list, t));
    list.innerHTML += `<div style="font-size:12px; color:#888; margin:20px 0 10px;">ğŸ•š 11:00 ~ 12:00</div>`;
    [d.c1a, d.c1b].forEach(t => renderItem(list, t));
    list.innerHTML += `<div style="font-size:12px; color:#888; margin:20px 0 10px;">ğŸ• 13:00 ~ 15:00</div>`;
    renderItem(list, d.c2);
  }
}

function renderItem(container, t) {
  if(!t || !t.n) return;
  const isDone = localStorage.getItem(`${curId}_${t.n}_done`) === "yes";
  
  const div = document.createElement('div');
  div.className = "mission-item";
  div.innerHTML = `
    <div class="mission-header">
      <span class="mission-name">${t.n}</span>
      <span class="mission-lv">${t.l || "-"}</span>
    </div>
    <div class="live-timer" id="timer-${t.n}">00:00:00</div>
    <button class="btn-action ${isDone ? 'done' : ''}" 
            id="btn-${t.n}" 
            onclick="handleMissionClick('${t.n}', '${t.l||""}')"
            ${isDone ? 'disabled' : ''}>
      ${isDone ? 'âœ… ì™„ë£Œ (ì ê¹€)' : 'ì‹œì‘í•˜ê¸°'}
    </button>
  `;
  container.appendChild(div);
}

function restoreMissionState() {
  const activeMission = localStorage.getItem(`${curId}_active_mission`);
  if (activeMission) {
    curM = activeMission;
    const btn = document.getElementById(`btn-${activeMission}`);
    if (btn) {
      btn.classList.add('ing');
      btn.innerText = "ğŸ”¥ ì§„í–‰ ì¤‘ (ì™„ë£Œí•˜ê¸°)";
      document.getElementById(`timer-${activeMission}`).style.display = 'block';
      startTimerUI(activeMission);
      disableOtherButtons(activeMission);
    }
  }
}

function handleMissionClick(name, scheduledLevel) {
  const btn = document.getElementById(`btn-${name}`);
  if(btn.disabled || btn.classList.contains('done')) return; // ì¤‘ë³µ ë°©ì§€
  
  const activeMission = localStorage.getItem(`${curId}_active_mission`);

  // [ìƒí™© A] ì‹œì‘í•˜ê¸°
  if (!activeMission) {
    localStorage.setItem(`${curId}_active_mission`, name);
    localStorage.setItem(`${curId}_start_time`, Date.now());
    
    btn.classList.add('ing');
    btn.innerText = "ğŸ”¥ ì§„í–‰ ì¤‘ (ì™„ë£Œí•˜ê¸°)";
    document.getElementById(`timer-${name}`).style.display = 'block';
    
    fetch(WEB_APP_URL, { method:"POST", body:JSON.stringify({
      action:"saveLog", subAction:"start", student_id:curId, mission_id:name
    })});

    startTimerUI(name);
    disableOtherButtons(name);
  } 
  // [ìƒí™© B] ì™„ë£Œí•˜ê¸° (íŒì—… ì—†ì´ ì¦‰ì‹œ ì¢…ë£Œ)
  else if (activeMission === name) {
    finishImmediate(name, scheduledLevel);
  } else {
    alert("í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ë¯¸ì…˜ì„ ë¨¼ì € ì™„ë£Œí•´ì£¼ì„¸ìš”!");
  }
}

// íŒì—… ì—†ì´ ì¦‰ì‹œ ì™„ë£Œ ì²˜ë¦¬ í•¨ìˆ˜
function finishImmediate(name, level) {
  if(!confirm("ì •ë§ ì™„ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

  const startTime = parseInt(localStorage.getItem(`${curId}_start_time`));
  const diff = Math.floor((Date.now() - startTime) / 1000);
  const m = Math.floor(diff/60) + "ë¶„ " + (diff%60) + "ì´ˆ";
  
  // ë¡œì»¬ ì •ë¦¬
  localStorage.removeItem(`${curId}_active_mission`);
  localStorage.removeItem(`${curId}_start_time`);
  localStorage.setItem(`${curId}_${name}_done`, "yes");
  
  if (timerInterval) clearInterval(timerInterval);
  document.getElementById(`timer-${name}`).style.display = 'none';
  
  // ì„œë²„ ì „ì†¡ (ë‚œì´ë„ëŠ” ìŠ¤ì¼€ì¤„ë§ ë•Œ ì •í•œ levelì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©)
  fetch(WEB_APP_URL, { method:"POST", body:JSON.stringify({
    action:"saveLog", subAction:"end", student_id:curId, mission_id:name, 
    difficulty: level, // ìë™ í• ë‹¹
    note: m
  })})
  .then(res => res.json())
  .then(() => {
    alert("ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤! ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
    
    // ë²„íŠ¼ ì ê·¸ê¸° (ì¦‰ì‹œ UI ë°˜ì˜)
    const btn = document.getElementById(`btn-${name}`);
    btn.classList.remove('ing');
    btn.classList.add('done');
    btn.innerText = "âœ… ì™„ë£Œ (ì ê¹€)";
    btn.disabled = true;
    
    enableAllButtons(); // ë‹¤ë¥¸ ë²„íŠ¼ ì ê¸ˆ í•´ì œ
  });
}

function startTimerUI(name) {
  const startTime = parseInt(localStorage.getItem(`${curId}_start_time`));
  const display = document.getElementById(`timer-${name}`);
  if (timerInterval) clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    const diff = Math.floor((Date.now() - startTime) / 1000);
    const h = String(Math.floor(diff / 3600)).padStart(2,'0');
    const m = String(Math.floor((diff % 3600) / 60)).padStart(2,'0');
    const s = String(diff % 60).padStart(2,'0');
    display.innerText = `${h}:${m}:${s}`;
  }, 1000);
}

function disableOtherButtons(activeName) {
  const btns = document.querySelectorAll('.btn-action');
  btns.forEach(b => {
    if (b.id !== `btn-${activeName}` && !b.classList.contains('done')) {
      b.disabled = true;
      b.innerText = "â›” ëŒ€ê¸°ì¤‘";
    }
  });
}

function enableAllButtons() {
  const btns = document.querySelectorAll('.btn-action');
  btns.forEach(b => {
    if (!b.classList.contains('done')) {
      b.disabled = false;
      b.innerText = "ì‹œì‘í•˜ê¸°";
    }
  });
}
</script>
</body>
</html>